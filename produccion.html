<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Producci√≥n - Finca La Herradura</title>
    
    <!-- Meta tags -->
    <meta name="description" content="Control de producci√≥n y cosechas con an√°lisis inteligente y predicciones de rendimiento">
    <meta name="keywords" content="producci√≥n, cosecha, limones, rendimiento, an√°lisis, predicci√≥n">
    
    <!-- Favicon y PWA -->
    <link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
    <link rel="manifest" href="/manifest.json">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/style.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Estilos mantenidos del archivo original -->
    <style>
        .main-content-wrapper {
            margin-left: 280px;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
            padding: 2rem;
        }

        @media (max-width: 768px) {
            .main-content-wrapper {
                margin-left: 0;
                padding: 1rem;
                padding-top: 5rem;
            }
        }

        .produccion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .title-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-success {
            background: #16a34a;
            color: white;
        }

        .btn-success:hover {
            background: #15803d;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .kpis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .kpi-card:hover {
            transform: translateY(-2px);
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #16a34a, #3b82f6);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .kpi-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: white;
        }

        .kpi-icon.produccion {
            background: linear-gradient(135deg, #16a34a, #15803d);
        }

        .kpi-icon.rendimiento {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .kpi-icon.calidad {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .kpi-icon.ingresos {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .kpi-tendencia {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .kpi-tendencia.positiva {
            color: #22c55e;
        }

        .kpi-valor {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .kpi-label {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .kpi-meta {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .filtros-produccion {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .filtros-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
        }

        .form-input {
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .quick-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .quick-action {
            background: white;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .quick-action:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }

        .quick-action-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .registro-rapido {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .registro-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .produccion-timeline {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .timeline-container {
            position: relative;
            padding-left: 2rem;
            max-height: 500px;
            overflow-y: auto;
        }

        .timeline-container::before {
            content: '';
            position: absolute;
            left: 1rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, #3b82f6, #16a34a);
        }

        .timeline-item {
            position: relative;
            margin-bottom: 2rem;
            padding-left: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 1px solid #f3f4f6;
        }

        .timeline-item:last-child {
            border-bottom: none;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -0.5rem;
            top: 0.5rem;
            width: 1rem;
            height: 1rem;
            background: #3b82f6;
            border-radius: 50%;
            border: 3px solid white;
        }

        .timeline-fecha {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .timeline-contenido {
            color: #1f2937;
        }

        .timeline-cantidad {
            font-weight: 700;
            color: #16a34a;
            font-size: 1.125rem;
            margin-top: 0.5rem;
        }

        .timeline-detalles {
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: #6b7280;
        }

        .graficos-container {
            display: grid;
            gap: 2rem;
        }

        .grafico-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .grafico-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .grafico-titulo {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .periodo-selector {
            display: flex;
            gap: 0.5rem;
        }

        .periodo-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }

        .periodo-btn.active,
        .periodo-btn:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .predicciones-ia {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(167, 139, 250, 0.1));
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 16px;
            padding: 1.5rem;
        }

        .ia-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .ia-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }

        .prediccion-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(139, 92, 246, 0.1);
        }

        .prediccion-titulo {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .prediccion-valor {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .prediccion-confianza {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .tabla-produccion {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .tabla-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .table-container {
            overflow-x: auto;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #f3f4f6;
        }

        .table th {
            background: #f9fafb;
            font-weight: 600;
            color: #374151;
        }

        .table tbody tr:hover {
            background: #f9fafb;
        }

        .cosecha-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .cosecha-badge.aa,
        .cosecha-badge.aaa {
            background: rgba(34, 197, 94, 0.2);
            color: #16a34a;
        }

        .cosecha-badge.a {
            background: rgba(245, 158, 11, 0.2);
            color: #d97706;
        }

        .cosecha-badge.b {
            background: rgba(139, 92, 246, 0.2);
            color: #8b5cf6;
        }

        .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            padding: 2rem 2rem 0;
            border-bottom: 1px solid #f3f4f6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }

        .modal-body {
            padding: 2rem;
        }

        .form-sections {
            display: grid;
            gap: 2rem;
        }

        .form-section {
            border: 1px solid #f3f4f6;
            border-radius: 12px;
            padding: 1.5rem;
        }

        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .gps-capture {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            text-align: center;
        }

        .gps-status {
            font-size: 0.875rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .gps-coords {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #16a34a;
        }

        .foto-preview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .foto-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 1;
            background: #f3f4f6;
        }

        .foto-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .foto-remove {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .loading-spinner i {
            font-size: 2rem;
            color: #3b82f6;
        }

        /* Indicador de integraci√≥n */
        .integration-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.75rem;
            border: 1px solid #e5e7eb;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .integration-status.connected {
            border-color: #16a34a;
            color: #16a34a;
        }

        .integration-status.loading {
            border-color: #f59e0b;
            color: #f59e0b;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .produccion-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .kpis-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .quick-actions {
                justify-content: center;
            }
            
            .filtros-grid {
                grid-template-columns: 1fr;
            }
            
            .registro-form {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Indicador de estado de integraci√≥n -->
    <div class="integration-status loading" id="integrationStatus">
        <i class="fas fa-sync fa-spin"></i> Cargando datos...
    </div>

    <!-- Navegaci√É¬≥n -->
    <nav id="navbar"></nav>

    <!-- Contenido principal -->
    <main class="main-content-wrapper">
        <!-- Header de la p√É¬°gina -->
        <header class="produccion-header">
            <div class="page-title">
                <div class="title-icon">
                    <i class="fas fa-apple-alt"></i>
                </div>
                <div>
                    <h1>Gesti√≥n de Producci√≥n</h1>
                    <p>Control de cosechas y an√°lisis de rendimiento</p>
                </div>
            </div>
            
            <div class="header-actions">
                <button class="btn btn-success" id="btnRegistroRapido">
                    <i class="fas fa-plus"></i> Registro R√°pido
                </button>
                
                <button class="btn btn-primary" id="btnNuevoRegistro">
                    <i class="fas fa-clipboard-list"></i> Registro Completo
                </button>
                
                <button class="btn btn-secondary" id="btnExportarDatos">
                    <i class="fas fa-download"></i> Exportar
                </button>
            </div>
        </header>

        <!-- KPIs principales -->
        <section class="kpis-grid">
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon produccion">
                        <i class="fas fa-seedling"></i>
                    </div>
                    <div class="kpi-tendencia positiva">
                        <i class="fas fa-arrow-up"></i>
                        <span>+12%</span>
                    </div>
                </div>
                <div class="kpi-valor" id="produccionMes">0 kg</div>
                <div class="kpi-label">Producci√≥n del Mes</div>
                <div class="kpi-meta">Meta: <span id="metaProduccion">5,000 kg</span></div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon rendimiento">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="kpi-tendencia positiva">
                        <i class="fas fa-arrow-up"></i>
                        <span>+8%</span>
                    </div>
                </div>
                <div class="kpi-valor" id="rendimientoPromedio">0 kg/√°rbol</div>
                <div class="kpi-label">Rendimiento Promedio</div>
                <div class="kpi-meta">Objetivo: <span id="objetivoRendimiento">25 kg/√°rbol</span></div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon calidad">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="kpi-tendencia positiva">
                        <i class="fas fa-arrow-up"></i>
                        <span>+5%</span>
                    </div>
                </div>
                <div class="kpi-valor" id="calidadPromedio">0%</div>
                <div class="kpi-label">Calidad Promedio</div>
                <div class="kpi-meta">Est√°ndar: <span id="estandarCalidad">85%</span></div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon ingresos">
                        <i class="fas fa-coins"></i>
                    </div>
                    <div class="kpi-tendencia positiva">
                        <i class="fas fa-arrow-up"></i>
                        <span>+15%</span>
                    </div>
                </div>
                <div class="kpi-valor" id="ingresosMes">Q 0</div>
                <div class="kpi-label">Ingresos del Mes</div>
                <div class="kpi-meta">Proyectado: <span id="proyeccionIngresos">Q 45,000</span></div>
            </div>
        </section>

        <!-- Filtros -->
        <section class="filtros-produccion">
            <h3 style="margin-bottom: 1rem;">
                <i class="fas fa-filter"></i> Filtros de Producci√≥n
            </h3>
            
            <div class="filtros-grid">
                <div class="form-group">
                    <label class="form-label">Per√≠odo</label>
                    <select class="form-input" id="filtroPeriodo">
                        <option value="hoy">Hoy</option>
                        <option value="semana">Esta Semana</option>
                        <option value="mes" selected>Este Mes</option>
                        <option value="trimestre">Este Trimestre</option>
                        <option value="ano">Este A√±o</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Sector</label>
                    <select class="form-input" id="filtroBloque">
                        <option value="">Todos los sectores</option>
                        <!-- Se llenar√°n din√°micamente -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tipo de Cosecha</label>
                    <select class="form-input" id="filtroTipoCosecha">
                        <option value="">Todos los tipos</option>
                        <option value="principal">Principal</option>
                        <option value="secundaria">Secundaria</option>
                        <option value="extra">Extra</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Responsable</label>
                    <select class="form-input" id="filtroResponsable">
                        <option value="">Todos los responsables</option>
                        <option value="juan_perez">Juan P√©rez</option>
                        <option value="maria_gonzalez">Mar√≠a Gonz√°lez</option>
                        <option value="carlos_lopez">Carlos L√≥pez</option>
                    </select>
                </div>
                
                <div class="form-group" style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-primary" id="aplicarFiltros">
                        <i class="fas fa-search"></i> Aplicar
                    </button>
                    <button class="btn btn-secondary" id="limpiarFiltros">
                        <i class="fas fa-times"></i> Limpiar
                    </button>
                </div>
            </div>
        </section>

        <!-- Acciones r√É¬°pidas -->
        <section class="quick-actions">
            <div class="quick-action" onclick="accionRapida('nuevo-corte')">
                <div class="quick-action-icon" style="background: #16a34a;">
                    <i class="fas fa-cut"></i>
                </div>
                <div>
                    <div style="font-weight: 600;">Nuevo Corte</div>
                    <div style="font-size: 0.75rem; color: #6b7280;">Registrar cosecha</div>
                </div>
            </div>
            
            <div class="quick-action" onclick="accionRapida('control-calidad')">
                <div class="quick-action-icon" style="background: #3b82f6;">
                    <i class="fas fa-microscope"></i>
                </div>
                <div>
                    <div style="font-weight: 600;">Control de Calidad</div>
                    <div style="font-size: 0.75rem; color: #6b7280;">Evaluar producto</div>
                </div>
            </div>
            
            <div class="quick-action" onclick="accionRapida('reporte-diario')">
                <div class="quick-action-icon" style="background: #f59e0b;">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div>
                    <div style="font-weight: 600;">Reporte Diario</div>
                    <div style="font-size: 0.75rem; color: #6b7280;">Resumen del d√≠a</div>
                </div>
            </div>
            
            <div class="quick-action" onclick="accionRapida('planificar-cosecha')">
                <div class="quick-action-icon" style="background: #8b5cf6;">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div>
                    <div style="font-weight: 600;">Planificar Cosecha</div>
                    <div style="font-size: 0.75rem; color: #6b7280;">Programar actividades</div>
                </div>
            </div>
        </section>

        <!-- Registro r√É¬°pido -->
        <section class="registro-rapido">
            <h3 style="margin-bottom: 1.5rem;">
                <i class="fas fa-bolt"></i> Registro R√°pido de Producci√≥n
            </h3>
            
            <form class="registro-form" id="formRegistroRapido">
                <div class="form-group">
                    <label class="form-label">Fecha</label>
                    <input type="date" class="form-input" id="fechaRapida" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">√Årbol/Sector</label>
                    <select class="form-input" id="arbolRapido" required>
                        <option value="">Seleccionar...</option>
                        <!-- Se llenar√°n din√°micamente con √°rboles y sectores reales -->
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Cantidad (kg)</label>
                    <input type="number" class="form-input" id="cantidadRapida" step="0.1" min="0" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tipo</label>
                    <select class="form-input" id="tipoRapido" required>
                        <option value="">Seleccionar...</option>
                        <option value="principal">Principal</option>
                        <option value="secundaria">Secundaria</option>
                        <option value="extra">Extra</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Guardar R√°pido
                    </button>
                </div>
            </form>
        </section>

        <!-- Contenido principal -->
        <div class="main-content">
            <!-- Gr√É¬°ficos -->
            <div class="graficos-container">
                <!-- Gr√É¬°fico de producci√É¬≥n -->
                <div class="grafico-card">
                    <div class="grafico-header">
                        <h3 class="grafico-titulo">
                            <i class="fas fa-chart-area"></i>
                            Evoluci√≥n de la Producci√≥n
                        </h3>
                        <div class="periodo-selector">
                            <button class="periodo-btn active" data-periodo="semana">Semana</button>
                            <button class="periodo-btn" data-periodo="mes">Mes</button>
                            <button class="periodo-btn" data-periodo="ano">A√±o</button>
                        </div>
                    </div>
                    <canvas id="graficoProduccion" height="300"></canvas>
                </div>
                
                <!-- Gr√É¬°fico de rendimiento por bloque -->
                <div class="grafico-card">
                    <div class="grafico-header">
                        <h3 class="grafico-titulo">
                            <i class="fas fa-chart-bar"></i>
                            Rendimiento por Sector
                        </h3>
                    </div>
                    <canvas id="graficoRendimiento" height="250"></canvas>
                </div>
            </div>

            <!-- Timeline y predicciones -->
            <div>
                <!-- Timeline de producci√É¬≥n -->
                <div class="produccion-timeline">
                    <h3 style="margin-bottom: 1.5rem;">
                        <i class="fas fa-history"></i>
                        Actividades Recientes
                    </h3>
                    
                    <div class="timeline-container" id="timelineProduccion">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </div>
                </div>

                <!-- Predicciones IA -->
                <div class="predicciones-ia" style="margin-top: 2rem;">
                    <div class="ia-header">
                        <div class="ia-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <h3>Predicciones Inteligentes</h3>
                    </div>
                    
                    <div id="prediccionesIA">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de producci√É¬≥n -->
        <section class="tabla-produccion">
            <div class="tabla-header">
                <h3>
                    <i class="fas fa-table"></i>
                    Registros de Producci√≥n
                </h3>
                <div>
                    <button class="btn btn-sm btn-secondary" id="btnVistaDetallada">
                        <i class="fas fa-expand"></i> Vista Detallada
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <table class="table" id="tablaProduccion">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>√Årbol/Sector</th>
                            <th>Cantidad</th>
                            <th>Tipo</th>
                            <th>Calidad</th>
                            <th>Responsable</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaProduccionBody">
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 2rem; color: #6b7280;">
                                <i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i>
                                Cargando registros...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- Modal para registro completo -->
    <div class="modal-overlay" id="modalRegistroCompleto">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Registro Completo de Producci√≥n</h2>
                <button class="modal-close" id="cerrarModalRegistro">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="formRegistroCompleto" class="form-sections">
                    <!-- Informaci√É¬≥n b√É¬°sica -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-info-circle"></i>
                            Informaci√≥n B√°sica
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Fecha de Cosecha</label>
                                <input type="datetime-local" class="form-input" id="fechaCompleta" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">√Årbol/Sector</label>
                                <select class="form-input" id="arbolCompleto" required>
                                    <option value="">Seleccionar...</option>
                                    <!-- Se llenar√°n din√°micamente -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Tipo de Cosecha</label>
                                <select class="form-input" id="tipoCompleto" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="principal">Principal</option>
                                    <option value="secundaria">Secundaria</option>
                                    <option value="extra">Extra</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Responsable</label>
                                <select class="form-input" id="responsableCompleto" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="juan_perez">Juan P√©rez</option>
                                    <option value="maria_gonzalez">Mar√≠a Gonz√°lez</option>
                                    <option value="carlos_lopez">Carlos L√≥pez</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Datos de producci√É¬≥n -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-weight-hanging"></i>
                            Datos de Producci√≥n
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Cantidad Total (kg)</label>
                                <input type="number" class="form-input" id="cantidadTotal" step="0.1" min="0" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Calibre Grande (%)</label>
                                <input type="number" class="form-input" id="calibreGrande" step="0.1" min="0" max="100">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Calibre Mediano (%)</label>
                                <input type="number" class="form-input" id="calibreMediano" step="0.1" min="0" max="100">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Calibre Peque√±o (%)</label>
                                <input type="number" class="form-input" id="calibrePequeno" step="0.1" min="0" max="100">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Calidad (%)</label>
                                <input type="number" class="form-input" id="calidadCompleta" step="0.1" min="0" max="100">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Merma (%)</label>
                                <input type="number" class="form-input" id="merma" step="0.1" min="0" max="100">
                            </div>
                        </div>
                    </div>

                    <!-- Ubicaci√É¬≥n GPS -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-map-marker-alt"></i>
                            Ubicaci√≥n GPS
                        </h4>
                        
                        <div class="gps-capture">
                            <div class="gps-status" id="gpsStatus">Presiona para capturar ubicaci√≥n</div>
                            <div class="gps-coords" id="gpsCoords">--¬∞, --¬∞</div>
                            <button type="button" class="btn btn-sm btn-primary" id="btnCapturarGPS">
                                <i class="fas fa-location-arrow"></i> Capturar GPS
                            </button>
                        </div>
                    </div>

                    <!-- Fotos -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-camera"></i>
                            Fotograf√≠as
                        </h4>
                        
                        <div class="form-group">
                            <input type="file" class="form-input" id="fotosCompletas" multiple accept="image/*" style="display: none;">
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('fotosCompletas').click()">
                                <i class="fas fa-upload"></i> Subir Fotos
                            </button>
                        </div>
                        
                        <div class="foto-preview" id="fotoPreview">
                            <!-- Las fotos se mostrar√°n aqu√≠ -->
                        </div>
                    </div>

                    <!-- Observaciones -->
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-sticky-note"></i>
                            Observaciones
                        </h4>
                        
                        <div class="form-group">
                            <textarea class="form-input form-textarea" id="observacionesCompletas" 
                                      placeholder="Observaciones sobre la cosecha, condiciones, etc."></textarea>
                        </div>
                    </div>

                    <!-- Botones de acci√É¬≥n -->
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                        <button type="button" class="btn btn-secondary" id="cancelarRegistro">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Guardar Registro
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts corregidos para integraci√≥n -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    
    <script type="module" src="/js/firebase-config.js"></script>
    <script type="module" src="/js/offline.js"></script>
    <script type="module" src="/js/auth.js"></script>
    <script type="module" src="/js/nav.js"></script>
    <script type="module" src="/js/clima.js"></script>
    <script type="module" src="/js/produccion.js"></script>
    
    <script>
        // Variables globales
        let graficoProduccion, graficoRendimiento;
        let coordenadasGPS = null;
        let fotosSeleccionadas = [];
        let sectoresDisponibles = [];
        let arbolesDisponibles = [];

        // SISTEMA CORREGIDO DE INICIALIZACI√ìN
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Iniciando aplicaci√≥n de producci√≥n...');
            
            try {
                // Mostrar estado de carga
                updateIntegrationStatus('loading', 'Cargando datos...');
                
                // Esperar Firebase con timeout corto
                const firebaseReady = await waitForFirebase(3000);
                
                // Verificar autenticaci√≥n de forma simple
                const authenticated = await simpleAuthCheck();
                if (!authenticated) {
                    console.log('‚ùå Usuario no autenticado, redirigiendo...');
                    window.location.href = '/login.html';
                    return;
                }

                // Inicializar componentes
                await initializeComponents();
                
                updateIntegrationStatus('connected', 'Datos cargados correctamente');
                
                console.log('‚úÖ Aplicaci√≥n de producci√≥n inicializada');
                
            } catch (error) {
                console.error('‚ùå Error en inicializaci√≥n:', error);
                await initializeBasicMode();
                updateIntegrationStatus('connected', 'Modo b√°sico activo');
            }
        });

        // FUNCI√ìN CORREGIDA PARA ESPERAR FIREBASE
        function waitForFirebase(timeout = 3000) {
            return new Promise((resolve) => {
                const timeoutId = setTimeout(() => {
                    console.warn('‚è∞ Timeout esperando Firebase');
                    resolve(false);
                }, timeout);
                
                if (window.firebase) {
                    clearTimeout(timeoutId);
                    resolve(true);
                    return;
                }
                
                const checkFirebase = () => {
                    if (window.firebase) {
                        clearTimeout(timeoutId);
                        resolve(true);
                    }
                };
                
                // Escuchar eventos de Firebase
                window.addEventListener('firebaseReady', () => {
                    clearTimeout(timeoutId);
                    resolve(true);
                }, { once: true });
                
                window.addEventListener('firebaseError', () => {
                    clearTimeout(timeoutId);
                    resolve(false);
                }, { once: true });
                
                // Verificar peri√≥dicamente
                const interval = setInterval(checkFirebase, 100);
                setTimeout(() => clearInterval(interval), timeout - 100);
            });
        }

        // VERIFICACI√ìN SIMPLE DE AUTENTICACI√ìN
        async function simpleAuthCheck() {
            // M√©todo 1: AuthManager
            if (window.authManager && window.authManager.isAuthenticated) {
                return true;
            }
            
            // M√©todo 2: Firebase Auth
            if (window.firebase && window.firebase.auth && window.firebase.auth().currentUser) {
                return true;
            }
            
            // M√©todo 3: Esperar un poco m√°s
            return new Promise((resolve) => {
                let attempts = 0;
                const checkAuth = () => {
                    if (window.authManager && window.authManager.isAuthenticated) {
                        resolve(true);
                        return;
                    }
                    
                    if (window.firebase && window.firebase.auth && window.firebase.auth().currentUser) {
                        resolve(true);
                        return;
                    }
                    
                    attempts++;
                    if (attempts < 20) {
                        setTimeout(checkAuth, 100);
                    } else {
                        resolve(true); // Permitir acceso en modo demo
                    }
                };
                checkAuth();
            });
        }

        // INICIALIZACI√ìN DE COMPONENTES CON INTEGRACI√ìN
        async function initializeComponents() {
            // Configurar event listeners
            setupEventListeners();
            
            // Esperar ProductionManager
            await waitForProductionManager();
            
            // Cargar sectores y √°rboles
            await loadSectorsAndTrees();
            
            // Cargar datos iniciales
            await loadInitialData();
            
            // Inicializar gr√°ficos
            initializeCharts();
            
            // Configurar fecha actual
            setCurrentDates();
        }

        function waitForProductionManager() {
            return new Promise((resolve) => {
                let attempts = 0;
                const checkManager = () => {
                    if (window.productionManager) {
                        resolve();
                    } else if (attempts < 50) {
                        attempts++;
                        setTimeout(checkManager, 100);
                    } else {
                        resolve(); // Continuar sin manager
                    }
                };
                checkManager();
            });
        }

        // CARGAR SECTORES Y √ÅRBOLES DESDE EL SISTEMA INTEGRADO
        async function loadSectorsAndTrees() {
            try {
                // Obtener sectores y √°rboles del sistema integrado
                if (window.productionManager) {
                    sectoresDisponibles = window.productionManager.getSectoresParaFormulario();
                    arbolesDisponibles = window.productionManager.getArbolesParaFormulario();
                } else {
                    // Fallback: cargar desde localStorage como lo hace arboles.js
                    const savedSectors = localStorage.getItem('finca_sectores');
                    if (savedSectors) {
                        const sectorsData = JSON.parse(savedSectors);
                        sectoresDisponibles = sectorsData.map(sector => ({
                            value: sector.id,
                            label: sector.name,
                            data: sector
                        }));
                    }
                }
                
                // Actualizar desplegables
                updateSelectOptions();
                
                console.log(`üì¶ Sectores cargados: ${sectoresDisponibles.length}`);
                console.log(`üå≥ √Årboles/opciones cargadas: ${arbolesDisponibles.length}`);
                
            } catch (error) {
                console.error('‚ùå Error cargando sectores y √°rboles:', error);
                loadFallbackOptions();
            }
        }

        // ACTUALIZAR OPCIONES EN LOS FORMULARIOS
        function updateSelectOptions() {
            // Actualizar filtro de sectores
            const filtroBloque = document.getElementById('filtroBloque');
            if (filtroBloque) {
                filtroBloque.innerHTML = '<option value="">Todos los sectores</option>';
                sectoresDisponibles.forEach(sector => {
                    const option = document.createElement('option');
                    option.value = sector.value;
                    option.textContent = sector.label;
                    filtroBloque.appendChild(option);
                });
            }
            
            // Actualizar formulario r√°pido
            const arbolRapido = document.getElementById('arbolRapido');
            if (arbolRapido) {
                arbolRapido.innerHTML = '<option value="">Seleccionar...</option>';
                arbolesDisponibles.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.value;
                    option.textContent = item.label;
                    arbolRapido.appendChild(option);
                });
            }
            
            // Actualizar formulario completo
            const arbolCompleto = document.getElementById('arbolCompleto');
            if (arbolCompleto) {
                arbolCompleto.innerHTML = '<option value="">Seleccionar...</option>';
                arbolesDisponibles.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.value;
                    option.textContent = item.label;
                    arbolCompleto.appendChild(option);
                });
            }
        }

        function loadFallbackOptions() {
            sectoresDisponibles = [
                { value: 'sector_a', label: 'Sector A' },
                { value: 'sector_b', label: 'Sector B' },
                { value: 'sector_c', label: 'Sector C' }
            ];
            
            arbolesDisponibles = [
                { value: 'arbol_001', label: '√Årbol 001' },
                { value: 'arbol_002', label: '√Årbol 002' },
                { value: 'arbol_003', label: '√Årbol 003' }
            ];
            
            updateSelectOptions();
        }

        // INICIALIZACI√ìN B√ÅSICA SIN FIREBASE
        async function initializeBasicMode() {
            console.log('üîß Modo b√°sico activado');
            
            setupEventListeners();
            loadFallbackOptions();
            loadSampleData();
            initializeCharts();
            setCurrentDates();
        }

        // Resto de funciones mantenidas del c√≥digo original...
        function setupEventListeners() {
            // Botones principales
            const btnRegistroRapido = document.getElementById('btnRegistroRapido');
            const btnNuevoRegistro = document.getElementById('btnNuevoRegistro');
            const btnExportarDatos = document.getElementById('btnExportarDatos');
            
            if (btnRegistroRapido) btnRegistroRapido.addEventListener('click', mostrarRegistroRapido);
            if (btnNuevoRegistro) btnNuevoRegistro.addEventListener('click', mostrarRegistroCompleto);
            if (btnExportarDatos) btnExportarDatos.addEventListener('click', exportarDatos);
            
            // Formularios
            const formRapido = document.getElementById('formRegistroRapido');
            const formCompleto = document.getElementById('formRegistroCompleto');
            
            if (formRapido) formRapido.addEventListener('submit', guardarRegistroRapido);
            if (formCompleto) formCompleto.addEventListener('submit', guardarRegistroCompleto);
            
            // Modales
            const cerrarModal = document.getElementById('cerrarModalRegistro');
            const cancelarRegistro = document.getElementById('cancelarRegistro');
            
            if (cerrarModal) cerrarModal.addEventListener('click', cerrarModalFunction);
            if (cancelarRegistro) cancelarRegistro.addEventListener('click', cerrarModalFunction);
            
            // Filtros
            const aplicarFiltros = document.getElementById('aplicarFiltros');
            const limpiarFiltros = document.getElementById('limpiarFiltros');
            
            if (aplicarFiltros) aplicarFiltros.addEventListener('click', aplicarFiltrosFunction);
            if (limpiarFiltros) limpiarFiltros.addEventListener('click', limpiarFiltrosFunction);
            
            // GPS y fotos
            const btnCapturarGPS = document.getElementById('btnCapturarGPS');
            const fotosCompletas = document.getElementById('fotosCompletas');
            
            if (btnCapturarGPS) btnCapturarGPS.addEventListener('click', capturarUbicacionGPS);
            if (fotosCompletas) fotosCompletas.addEventListener('change', manejarFotos);
            
            // Selectores de per√≠odo
            document.querySelectorAll('.periodo-btn').forEach(btn => {
                btn.addEventListener('click', (e) => cambiarPeriodoGrafico(e.target.dataset.periodo));
            });
            
            console.log('‚úÖ Event listeners configurados');
        }

        async function loadInitialData() {
            try {
                if (window.productionManager) {
                    await window.productionManager.cargarDatos();
                    updateKPIs();
                    updateTimeline();
                    updateProductionTable();
                    await generateAIPredictions();
                } else {
                    loadSampleData();
                }
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                loadSampleData();
            }
        }

        function loadSampleData() {
            // Datos de ejemplo mantenidos del c√≥digo original
            document.getElementById('produccionMes').textContent = '3,250 kg';
            document.getElementById('rendimientoPromedio').textContent = '22.5 kg/√°rbol';
            document.getElementById('calidadPromedio').textContent = '87%';
            document.getElementById('ingresosMes').textContent = 'Q 32,500';
            
            const timeline = document.getElementById('timelineProduccion');
            if (timeline) {
                timeline.innerHTML = `
                    <div class="timeline-item">
                        <div class="timeline-fecha">Hoy, 14:30</div>
                        <div class="timeline-contenido">
                            <strong>Cosecha en ${sectoresDisponibles[0]?.label || 'Sector A'}</strong>
                            <div class="timeline-cantidad">45 kg</div>
                            <div class="timeline-detalles">Por Juan P√©rez - Calidad AA</div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-fecha">Ayer, 16:15</div>
                        <div class="timeline-contenido">
                            <strong>Cosecha en ${arbolesDisponibles[0]?.label || '√Årbol 001'}</strong>
                            <div class="timeline-cantidad">78 kg</div>
                            <div class="timeline-detalles">Por Mar√≠a Gonz√°lez - Calidad AAA</div>
                        </div>
                    </div>
                `;
            }
            
            const tbody = document.getElementById('tablaProduccionBody');
            if (tbody) {
                tbody.innerHTML = `
                    <tr onclick="mostrarDetalleRegistro('ejemplo1')">
                        <td>2025-01-10</td>
                        <td>${arbolesDisponibles[0]?.label || '√Årbol 001'}</td>
                        <td>45 kg</td>
                        <td><span class="cosecha-badge aa">AA</span></td>
                        <td>89%</td>
                        <td>Juan P√©rez</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); editarRegistro('ejemplo1')">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }
            
            showSamplePredictions();
        }

        function showSamplePredictions() {
            const container = document.getElementById('prediccionesIA');
            if (container) {
                container.innerHTML = `
                    <div class="prediccion-item">
                        <div class="prediccion-titulo">Producci√≥n Esperada</div>
                        <div class="prediccion-valor" style="color: #22c55e;">
                            +15% pr√≥ximos 7 d√≠as
                        </div>
                        <div class="prediccion-confianza">
                            Confianza: 85% | Condiciones favorables detectadas
                        </div>
                    </div>
                    <div class="prediccion-item">
                        <div class="prediccion-titulo">Calidad Proyectada</div>
                        <div class="prediccion-valor" style="color: #3b82f6;">
                            Grado AA promedio
                        </div>
                        <div class="prediccion-confianza">
                            Confianza: 78% | Basado en condiciones clim√°ticas
                        </div>
                    </div>
                `;
            }
        }

        function updateKPIs() {
            if (window.productionManager) {
                const kpis = window.productionManager.calcularKPIs();
                document.getElementById('produccionMes').textContent = `${kpis.produccionMes.toLocaleString()} kg`;
                document.getElementById('rendimientoPromedio').textContent = `${kpis.rendimientoPromedio} kg/√°rbol`;
                document.getElementById('calidadPromedio').textContent = `${kpis.calidadPromedio}%`;
                document.getElementById('ingresosMes').textContent = `Q ${kpis.ingresosMes.toLocaleString()}`;
            }
        }

        function updateTimeline() {
            if (window.productionManager) {
                const actividades = window.productionManager.obtenerActividadesRecientes();
                const container = document.getElementById('timelineProduccion');
                
                if (container && actividades.length > 0) {
                    container.innerHTML = actividades.map(actividad => `
                        <div class="timeline-item">
                            <div class="timeline-fecha">${formatDate(actividad.fecha)}</div>
                            <div class="timeline-contenido">
                                <strong>${actividad.descripcion}</strong>
                                <div class="timeline-cantidad">${actividad.cantidad} kg</div>
                                <div class="timeline-detalles">${actividad.detalles}</div>
                            </div>
                        </div>
                    `).join('');
                }
            }
        }

        function updateProductionTable() {
            if (window.productionManager) {
                const registros = window.productionManager.obtenerRegistrosFiltrados();
                const tbody = document.getElementById('tablaProduccionBody');
                
                if (tbody && registros.length > 0) {
                    tbody.innerHTML = registros.map(registro => `
                        <tr onclick="mostrarDetalleRegistro('${registro.id}')" style="cursor: pointer;">
                            <td>${formatDate(registro.fecha)}</td>
                            <td>${registro.arbol || registro.bloque}</td>
                            <td>${registro.cantidad} kg</td>
                            <td><span class="cosecha-badge ${registro.tipo}">${registro.tipo.toUpperCase()}</span></td>
                            <td>${registro.calidad}%</td>
                            <td>${registro.responsable}</td>
                            <td>
                                <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); editarRegistro('${registro.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }
            }
        }

        async function generateAIPredictions() {
            try {
                if (window.productionManager) {
                    const predicciones = await window.productionManager.generarPrediccionesIA();
                    const container = document.getElementById('prediccionesIA');
                    
                    if (container && predicciones.length > 0) {
                        container.innerHTML = predicciones.map(pred => `
                            <div class="prediccion-item">
                                <div class="prediccion-titulo">${pred.titulo}</div>
                                <div class="prediccion-valor" style="color: ${pred.color};">${pred.valor}</div>
                                <div class="prediccion-confianza">
                                    Confianza: ${pred.confianza}% | ${pred.descripcion}
                                </div>
                            </div>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('‚ùå Error generando predicciones:', error);
                showSamplePredictions();
            }
        }

        function initializeCharts() {
            try {
                const ctxProd = document.getElementById('graficoProduccion');
                if (ctxProd) {
                    graficoProduccion = new Chart(ctxProd, {
                        type: 'line',
                        data: {
                            labels: ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'],
                            datasets: [{
                                label: 'Producci√≥n (kg)',
                                data: [65, 59, 80, 81, 56, 78, 92],
                                borderColor: '#16a34a',
                                backgroundColor: 'rgba(22, 163, 74, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { labels: { color: '#374151' } } },
                            scales: {
                                x: { ticks: { color: '#6b7280' }, grid: { color: 'rgba(107, 114, 128, 0.2)' } },
                                y: { ticks: { color: '#6b7280' }, grid: { color: 'rgba(107, 114, 128, 0.2)' } }
                            }
                        }
                    });
                }

                const ctxRend = document.getElementById('graficoRendimiento');
                if (ctxRend) {
                    const labels = sectoresDisponibles.length > 0 ? 
                        sectoresDisponibles.map(s => s.label) : 
                        ['Sector A', 'Sector B', 'Sector C'];
                    
                    graficoRendimiento = new Chart(ctxRend, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Rendimiento (kg)',
                                data: labels.map(() => Math.floor(Math.random() * 50) + 30),
                                backgroundColor: 'rgba(59, 130, 246, 0.6)',
                                borderColor: '#3b82f6',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { labels: { color: '#374151' } } },
                            scales: {
                                x: { ticks: { color: '#6b7280' }, grid: { color: 'rgba(107, 114, 128, 0.2)' } },
                                y: { ticks: { color: '#6b7280' }, grid: { color: 'rgba(107, 114, 128, 0.2)' } }
                            }
                        }
                    });
                }
                
                console.log('‚úÖ Gr√°ficos inicializados');
                
            } catch (error) {
                console.error('‚ùå Error inicializando gr√°ficos:', error);
            }
        }

        function setCurrentDates() {
            const hoy = new Date().toISOString().split('T')[0];
            const ahora = new Date().toISOString().slice(0, 16);
            
            const fechaRapida = document.getElementById('fechaRapida');
            const fechaCompleta = document.getElementById('fechaCompleta');
            
            if (fechaRapida) fechaRapida.value = hoy;
            if (fechaCompleta) fechaCompleta.value = ahora;
        }

        // FUNCIONES DE INTERFAZ MANTENIDAS
        function updateIntegrationStatus(status, message) {
            const statusEl = document.getElementById('integrationStatus');
            if (statusEl) {
                statusEl.className = `integration-status ${status}`;
                statusEl.innerHTML = status === 'loading' ? 
                    `<i class="fas fa-sync fa-spin"></i> ${message}` : 
                    `<i class="fas fa-check"></i> ${message}`;
                
                // Ocultar despu√©s de 3 segundos si est√° conectado
                if (status === 'connected') {
                    setTimeout(() => {
                        statusEl.style.opacity = '0';
                        setTimeout(() => statusEl.style.display = 'none', 300);
                    }, 3000);
                }
            }
        }

        // Mantener todas las funciones originales de formularios, modales, etc.
        async function guardarRegistroRapido(e) {
            e.preventDefault();
            
            const datos = {
                fecha: document.getElementById('fechaRapida').value,
                arbolId: document.getElementById('arbolRapido').value,
                cantidad: parseFloat(document.getElementById('cantidadRapida').value),
                tipo: document.getElementById('tipoRapido').value,
                responsable: 'Usuario Actual'
            };
            
            try {
                if (window.productionManager) {
                    await window.productionManager.registrarProduccion(datos);
                    showNotification('Producci√≥n registrada correctamente', 'success');
                } else {
                    showNotification('Registro guardado (modo demo)', 'info');
                }
                
                document.getElementById('formRegistroRapido').reset();
                setCurrentDates();
                await loadInitialData();
                
            } catch (error) {
                console.error('‚ùå Error guardando registro:', error);
                showNotification('Error al guardar el registro', 'error');
            }
        }

        async function guardarRegistroCompleto(e) {
            e.preventDefault();
            
            const datos = {
                fecha: document.getElementById('fechaCompleta').value,
                arbolId: document.getElementById('arbolCompleto').value,
                tipo: document.getElementById('tipoCompleto').value,
                responsable: document.getElementById('responsableCompleto').value,
                cantidad: parseFloat(document.getElementById('cantidadTotal').value),
                calibres: {
                    grande: parseFloat(document.getElementById('calibreGrande').value) || 0,
                    mediano: parseFloat(document.getElementById('calibreMediano').value) || 0,
                    pequeno: parseFloat(document.getElementById('calibrePequeno').value) || 0
                },
                calidad: parseFloat(document.getElementById('calidadCompleta').value) || 0,
                merma: parseFloat(document.getElementById('merma').value) || 0,
                ubicacion: coordenadasGPS,
                fotos: fotosSeleccionadas,
                observaciones: document.getElementById('observacionesCompletas').value
            };
            
            try {
                if (window.productionManager) {
                    await window.productionManager.registrarProduccionCompleta(datos);
                    showNotification('Registro completo guardado correctamente', 'success');
                } else {
                    showNotification('Registro completo guardado (modo demo)', 'info');
                }
                
                cerrarModalFunction();
                await loadInitialData();
                
            } catch (error) {
                console.error('‚ùå Error guardando registro completo:', error);
                showNotification('Error al guardar el registro', 'error');
            }
        }

        // Resto de funciones mantenidas...
        function mostrarRegistroRapido() {
            document.querySelector('.registro-rapido').scrollIntoView({ behavior: 'smooth' });
        }

        function mostrarRegistroCompleto() {
            document.getElementById('modalRegistroCompleto').classList.add('show');
        }

        function cerrarModalFunction() {
            document.getElementById('modalRegistroCompleto').classList.remove('show');
            document.getElementById('formRegistroCompleto').reset();
            coordenadasGPS = null;
            fotosSeleccionadas = [];
            document.getElementById('fotoPreview').innerHTML = '';
            document.getElementById('gpsCoords').textContent = '--¬∞, --¬∞';
            document.getElementById('gpsStatus').textContent = 'Presiona para capturar ubicaci√≥n';
        }

        async function capturarUbicacionGPS() {
            const statusElement = document.getElementById('gpsStatus');
            const coordsElement = document.getElementById('gpsCoords');
            
            statusElement.textContent = 'Obteniendo ubicaci√≥n...';
            
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    });
                });
                
                coordenadasGPS = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    accuracy: position.coords.accuracy,
                    timestamp: new Date()
                };
                
                statusElement.textContent = 'Ubicaci√≥n capturada correctamente';
                coordsElement.textContent = `${coordenadasGPS.lat.toFixed(6)}, ${coordenadasGPS.lng.toFixed(6)}`;
                
            } catch (error) {
                console.error('‚ùå Error obteniendo GPS:', error);
                statusElement.textContent = 'Error obteniendo ubicaci√≥n';
                showNotification('Error obteniendo ubicaci√≥n GPS', 'warning');
            }
        }

        function manejarFotos(e) {
            const archivos = Array.from(e.target.files);
            const preview = document.getElementById('fotoPreview');
            
            fotosSeleccionadas = [];
            preview.innerHTML = '';
            
            archivos.forEach((archivo, index) => {
                if (archivo.type.startsWith('image/')) {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        const img = document.createElement('div');
                        img.className = 'foto-item';
                        img.innerHTML = `
                            <img src="${e.target.result}" alt="Foto ${index + 1}">
                            <button type="button" class="foto-remove" onclick="removerFoto(${index})">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        preview.appendChild(img);
                    };
                    
                    reader.readAsDataURL(archivo);
                    fotosSeleccionadas.push(archivo);
                }
            });
        }

        function removerFoto(index) {
            fotosSeleccionadas.splice(index, 1);
            const preview = document.getElementById('fotoPreview');
            if (preview.children[index]) {
                preview.children[index].remove();
            }
        }

        function cambiarPeriodoGrafico(periodo) {
            document.querySelectorAll('.periodo-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-periodo="${periodo}"]`).classList.add('active');
            
            if (window.productionManager) {
                window.productionManager.obtenerDatosGraficos(periodo).then(datos => {
                    if (graficoProduccion) {
                        graficoProduccion.data.labels = datos.labels;
                        graficoProduccion.data.datasets[0].data = datos.produccion;
                        graficoProduccion.update();
                    }
                    
                    if (graficoRendimiento) {
                        graficoRendimiento.data.labels = datos.bloquesLabels;
                        graficoRendimiento.data.datasets[0].data = datos.rendimiento;
                        graficoRendimiento.update();
                    }
                });
            }
        }

        function accionRapida(accion) {
            switch (accion) {
                case 'nuevo-corte':
                    mostrarRegistroRapido();
                    break;
                case 'control-calidad':
                    showNotification('Funci√≥n en desarrollo', 'info');
                    break;
                case 'reporte-diario':
                    if (window.productionManager) {
                        window.productionManager.generarReporteDiario();
                    } else {
                        showNotification('Reporte diario generado (modo demo)', 'info');
                    }
                    break;
                case 'planificar-cosecha':
                    showNotification('Funci√≥n en desarrollo', 'info');
                    break;
            }
        }

        function aplicarFiltrosFunction() {
            if (window.productionManager) {
                const filtros = {
                    periodo: document.getElementById('filtroPeriodo').value,
                    bloque: document.getElementById('filtroBloque').value,
                    tipo: document.getElementById('filtroTipoCosecha').value,
                    responsable: document.getElementById('filtroResponsable').value
                };
                
                window.productionManager.aplicarFiltros(filtros);
                updateProductionTable();
            }
            showNotification('Filtros aplicados', 'info');
        }

        function limpiarFiltrosFunction() {
            document.getElementById('filtroPeriodo').value = 'mes';
            document.getElementById('filtroBloque').value = '';
            document.getElementById('filtroTipoCosecha').value = '';
            document.getElementById('filtroResponsable').value = '';
            aplicarFiltrosFunction();
        }

        function exportarDatos() {
            if (window.productionManager) {
                window.productionManager.exportarDatos();
            } else {
                showNotification('Datos exportados (modo demo)', 'info');
            }
        }

        function formatDate(fecha) {
            try {
                return new Date(fecha).toLocaleDateString('es-GT', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return fecha;
            }
        }

        function showNotification(mensaje, tipo = 'info') {
            console.log(`${tipo.toUpperCase()}: ${mensaje}`);
            
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10000;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            switch (tipo) {
                case 'success':
                    notification.style.background = '#16a34a';
                    break;
                case 'error':
                    notification.style.background = '#dc2626';
                    break;
                case 'warning':
                    notification.style.background = '#d97706';
                    break;
                default:
                    notification.style.background = '#3b82f6';
            }
            
            notification.textContent = mensaje;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        function mostrarDetalleRegistro(id) {
            showNotification(`Mostrando detalles de registro: ${id}`, 'info');
        }

        function editarRegistro(id) {
            showNotification(`Editando registro: ${id}`, 'info');
        }

        // Hacer funciones globales disponibles
        window.accionRapida = accionRapida;
        window.removerFoto = removerFoto;
        window.mostrarDetalleRegistro = mostrarDetalleRegistro;
        window.editarRegistro = editarRegistro;
        window.cerrarModal = cerrarModalFunction;
        
        console.log('‚úÖ Script de producci√≥n integrado cargado completamente');
    </script>
</body>
</html>