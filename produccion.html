<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Gastos - Finca La Herradura</title>
    
    <!-- Meta tags -->
    <meta name="description" content="Control financiero inteligente con análisis de gastos, presupuestos y predicciones de costos">
    <meta name="keywords" content="gastos, finanzas, presupuesto, costos, análisis financiero, control">
    
    <!-- Favicon y PWA -->
    <link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
    <link rel="manifest" href="/manifest.json">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/style.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js para gráficos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        /* CSS base para la página */
        .gastos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .title-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .estado-presupuesto {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border-radius: 20px;
            font-weight: 600;
        }

        .estado-presupuesto.normal {
            background: rgba(34, 197, 94, 0.2);
            color: #16a34a;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .estado-presupuesto.alerta {
            background: rgba(245, 158, 11, 0.2);
            color: #d97706;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .estado-presupuesto.critico {
            background: rgba(239, 68, 68, 0.2);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .resumen-financiero {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .resumen-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .resumen-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
        }

        .resumen-card.gastos::before {
            background: linear-gradient(90deg, #dc2626, #b91c1c);
        }

        .resumen-card.presupuesto::before {
            background: linear-gradient(90deg, #3b82f6, #1d4ed8);
        }

        .resumen-card.proyectado::before {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        .resumen-card.diferencia::before {
            background: linear-gradient(90deg, #8b5cf6, #7c3aed);
        }

        .resumen-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .resumen-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }

        .resumen-tendencia {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .resumen-tendencia.positiva {
            color: #22c55e;
        }

        .resumen-tendencia.negativa {
            color: #ef4444;
        }

        .resumen-valor {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .resumen-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .progress-presupuesto {
            margin-top: 1rem;
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        /* CORRECCIONES PARA GRÁFICOS */
        .contenido-principal {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .graficos-container {
            display: grid;
            gap: 2rem;
            max-height: 90vh;
            overflow: hidden;
        }

        .grafico-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            height: 400px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .grafico-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            min-height: 40px;
            flex-shrink: 0;
        }

        .grafico-titulo {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* CRÍTICO: Contenedor del canvas con tamaño controlado */
        .chart-container {
            position: relative;
            height: 300px;
            flex: 1;
            min-height: 250px;
            max-height: 350px;
            overflow: hidden;
        }

        /* CRÍTICO: Canvas específico */
        .chart-container canvas {
            max-width: 100% !important;
            max-height: 100% !important;
            width: 100% !important;
            height: 100% !important;
            object-fit: contain;
        }

        #graficoEvolucion {
            max-height: 300px !important;
            height: 300px !important;
        }

        #graficoCategorias {
            max-height: 250px !important;
            height: 250px !important;
        }

        /* Resto de estilos */
        .filtros-gastos {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .filtros-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .acciones-rapidas {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .accion-rapida {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            min-width: 180px;
        }

        .accion-rapida:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .accion-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }

        .categorias-gastos {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
        }

        .categoria-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin-bottom: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border-left: 4px solid;
            transition: all 0.3s ease;
        }

        .categoria-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(4px);
        }

        .categoria-item.mano-obra {
            border-left-color: #ef4444;
        }

        .categoria-item.insumos {
            border-left-color: #f59e0b;
        }

        .categoria-item.transporte {
            border-left-color: #3b82f6;
        }

        .categoria-item.mantenimiento {
            border-left-color: #8b5cf6;
        }

        .categoria-item.servicios {
            border-left-color: #22c55e;
        }

        .categoria-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .categoria-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }

        .categoria-datos {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .categoria-monto {
            font-size: 1.125rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .categoria-porcentaje {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .form-registro-gasto {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .tabla-gastos {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .tabla-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .categoria-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .categoria-badge.mano-obra {
            background: rgba(239, 68, 68, 0.2);
            color: #dc2626;
        }

        .categoria-badge.insumos {
            background: rgba(245, 158, 11, 0.2);
            color: #d97706;
        }

        .categoria-badge.transporte {
            background: rgba(59, 130, 246, 0.2);
            color: #2563eb;
        }

        .categoria-badge.mantenimiento {
            background: rgba(139, 92, 246, 0.2);
            color: #8b5cf6;
        }

        .categoria-badge.servicios {
            background: rgba(34, 197, 94, 0.2);
            color: #16a34a;
        }

        .estado-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .estado-badge.pendiente {
            background: rgba(245, 158, 11, 0.2);
            color: #d97706;
        }

        .estado-badge.pagado {
            background: rgba(34, 197, 94, 0.2);
            color: #16a34a;
        }

        .estado-badge.vencido {
            background: rgba(239, 68, 68, 0.2);
            color: #dc2626;
        }

        .initialization-loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            font-size: 1.2rem;
        }

        .initialization-loader.hidden {
            display: none;
        }

        /* Responsivo */
        @media (max-width: 1024px) {
            .contenido-principal {
                grid-template-columns: 1fr;
            }
            
            .grafico-card {
                height: 350px;
            }
            
            .chart-container {
                height: 250px;
                max-height: 280px;
            }
        }

        @media (max-width: 768px) {
            .gastos-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .resumen-financiero {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .acciones-rapidas {
                justify-content: center;
            }
            
            .filtros-grid {
                grid-template-columns: 1fr;
            }
            
            .form-registro-gasto {
                grid-template-columns: 1fr;
            }
            
            .grafico-card {
                height: 320px;
                padding: 1rem;
            }
            
            .chart-container {
                height: 220px;
                max-height: 250px;
            }
        }
    </style>
</head>
<body>
    <!-- Loader de inicialización -->
    <div class="initialization-loader" id="initLoader">
        <div style="text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">
                <i class="fas fa-receipt fa-spin"></i>
            </div>
            <div>Inicializando sistema de gastos...</div>
            <div style="font-size: 0.9rem; opacity: 0.7; margin-top: 0.5rem;">
                Conectando con servicios
            </div>
        </div>
    </div>

    <!-- Navegación -->
    <nav id="navbar"></nav>

    <!-- Contenido principal -->
    <main class="main-content-wrapper">
        <!-- Header de la página -->
        <header class="gastos-header">
            <div class="page-title">
                <div class="title-icon">
                    <i class="fas fa-receipt"></i>
                </div>
                <div>
                    <h1>Gestión de Gastos</h1>
                    <p>Control financiero y análisis de costos</p>
                </div>
            </div>
            
            <div class="header-actions">
                <div class="estado-presupuesto normal" id="estadoPresupuesto">
                    <i class="fas fa-check-circle"></i>
                    <span>Dentro del presupuesto</span>
                </div>
                
                <button class="btn btn-primary" id="btnNuevoGasto">
                    <i class="fas fa-plus"></i> Nuevo Gasto
                </button>
                
                <button class="btn btn-secondary" id="btnExportarReporte">
                    <i class="fas fa-file-export"></i> Exportar
                </button>
            </div>
        </header>

        <!-- Resumen financiero -->
        <section class="resumen-financiero">
            <div class="resumen-card gastos">
                <div class="resumen-header">
                    <div class="resumen-icon" style="background: #dc2626;">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="resumen-tendencia positiva">
                        <i class="fas fa-arrow-down"></i>
                        <span>-5%</span>
                    </div>
                </div>
                <div class="resumen-valor" id="gastosDelMes">Q 0</div>
                <div class="resumen-label">Gastos del Mes</div>
                <div class="progress-presupuesto">
                    <div class="progress-info">
                        <span>Presupuesto usado</span>
                        <span id="porcentajeUsado">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress" id="progressPresupuesto" style="width: 0%;"></div>
                    </div>
                </div>
            </div>
            
            <div class="resumen-card presupuesto">
                <div class="resumen-header">
                    <div class="resumen-icon" style="background: #3b82f6;">
                        <i class="fas fa-calculator"></i>
                    </div>
                    <div class="resumen-tendencia positiva">
                        <i class="fas fa-arrow-up"></i>
                        <span>+2%</span>
                    </div>
                </div>
                <div class="resumen-valor" id="presupuestoMensual">Q 0</div>
                <div class="resumen-label">Presupuesto Mensual</div>
            </div>
            
            <div class="resumen-card proyectado">
                <div class="resumen-header">
                    <div class="resumen-icon" style="background: #f59e0b;">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="resumen-tendencia negativa">
                        <i class="fas fa-arrow-up"></i>
                        <span>+8%</span>
                    </div>
                </div>
                <div class="resumen-valor" id="gastoProyectado">Q 0</div>
                <div class="resumen-label">Proyectado fin de mes</div>
            </div>
            
            <div class="resumen-card diferencia">
                <div class="resumen-header">
                    <div class="resumen-icon" style="background: #8b5cf6;">
                        <i class="fas fa-balance-scale"></i>
                    </div>
                    <div class="resumen-tendencia positiva">
                        <i class="fas fa-arrow-down"></i>
                        <span>Q 2,500</span>
                    </div>
                </div>
                <div class="resumen-valor" id="diferenciapresupuesto">Q 0</div>
                <div class="resumen-label">Diferencia vs Presupuesto</div>
            </div>
        </section>

        <!-- Filtros -->
        <section class="filtros-gastos">
            <h3 style="margin-bottom: 1rem;">
                <i class="fas fa-filter"></i> Filtros de Gastos
            </h3>
            
            <div class="filtros-grid">
                <div class="filtro-grupo">
                    <label class="form-label">Período</label>
                    <select class="form-input" id="filtroPeriodo">
                        <option value="hoy">Hoy</option>
                        <option value="semana">Esta Semana</option>
                        <option value="mes" selected>Este Mes</option>
                        <option value="trimestre">Este Trimestre</option>
                        <option value="ano">Este Año</option>
                    </select>
                </div>
                
                <div class="filtro-grupo">
                    <label class="form-label">Categoría</label>
                    <select class="form-input" id="filtroCategoria">
                        <option value="">Todas las categorías</option>
                        <option value="mano-obra">Mano de Obra</option>
                        <option value="insumos">Insumos</option>
                        <option value="transporte">Transporte</option>
                        <option value="mantenimiento">Mantenimiento</option>
                        <option value="servicios">Servicios</option>
                    </select>
                </div>
                
                <div class="filtro-grupo">
                    <label class="form-label">Estado</label>
                    <select class="form-input" id="filtroEstado">
                        <option value="">Todos los estados</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="pagado">Pagado</option>
                        <option value="vencido">Vencido</option>
                    </select>
                </div>
                
                <div class="filtro-grupo">
                    <button class="btn btn-primary" id="aplicarFiltros">
                        <i class="fas fa-search"></i> Aplicar
                    </button>
                    <button class="btn btn-secondary" id="limpiarFiltros">
                        <i class="fas fa-times"></i> Limpiar
                    </button>
                </div>
            </div>
        </section>

        <!-- Acciones rápidas -->
        <section class="acciones-rapidas">
            <div class="accion-rapida" onclick="accionRapida('nuevo-gasto')">
                <div class="accion-icon" style="background: #dc2626;">
                    <i class="fas fa-plus"></i>
                </div>
                <div>
                    <div style="font-weight: 600;">Registrar Gasto</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">Nuevo registro</div>
                </div>
            </div>
            
            <div class="accion-rapida" onclick="accionRapida('presupuesto')">
                <div class="accion-icon" style="background: #3b82f6;">
                    <i class="fas fa-chart-pie"></i>
                </div>
                <div>
                    <div style="font-weight: 600;">Gestionar Presupuesto</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">Configurar límites</div>
                </div>
            </div>
            
            <div class="accion-rapida" onclick="accionRapida('reporte')">
                <div class="accion-icon" style="background: #f59e0b;">
                    <i class="fas fa-file-chart-line"></i>
                </div>
                <div>
                    <div style="font-weight: 600;">Generar Reporte</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">Análisis financiero</div>
                </div>
            </div>
        </section>

        <!-- Registro rápido de gasto -->
        <section class="form-registro-gasto">
            <h3 style="grid-column: 1 / -1; margin-bottom: 1rem;">
                <i class="fas fa-bolt"></i> Registro Rápido de Gasto
            </h3>
            
            <div class="form-group">
                <label class="form-label">Fecha</label>
                <input type="date" class="form-input" id="fechaGasto" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Categoría</label>
                <select class="form-input" id="categoriaGasto" required>
                    <option value="">Seleccionar...</option>
                    <option value="mano-obra">Mano de Obra</option>
                    <option value="insumos">Insumos</option>
                    <option value="transporte">Transporte</option>
                    <option value="mantenimiento">Mantenimiento</option>
                    <option value="servicios">Servicios</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Concepto</label>
                <input type="text" class="form-input" id="conceptoGasto" placeholder="Descripción del gasto" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Monto (Q)</label>
                <input type="number" class="form-input" id="montoGasto" step="0.01" min="0" required>
            </div>
            
            <div class="form-group">
                <label class="form-label">Estado</label>
                <select class="form-input" id="estadoGasto" required>
                    <option value="pagado">Pagado</option>
                    <option value="pendiente">Pendiente</option>
                </select>
            </div>
            
            <div class="form-group">
                <button type="button" class="btn btn-success" id="guardarGastoRapido">
                    <i class="fas fa-save"></i> Guardar
                </button>
            </div>
        </section>

        <!-- Contenido principal -->
        <div class="contenido-principal">
            <!-- Gráficos con contenedores de tamaño fijo -->
            <div class="graficos-container">
                <!-- Gráfico de evolución de gastos -->
                <div class="grafico-card">
                    <div class="grafico-header">
                        <h3 class="grafico-titulo">
                            <i class="fas fa-chart-line"></i>
                            Evolución de Gastos
                        </h3>
                        <div class="periodo-selector">
                            <button class="periodo-btn active" data-periodo="mes">Mes</button>
                            <button class="periodo-btn" data-periodo="trimestre">Trimestre</button>
                            <button class="periodo-btn" data-periodo="ano">Año</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="graficoEvolucion"></canvas>
                    </div>
                </div>
                
                <!-- Gráfico de gastos por categoría -->
                <div class="grafico-card">
                    <div class="grafico-header">
                        <h3 class="grafico-titulo">
                            <i class="fas fa-chart-pie"></i>
                            Distribución por Categoría
                        </h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="graficoCategorias"></canvas>
                    </div>
                </div>
            </div>

            <!-- Panel lateral -->
            <div>
                <!-- Categorías de gastos -->
                <div class="categorias-gastos">
                    <h3 style="margin-bottom: 1.5rem;">
                        <i class="fas fa-tags"></i>
                        Gastos por Categoría
                    </h3>
                    
                    <div id="listaCategoriasGastos">
                        <!-- Se cargarán dinámicamente -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla de gastos -->
        <section class="tabla-gastos">
            <div class="tabla-header">
                <h3>
                    <i class="fas fa-table"></i>
                    Registros de Gastos
                </h3>
            </div>
            
            <div class="table-container">
                <table class="table" id="tablaGastos">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Categoría</th>
                            <th>Concepto</th>
                            <th>Monto</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaGastosBody">
                        <!-- Los datos se cargarán dinámicamente -->
                    </tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- Scripts Firebase (deben cargarse primero) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <!-- Scripts de aplicación -->
    <script type="module" src="/js/firebase-config.js"></script>
    <script type="module" src="/js/auth.js"></script>
    <script type="module" src="/js/nav.js"></script>
    <script type="module" src="/js/offline.js"></script>
    <script type="module" src="/js/gastos.js"></script>
    
    <script>
        // Variables globales
        let graficoEvolucion, graficoCategorias;
        let sistemaInicializado = false;

        // ==========================================
        // FUNCIONES DE ESPERA Y INICIALIZACIÓN
        // ==========================================

        function esperarFirebase() {
            return new Promise((resolve) => {
                const maxWait = 10000;
                const checkInterval = 100;
                let elapsed = 0;

                const check = () => {
                    if (window.firebase && window.auth && window.db) {
                        console.log('✅ Firebase disponible para gastos.html');
                        resolve(true);
                    } else if (elapsed < maxWait) {
                        elapsed += checkInterval;
                        setTimeout(check, checkInterval);
                    } else {
                        console.warn('⚠️ Timeout esperando Firebase en gastos.html');
                        resolve(false);
                    }
                };

                window.addEventListener('firebaseReady', () => {
                    console.log('🔥 Evento firebaseReady recibido');
                    resolve(true);
                }, { once: true });

                check();
            });
        }

        function esperarAuthManager() {
            return new Promise((resolve) => {
                const maxWait = 10000;
                const checkInterval = 100;
                let elapsed = 0;

                const check = () => {
                    if (window.authManager && window.authManager.isInitialized) {
                        console.log('✅ AuthManager disponible para gastos.html');
                        resolve(true);
                    } else if (elapsed < maxWait) {
                        elapsed += checkInterval;
                        setTimeout(check, checkInterval);
                    } else {
                        console.warn('⚠️ Timeout esperando AuthManager en gastos.html');
                        resolve(false);
                    }
                };

                check();
            });
        }

        function esperarExpenseManager() {
            return new Promise((resolve) => {
                const maxWait = 15000;
                const checkInterval = 200;
                let elapsed = 0;

                const check = () => {
                    if (window.expenseManager || window.gastosManager) {
                        console.log('✅ ExpenseManager disponible para gastos.html');
                        resolve(true);
                    } else if (elapsed < maxWait) {
                        elapsed += checkInterval;
                        setTimeout(check, checkInterval);
                    } else {
                        console.warn('⚠️ Timeout esperando ExpenseManager en gastos.html');
                        resolve(false);
                    }
                };

                check();
            });
        }

        async function verificarAutenticacion() {
            try {
                const firebaseReady = await esperarFirebase();
                if (!firebaseReady) {
                    console.error('❌ Firebase no disponible para autenticación');
                    return false;
                }

                return new Promise((resolve) => {
                    if (window.firebase && window.firebase.auth) {
                        window.firebase.auth().onAuthStateChanged((user) => {
                            resolve(!!user);
                        });
                    } else {
                        console.error('❌ Firebase Auth no disponible');
                        resolve(false);
                    }
                });
            } catch (error) {
                console.error('❌ Error en verificación de autenticación:', error);
                return false;
            }
        }

        // ==========================================
        // INICIALIZACIÓN PRINCIPAL
        // ==========================================

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('💰 Iniciando aplicación de gastos...');
                
                document.getElementById('initLoader').classList.remove('hidden');

                const autenticado = await verificarAutenticacion();
                if (!autenticado) {
                    console.log('❌ Usuario no autenticado, redirigiendo...');
                    window.location.href = '/login.html';
                    return;
                }
                console.log('✅ Usuario autenticado');

                await esperarAuthManager();
                await esperarExpenseManager();
                await inicializarPagina();

                sistemaInicializado = true;
                console.log('🎉 Sistema de gastos completamente inicializado');

            } catch (error) {
                console.error('❌ Error fatal en inicialización:', error);
                mostrarError('Error crítico iniciando la aplicación');
            } finally {
                document.getElementById('initLoader').classList.add('hidden');
            }
        });

        async function inicializarPagina() {
            try {
                console.log('⚙️ Inicializando componentes de la página...');
                
                configurarEventListeners();
                await cargarDatosIniciales();
                inicializarGraficos();
                
                document.getElementById('fechaGasto').value = new Date().toISOString().split('T')[0];
                
                console.log('✅ Página de gastos inicializada correctamente');
                
            } catch (error) {
                console.error('❌ Error inicializando página:', error);
                mostrarError('Error cargando la página de gastos');
            }
        }

        function configurarEventListeners() {
            document.getElementById('btnNuevoGasto')?.addEventListener('click', mostrarFormularioGasto);
            document.getElementById('btnExportarReporte')?.addEventListener('click', exportarReporte);
            document.getElementById('guardarGastoRapido')?.addEventListener('click', guardarGastoRapido);
            document.getElementById('aplicarFiltros')?.addEventListener('click', aplicarFiltros);
            document.getElementById('limpiarFiltros')?.addEventListener('click', limpiarFiltros);
            
            document.querySelectorAll('.periodo-btn').forEach(btn => {
                btn.addEventListener('click', (e) => cambiarPeriodoGrafico(e.target.dataset.periodo));
            });

            window.addEventListener('online', () => {
                if (sistemaInicializado) {
                    cargarDatosIniciales();
                }
            });

            console.log('✅ Event listeners configurados');
        }

        async function cargarDatosIniciales() {
            try {
                const gestor = window.expenseManager || window.gastosManager;
                if (gestor) {
                    await actualizarResumenFinanciero();
                    await actualizarCategoriasGastos();
                    await actualizarTablaGastos();
                } else {
                    console.warn('⚠️ Gestor de gastos no disponible, usando datos simulados');
                    await cargarDatosSimulados();
                }
            } catch (error) {
                console.error('❌ Error cargando datos:', error);
                await cargarDatosSimulados();
            }
        }

        async function cargarDatosSimulados() {
            // Datos simulados para el resumen
            document.getElementById('gastosDelMes').textContent = 'Q 8,250';
            document.getElementById('presupuestoMensual').textContent = 'Q 15,000';
            document.getElementById('gastoProyectado').textContent = 'Q 12,500';
            document.getElementById('diferenciapresupuesto').textContent = 'Q 6,750';
            document.getElementById('porcentajeUsado').textContent = '55%';
            document.getElementById('progressPresupuesto').style.width = '55%';

            // Datos simulados para categorías
            const categoriasSimuladas = [
                { id: 'mano-obra', nombre: 'Mano de Obra', monto: 3200, porcentaje: 38.8, color: '#ef4444', icono: 'fa-users' },
                { id: 'insumos', nombre: 'Insumos', monto: 2100, porcentaje: 25.5, color: '#f59e0b', icono: 'fa-seedling' },
                { id: 'transporte', nombre: 'Transporte', monto: 1500, porcentaje: 18.2, color: '#3b82f6', icono: 'fa-truck' },
                { id: 'servicios', nombre: 'Servicios', monto: 900, porcentaje: 10.9, color: '#22c55e', icono: 'fa-tools' },
                { id: 'mantenimiento', nombre: 'Mantenimiento', monto: 550, porcentaje: 6.7, color: '#8b5cf6', icono: 'fa-wrench' }
            ];

            const container = document.getElementById('listaCategoriasGastos');
            container.innerHTML = categoriasSimuladas.map(cat => `
                <div class="categoria-item ${cat.id}">
                    <div class="categoria-info">
                        <div class="categoria-icon" style="background: ${cat.color};">
                            <i class="fas ${cat.icono}"></i>
                        </div>
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary);">${cat.nombre}</div>
                            <div style="font-size: 0.875rem; color: var(--text-secondary);">3 gastos</div>
                        </div>
                    </div>
                    <div class="categoria-datos">
                        <div class="categoria-monto">Q ${cat.monto.toLocaleString()}</div>
                        <div class="categoria-porcentaje">${cat.porcentaje}%</div>
                    </div>
                </div>
            `).join('');

            // Datos simulados para tabla
            const gastosSimulados = [
                { fecha: '2024-01-15', categoria: 'Mano de Obra', concepto: 'Jornales cosecha', monto: 1200, estado: 'pagado' },
                { fecha: '2024-01-14', categoria: 'Insumos', concepto: 'Fertilizantes', monto: 850, estado: 'pendiente' },
                { fecha: '2024-01-13', categoria: 'Transporte', concepto: 'Combustible', monto: 320, estado: 'pagado' }
            ];

            const tbody = document.getElementById('tablaGastosBody');
            tbody.innerHTML = gastosSimulados.map(gasto => `
                <tr>
                    <td>${formatearFecha(gasto.fecha)}</td>
                    <td><span class="categoria-badge mano-obra">${gasto.categoria}</span></td>
                    <td>${gasto.concepto}</td>
                    <td>Q ${gasto.monto.toLocaleString()}</td>
                    <td><span class="estado-badge ${gasto.estado}">${gasto.estado}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function inicializarGraficos() {
            try {
                const ctxEvol = document.getElementById('graficoEvolucion');
                if (ctxEvol) {
                    graficoEvolucion = new Chart(ctxEvol, {
                        type: 'line',
                        data: {
                            labels: ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'],
                            datasets: [{
                                label: 'Gastos (Q)',
                                data: [2000, 2500, 1800, 2200],
                                borderColor: '#dc2626',
                                backgroundColor: 'rgba(220, 38, 38, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    labels: { 
                                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') || '#333'
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    ticks: { 
                                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') || '#666'
                                    },
                                    grid: { 
                                        color: 'rgba(0, 0, 0, 0.1)'
                                    }
                                },
                                y: {
                                    ticks: { 
                                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') || '#666'
                                    },
                                    grid: { 
                                        color: 'rgba(0, 0, 0, 0.1)'
                                    }
                                }
                            }
                        }
                    });
                }

                const ctxCat = document.getElementById('graficoCategorias');
                if (ctxCat) {
                    graficoCategorias = new Chart(ctxCat, {
                        type: 'doughnut',
                        data: {
                            labels: ['Mano de Obra', 'Insumos', 'Transporte', 'Servicios', 'Mantenimiento'],
                            datasets: [{
                                data: [3200, 2100, 1500, 900, 550],
                                backgroundColor: [
                                    '#ef4444', '#f59e0b', '#3b82f6', '#22c55e', '#8b5cf6'
                                ],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { 
                                        color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') || '#333'
                                    }
                                }
                            }
                        }
                    });
                }

                console.log('✅ Gráficos inicializados');
            } catch (error) {
                console.error('❌ Error inicializando gráficos:', error);
            }
        }

        // Funciones principales
        async function guardarGastoRapido() {
            const datos = {
                fecha: document.getElementById('fechaGasto').value,
                categoria: document.getElementById('categoriaGasto').value,
                concepto: document.getElementById('conceptoGasto').value,
                monto: parseFloat(document.getElementById('montoGasto').value),
                estado: document.getElementById('estadoGasto').value
            };
            
            if (!datos.categoria || !datos.concepto || !datos.monto) {
                mostrarNotificacion('Complete todos los campos requeridos', 'error');
                return;
            }
            
            try {
                const gestor = window.expenseManager || window.gastosManager;
                if (gestor && gestor.createExpense) {
                    await gestor.createExpense(datos);
                    mostrarNotificacion('Gasto registrado correctamente', 'success');
                    limpiarFormularioRapido();
                    await cargarDatosIniciales();
                } else {
                    console.log('Gasto simulado guardado:', datos);
                    mostrarNotificacion('Gasto registrado (modo demo)', 'info');
                    limpiarFormularioRapido();
                }
            } catch (error) {
                console.error('Error guardando gasto:', error);
                mostrarNotificacion('Error al registrar el gasto', 'error');
            }
        }

        function limpiarFormularioRapido() {
            document.getElementById('fechaGasto').value = new Date().toISOString().split('T')[0];
            document.getElementById('categoriaGasto').value = '';
            document.getElementById('conceptoGasto').value = '';
            document.getElementById('montoGasto').value = '';
            document.getElementById('estadoGasto').value = 'pagado';
        }

        function cambiarPeriodoGrafico(periodo) {
            document.querySelectorAll('.periodo-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-periodo="${periodo}"]`)?.classList.add('active');
            
            // Simular cambio de datos
            if (graficoEvolucion) {
                let nuevosLabels, nuevosDatos;
                
                switch(periodo) {
                    case 'mes':
                        nuevosLabels = ['Sem 1', 'Sem 2', 'Sem 3', 'Sem 4'];
                        nuevosDatos = [2000, 2500, 1800, 2200];
                        break;
                    case 'trimestre':
                        nuevosLabels = ['Ene', 'Feb', 'Mar'];
                        nuevosDatos = [8500, 7200, 8250];
                        break;
                    case 'ano':
                        nuevosLabels = ['Q1', 'Q2', 'Q3', 'Q4'];
                        nuevosDatos = [23950, 25100, 24750, 26200];
                        break;
                }
                
                graficoEvolucion.data.labels = nuevosLabels;
                graficoEvolucion.data.datasets[0].data = nuevosDatos;
                graficoEvolucion.update();
            }
        }

        // Funciones auxiliares
        function mostrarFormularioGasto() {
            mostrarNotificacion('Formulario detallado en desarrollo', 'info');
        }

        function exportarReporte() {
            mostrarNotificacion('Exportación en desarrollo', 'info');
        }

        function aplicarFiltros() {
            mostrarNotificacion('Filtros aplicados', 'info');
        }

        function limpiarFiltros() {
            document.getElementById('filtroPeriodo').value = 'mes';
            document.getElementById('filtroCategoria').value = '';
            document.getElementById('filtroEstado').value = '';
            mostrarNotificacion('Filtros limpiados', 'info');
        }

        function accionRapida(accion) {
            switch(accion) {
                case 'nuevo-gasto':
                    mostrarFormularioGasto();
                    break;
                case 'presupuesto':
                    mostrarNotificacion('Gestión de presupuesto en desarrollo', 'info');
                    break;
                case 'reporte':
                    exportarReporte();
                    break;
            }
        }

        function formatearFecha(fecha) {
            return new Date(fecha).toLocaleDateString('es-GT', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function mostrarNotificacion(mensaje, tipo = 'info') {
            console.log(`${tipo.toUpperCase()}: ${mensaje}`);
            
            if (window.notificationManager) {
                switch(tipo) {
                    case 'success':
                        window.notificationManager.success(mensaje);
                        break;
                    case 'error':
                        window.notificationManager.error(mensaje);
                        break;
                    case 'warning':
                        window.notificationManager.warning(mensaje);
                        break;
                    default:
                        window.notificationManager.info(mensaje);
                }
            }
        }

        function mostrarError(mensaje) {
            mostrarNotificacion(mensaje, 'error');
        }

        // Funciones auxiliares que necesitaba definir
        async function actualizarResumenFinanciero() {
            // Implementación pendiente
        }

        async function actualizarCategoriasGastos() {
            // Implementación pendiente
        }

        async function actualizarTablaGastos() {
            // Implementación pendiente
        }

        // Hacer funciones globales
        window.accionRapida = accionRapida;

        // Manejo de errores globales
        window.addEventListener('error', (event) => {
            console.error('❌ Error global:', event.error);
            mostrarError('Error inesperado en la aplicación');
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('❌ Promesa rechazada no manejada:', event.reason);
            mostrarError('Error de conexión o servicio');
        });
    </script>
</body>
</html>
