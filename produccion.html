<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Producci√≥n - Finca La Herradura</title>
    
    <!-- Meta tags -->
    <meta name="description" content="Control de producci√≥n y cosechas con an√°lisis inteligente y predicciones de rendimiento">
    <meta name="keywords" content="producci√≥n, cosecha, limones, rendimiento, an√°lisis, predicci√≥n">
    
    <!-- Favicon y PWA -->
    <link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
    <link rel="manifest" href="/manifest.json">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/style.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Estilos espec√≠ficos para producci√≥n -->
    <style>
        .main-content-wrapper {
            margin-left: 280px;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
            padding: 2rem;
        }

        @media (max-width: 768px) {
            .main-content-wrapper {
                margin-left: 0;
                padding: 1rem;
                padding-top: 5rem;
            }
        }

        .produccion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .title-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-success {
            background: #16a34a;
            color: white;
        }

        .btn-success:hover {
            background: #15803d;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-info {
            background: #06b6d4;
            color: white;
        }

        .btn-info:hover {
            background: #0891b2;
        }

        .kpis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .kpi-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .kpi-card:hover {
            transform: translateY(-2px);
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #16a34a, #3b82f6);
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .kpi-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: white;
        }

        .kpi-icon.produccion {
            background: linear-gradient(135deg, #16a34a, #15803d);
        }

        .kpi-icon.rendimiento {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .kpi-icon.calidad {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .kpi-icon.ingresos {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
        }

        .kpi-tendencia {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .kpi-tendencia.positiva {
            color: #22c55e;
        }

        .kpi-valor {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .kpi-label {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .quick-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .quick-action {
            background: white;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            min-width: 200px;
        }

        .quick-action:hover {
            border-color: #3b82f6;
            transform: translateY(-2px);
        }

        .quick-action-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .graficos-container {
            display: grid;
            gap: 2rem;
        }

        .grafico-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .grafico-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .grafico-titulo {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .periodo-selector {
            display: flex;
            gap: 0.5rem;
        }

        .periodo-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }

        .periodo-btn.active,
        .periodo-btn:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .predicciones-ia {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(167, 139, 250, 0.1));
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 16px;
            padding: 1.5rem;
        }

        .ia-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .ia-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }

        .prediccion-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(139, 92, 246, 0.1);
        }

        .prediccion-titulo {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .prediccion-valor {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .prediccion-confianza {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .timeline-container {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .timeline-item {
            position: relative;
            padding-left: 2rem;
            margin-bottom: 1.5rem;
            border-left: 2px solid #e5e7eb;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -6px;
            top: 0.5rem;
            width: 10px;
            height: 10px;
            background: #3b82f6;
            border-radius: 50%;
            border: 2px solid white;
        }

        .timeline-fecha {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .timeline-contenido {
            color: #1f2937;
        }

        .timeline-cantidad {
            font-weight: 700;
            color: #16a34a;
            font-size: 1.125rem;
            margin-top: 0.5rem;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-header {
            padding: 2rem 2rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #f3f4f6;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
        }

        .modal-body {
            padding: 2rem;
        }

        .form-sections {
            display: grid;
            gap: 2rem;
        }

        .form-section {
            border: 1px solid #f3f4f6;
            border-radius: 12px;
            padding: 1.5rem;
        }

        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .integration-status {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.75rem;
            border: 1px solid #e5e7eb;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .integration-status.connected {
            border-color: #16a34a;
            color: #16a34a;
        }

        .integration-status.loading {
            border-color: #f59e0b;
            color: #f59e0b;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            background: #16a34a;
        }

        .notification.error {
            background: #dc2626;
        }

        .notification.warning {
            background: #d97706;
        }

        .notification.info {
            background: #3b82f6;
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .loading-spinner i {
            font-size: 2rem;
            color: #3b82f6;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .produccion-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .kpis-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .quick-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Indicador de estado de integraci√≥n -->
    <div class="integration-status loading" id="integrationStatus">
        <i class="fas fa-sync fa-spin"></i> Cargando datos...
    </div>

    <!-- Navegaci√≥n -->
    <nav id="navbar"></nav>

    <!-- Contenido principal -->
    <main class="main-content-wrapper">
        <!-- Header de la p√°gina -->
        <header class="produccion-header">
            <div class="page-title">
                <div class="title-icon">
                    <i class="fas fa-apple-alt"></i>
                </div>
                <div>
                    <h1>Gesti√≥n de Producci√≥n</h1>
                    <p>Control de cosechas y an√°lisis de rendimiento</p>
                </div>
            </div>
            
            <div class="header-actions">
                <button class="btn btn-success" id="btnNuevoCorte">
                    <i class="fas fa-cut"></i> Nuevo Corte
                </button>
                
                <button class="btn btn-primary" id="btnNuevoRegistro">
                    <i class="fas fa-clipboard-list"></i> Registro Completo
                </button>
                
                <button class="btn btn-secondary" id="btnExportarDatos">
                    <i class="fas fa-download"></i> Exportar
                </button>
            </div>
        </header>

        <!-- KPIs principales -->
        <section class="kpis-grid">
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon produccion">
                        <i class="fas fa-seedling"></i>
                    </div>
                    <div class="kpi-tendencia positiva">
                        <i class="fas fa-arrow-up"></i>
                        <span id="tendenciaProduccion">+12%</span>
                    </div>
                </div>
                <div class="kpi-valor" id="produccionMes">0 kg</div>
                <div class="kpi-label">Producci√≥n del Mes</div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon rendimiento">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="kpi-tendencia positiva">
                        <i class="fas fa-arrow-up"></i>
                        <span id="tendenciaRendimiento">+8%</span>
                    </div>
                </div>
                <div class="kpi-valor" id="rendimientoPromedio">0 kg/√°rbol</div>
                <div class="kpi-label">Rendimiento Promedio</div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon calidad">
                        <i class="fas fa-star"></i>
                    </div>
                    <div class="kpi-tendencia positiva">
                        <i class="fas fa-arrow-up"></i>
                        <span id="tendenciaCalidad">+5%</span>
                    </div>
                </div>
                <div class="kpi-valor" id="calidadPromedio">0%</div>
                <div class="kpi-label">Calidad Promedio</div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-header">
                    <div class="kpi-icon ingresos">
                        <i class="fas fa-coins"></i>
                    </div>
                    <div class="kpi-tendencia positiva">
                        <i class="fas fa-arrow-up"></i>
                        <span id="tendenciaIngresos">+15%</span>
                    </div>
                </div>
                <div class="kpi-valor" id="ingresosMes">Q 0</div>
                <div class="kpi-label">Ingresos del Mes</div>
            </div>
        </section>

        <!-- Acciones r√°pidas -->
        <section class="quick-actions">
            <div class="quick-action" onclick="accionRapida('nuevo-corte')">
                <div class="quick-action-icon" style="background: #16a34a;">
                    <i class="fas fa-cut"></i>
                </div>
                <div>
                    <div style="font-weight: 600;">Nuevo Corte</div>
                    <div style="font-size: 0.75rem; color: #6b7280;">Registrar cosecha r√°pida</div>
                </div>
            </div>
            
            <div class="quick-action" onclick="accionRapida('control-calidad')">
                <div class="quick-action-icon" style="background: #3b82f6;">
                    <i class="fas fa-microscope"></i>
                </div>
                <div>
                    <div style="font-weight: 600;">Control de Calidad</div>
                    <div style="font-size: 0.75rem; color: #6b7280;">An√°lisis completo</div>
                </div>
            </div>
            
            <div class="quick-action" onclick="accionRapida('reporte-diario')">
                <div class="quick-action-icon" style="background: #f59e0b;">
                    <i class="fas fa-chart-bar"></i>
                </div>
                <div>
                    <div style="font-weight: 600;">Reporte Diario</div>
                    <div style="font-size: 0.75rem; color: #6b7280;">Resumen autom√°tico</div>
                </div>
            </div>
            
            <div class="quick-action" onclick="accionRapida('planificar-cosecha')">
                <div class="quick-action-icon" style="background: #8b5cf6;">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div>
                    <div style="font-weight: 600;">Planificar Cosecha</div>
                    <div style="font-size: 0.75rem; color: #6b7280;">IA inteligente</div>
                </div>
            </div>

            <div class="quick-action" onclick="accionRapida('analizar-rendimiento')">
                <div class="quick-action-icon" style="background: #06b6d4;">
                    <i class="fas fa-analytics"></i>
                </div>
                <div>
                    <div style="font-weight: 600;">Analizar Rendimiento</div>
                    <div style="font-size: 0.75rem; color: #6b7280;">An√°lisis avanzado</div>
                </div>
            </div>

            <div class="quick-action" onclick="accionRapida('gestionar-tratamientos')">
                <div class="quick-action-icon" style="background: #ec4899;">
                    <i class="fas fa-leaf"></i>
                </div>
                <div>
                    <div style="font-weight: 600;">Tratamientos</div>
                    <div style="font-size: 0.75rem; color: #6b7280;">Gesti√≥n sanitaria</div>
                </div>
            </div>
        </section>

        <!-- Contenido principal -->
        <div class="main-content">
            <!-- Gr√°ficos -->
            <div class="graficos-container">
                <!-- Gr√°fico de producci√≥n -->
                <div class="grafico-card">
                    <div class="grafico-header">
                        <h3 class="grafico-titulo">
                            <i class="fas fa-chart-area"></i>
                            Evoluci√≥n de la Producci√≥n
                        </h3>
                        <div class="periodo-selector">
                            <button class="periodo-btn active" data-periodo="semana" onclick="cambiarPeriodoGrafico('semana')">Semana</button>
                            <button class="periodo-btn" data-periodo="mes" onclick="cambiarPeriodoGrafico('mes')">Mes</button>
                            <button class="periodo-btn" data-periodo="ano" onclick="cambiarPeriodoGrafico('a√±o')">A√±o</button>
                        </div>
                    </div>
                    <canvas id="graficoProduccion" height="300"></canvas>
                </div>
                
                <!-- Gr√°fico de rendimiento por bloque -->
                <div class="grafico-card">
                    <div class="grafico-header">
                        <h3 class="grafico-titulo">
                            <i class="fas fa-chart-bar"></i>
                            Rendimiento por Sector
                        </h3>
                    </div>
                    <canvas id="graficoRendimiento" height="250"></canvas>
                </div>

                <!-- Gr√°fico de calidad -->
                <div class="grafico-card">
                    <div class="grafico-header">
                        <h3 class="grafico-titulo">
                            <i class="fas fa-star"></i>
                            Evoluci√≥n de Calidad
                        </h3>
                    </div>
                    <canvas id="graficoCalidad" height="250"></canvas>
                </div>
            </div>

            <!-- Sidebar derecho -->
            <div>
                <!-- Timeline de actividades -->
                <div class="timeline-container">
                    <h3 style="margin-bottom: 1.5rem;">
                        <i class="fas fa-history"></i>
                        Actividades Recientes
                    </h3>
                    
                    <div id="timelineProduccion">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </div>
                </div>

                <!-- Predicciones IA -->
                <div class="predicciones-ia" style="margin-top: 2rem;">
                    <div class="ia-header">
                        <div class="ia-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <h3>Predicciones Inteligentes</h3>
                    </div>
                    
                    <div id="prediccionesIA">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal para registro r√°pido -->
    <div class="modal-overlay" id="modalRegistroRapido">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Nuevo Corte - Registro R√°pido</h2>
                <button class="modal-close" onclick="cerrarModal('modalRegistroRapido')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="formRegistroRapido" class="form-sections">
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-cut"></i>
                            Informaci√≥n de Cosecha
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Fecha</label>
                                <input type="date" class="form-input" id="fechaRapida" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">√Årbol/Sector</label>
                                <select class="form-input" id="arbolRapido" required>
                                    <option value="">Cargando opciones...</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Unidades (limones)</label>
                                <input type="number" class="form-input" id="unidadesRapida" min="0" oninput="convertirUnidadesAKg()">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Cantidad (kg)</label>
                                <input type="number" class="form-input" id="cantidadRapida" step="0.1" min="0" required oninput="convertirKgAUnidades()">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Tipo</label>
                                <select class="form-input" id="tipoRapido" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="principal">Principal</option>
                                    <option value="secundaria">Secundaria</option>
                                    <option value="extra">Extra</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                        <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalRegistroRapido')">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para registro completo -->
    <div class="modal-overlay" id="modalRegistroCompleto">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Registro Completo de Producci√≥n</h2>
                <button class="modal-close" onclick="cerrarModal('modalRegistroCompleto')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="formRegistroCompleto" class="form-sections">
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-info-circle"></i>
                            Informaci√≥n B√°sica
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Fecha de Cosecha</label>
                                <input type="datetime-local" class="form-input" id="fechaCompleta" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">√Årbol/Sector</label>
                                <select class="form-input" id="arbolCompleto" required>
                                    <option value="">Cargando opciones...</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Responsable</label>
                                <select class="form-input" id="responsableCompleto" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="juan_perez">Juan P√©rez</option>
                                    <option value="maria_gonzalez">Mar√≠a Gonz√°lez</option>
                                    <option value="carlos_lopez">Carlos L√≥pez</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Tipo de Cosecha</label>
                                <select class="form-input" id="tipoCompleto" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="principal">Principal</option>
                                    <option value="secundaria">Secundaria</option>
                                    <option value="extra">Extra</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-weight-hanging"></i>
                            Datos de Producci√≥n
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Unidades (limones)</label>
                                <input type="number" class="form-input" id="unidadesCompleta" min="0" oninput="convertirUnidadesCompletaAKg()">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Cantidad Total (kg)</label>
                                <input type="number" class="form-input" id="cantidadCompleta" step="0.1" min="0" required oninput="convertirKgCompletaAUnidades()">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Calibre Grande (%)</label>
                                <input type="number" class="form-input" id="calibreGrande" step="0.1" min="0" max="100" value="0">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Calibre Mediano (%)</label>
                                <input type="number" class="form-input" id="calibreMediano" step="0.1" min="0" max="100" value="0">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Calibre Peque√±o (%)</label>
                                <input type="number" class="form-input" id="calibrePequeno" step="0.1" min="0" max="100" value="0">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Calidad (%)</label>
                                <input type="number" class="form-input" id="calidadCompleta" step="0.1" min="0" max="100" value="85">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Merma (%)</label>
                                <input type="number" class="form-input" id="mermaCompleta" step="0.1" min="0" max="100" value="0">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-map-marker-alt"></i>
                            Ubicaci√≥n GPS
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; align-items: end;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">Latitud</label>
                                    <input type="number" class="form-input" id="latitudCompleta" step="0.0001" readonly>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Longitud</label>
                                    <input type="number" class="form-input" id="longitudCompleta" step="0.0001" readonly>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <button type="button" class="btn btn-secondary" id="btnCapturarGPS" onclick="capturarUbicacionGPS()">
                                    <i class="fas fa-location-arrow"></i> Capturar GPS
                                </button>
                            </div>
                        </div>
                        
                        <div id="gpsStatus" style="margin-top: 0.5rem; font-size: 0.75rem; color: #6b7280;">
                            Presiona 'Capturar GPS' para obtener ubicaci√≥n actual
                        </div>
                    </div>

                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-sticky-note"></i>
                            Observaciones
                        </h4>
                        
                        <div class="form-group">
                            <textarea class="form-input" id="observacionesCompletas" rows="4" 
                                      placeholder="Observaciones sobre la cosecha, condiciones clim√°ticas, estado del √°rbol, etc."></textarea>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                        <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalRegistroCompleto')">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Guardar Registro Completo
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para control de calidad -->
    <div class="modal-overlay" id="modalControlCalidad">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Control de Calidad Avanzado</h2>
                <button class="modal-close" onclick="cerrarModal('modalControlCalidad')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="formControlCalidad" class="form-sections">
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-microscope"></i>
                            Muestra de An√°lisis
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Ubicaci√≥n</label>
                                <select class="form-input" id="ubicacionCalidad" required>
                                    <option value="">Seleccionar ubicaci√≥n...</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Inspector</label>
                                <input type="text" class="form-input" id="inspectorCalidad" placeholder="Nombre del inspector">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Tama√±o de Muestra</label>
                                <input type="number" class="form-input" id="tamanoMuestra" min="1" max="100" value="20">
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                        <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalControlCalidad')">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-play"></i> Iniciar An√°lisis
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para planificaci√≥n de cosecha -->
    <div class="modal-overlay" id="modalPlanificarCosecha">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Planificaci√≥n Inteligente de Cosecha</h2>
                <button class="modal-close" onclick="cerrarModal('modalPlanificarCosecha')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="formPlanificarCosecha" class="form-sections">
                    <div class="form-section">
                        <h4 class="section-title">
                            <i class="fas fa-calendar-alt"></i>
                            Par√°metros de Planificaci√≥n
                        </h4>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Fecha Objetivo</label>
                                <input type="date" class="form-input" id="fechaObjetivo" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Duraci√≥n (d√≠as)</label>
                                <input type="number" class="form-input" id="duracionCosecha" min="1" max="30" value="7">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Prioridad</label>
                                <select class="form-input" id="prioridadCosecha">
                                    <option value="rendimiento">Maximizar Rendimiento</option>
                                    <option value="calidad">Maximizar Calidad</option>
                                    <option value="eficiencia">Maximizar Eficiencia</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Personal Disponible</label>
                                <input type="number" class="form-input" id="personalDisponible" min="1" max="20" value="5">
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem;">
                        <button type="button" class="btn btn-secondary" onclick="cerrarModal('modalPlanificarCosecha')">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-robot"></i> Generar Plan IA
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    
    <script src="/js/firebase-config.js"></script>
    <script src="/js/offline.js"></script>
    <script src="/js/auth.js"></script>
     <script src="js/finca-navigation.js"></script>
    <script src="/js/clima.js"></script>
    <script src="/js/tree-manager.js"></script>
    <script src="/js/produccion.js"></script>
    
    <script>
        // Variables globales
        let graficoProduccion, graficoRendimiento, graficoCalidad;
        let productionSystemReady = false;

        // INICIALIZACI√ìN PRINCIPAL
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Iniciando aplicaci√≥n de producci√≥n completa...');
            
            try {
                updateIntegrationStatus('loading', 'Inicializando sistema...');
                
                // Verificar autenticaci√≥n
                const authenticated = await verifyAuthentication();
                if (!authenticated) {
                    window.location.href = '/login.html';
                    return;
                }

                // Esperar managers
                await waitForSystemManagers();
                
                // Configurar eventos
                setupEventListeners();
                
                // Inicializar gr√°ficos
                await initializeCharts();
                
                // Cargar datos iniciales
                await loadInitialData();
                
                // Configurar fecha actual
                setCurrentDate();
                
                productionSystemReady = true;
                updateIntegrationStatus('connected', 'Sistema listo');
                
                console.log('‚úÖ Sistema de producci√≥n completo inicializado');
                
            } catch (error) {
                console.error('‚ùå Error inicializando:', error);
                updateIntegrationStatus('error', 'Error en inicializaci√≥n');
                showNotification('Error inicializando el sistema', 'error');
            }
        });

        // VERIFICACI√ìN DE AUTENTICACI√ìN
        async function verifyAuthentication() {
            return new Promise((resolve) => {
                let attempts = 0;
                const checkAuth = () => {
                    if (window.authManager?.isAuthenticated || 
                        window.firebase?.auth?.()?.currentUser) {
                        resolve(true);
                        return;
                    }
                    
                    attempts++;
                    if (attempts < 30) {
                        setTimeout(checkAuth, 100);
                    } else {
                        resolve(true); // Permitir acceso en modo demo
                    }
                };
                checkAuth();
            });
        }

        // ESPERAR MANAGERS DEL SISTEMA
        async function waitForSystemManagers() {
            const managers = [
                { name: 'treeManager', timeout: 5000 },
                { name: 'productionManager', timeout: 8000 },
                { name: 'climateManager', timeout: 3000 }
            ];
            
            for (const manager of managers) {
                try {
                    await waitForManager(manager.name, manager.timeout);
                    console.log(`‚úÖ ${manager.name} cargado`);
                } catch (error) {
                    console.warn(`‚ö†Ô∏è ${manager.name} no disponible:`, error);
                }
            }
        }

        function waitForManager(managerName, timeout = 5000) {
            return new Promise((resolve, reject) => {
                const timeoutId = setTimeout(() => {
                    reject(new Error(`Timeout esperando ${managerName}`));
                }, timeout);
                
                const checkManager = () => {
                    if (window[managerName]) {
                        clearTimeout(timeoutId);
                        resolve(window[managerName]);
                    }
                };
                
                if (window[managerName]) {
                    clearTimeout(timeoutId);
                    resolve(window[managerName]);
                    return;
                }
                
                // Verificar cada 100ms
                const interval = setInterval(() => {
                    if (window[managerName]) {
                        clearInterval(interval);
                        clearTimeout(timeoutId);
                        resolve(window[managerName]);
                    }
                }, 100);
                
                // Cleanup en timeout
                setTimeout(() => clearInterval(interval), timeout);
            });
        }

        // CONFIGURAR EVENT LISTENERS
        function setupEventListeners() {
            // Botones principales
            const btnNuevoCorte = document.getElementById('btnNuevoCorte');
            const btnNuevoRegistro = document.getElementById('btnNuevoRegistro');
            const btnExportarDatos = document.getElementById('btnExportarDatos');
            
            if (btnNuevoCorte) btnNuevoCorte.addEventListener('click', () => accionRapida('nuevo-corte'));
            if (btnNuevoRegistro) btnNuevoRegistro.addEventListener('click', window.abrirRegistroCompleto);
            if (btnExportarDatos) btnExportarDatos.addEventListener('click', exportarDatos);
            
            // Formularios
            setupFormListeners();
            
            // Eventos del sistema
            window.addEventListener('productionManagerReady', handleProductionManagerReady);
            window.addEventListener('treeUpdate', handleTreeUpdate);
            window.addEventListener('qualityControlCompleted', handleQualityControlCompleted);
            window.addEventListener('harvestPlanReady', handleHarvestPlanReady);
            
            console.log('‚úÖ Event listeners configurados');
        }

        function setupFormListeners() {
            // Formulario registro r√°pido
            const formRapido = document.getElementById('formRegistroRapido');
            if (formRapido) {
                formRapido.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await procesarRegistroRapido(e);
                });
            }
            
            // Formulario control de calidad
            const formCalidad = document.getElementById('formControlCalidad');
            if (formCalidad) {
                formCalidad.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await procesarControlCalidad(e);
                });
            }
            
            // Formulario planificaci√≥n
            const formPlanificacion = document.getElementById('formPlanificarCosecha');
            if (formPlanificacion) {
                formPlanificacion.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await procesarPlanificacionCosecha(e);
                });
            }
        }

        // INICIALIZAR GR√ÅFICOS
        async function initializeCharts() {
            try {
                // Gr√°fico de producci√≥n
                const ctxProd = document.getElementById('graficoProduccion');
                if (ctxProd) {
                    graficoProduccion = new Chart(ctxProd, {
                        type: 'line',
                        data: {
                            labels: ['Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b', 'Dom'],
                            datasets: [{
                                label: 'Producci√≥n (kg)',
                                data: [0, 0, 0, 0, 0, 0, 0],
                                borderColor: '#16a34a',
                                backgroundColor: 'rgba(22, 163, 74, 0.1)',
                                tension: 0.4,
                                fill: true
                            }, {
                                label: 'Predicci√≥n (kg)',
                                data: [0, 0, 0, 0, 0, 0, 0],
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderDash: [5, 5],
                                tension: 0.4
                            }]
                        },
                        options: getChartOptions()
                    });
                }

                // Gr√°fico de rendimiento
                const ctxRend = document.getElementById('graficoRendimiento');
                if (ctxRend) {
                    graficoRendimiento = new Chart(ctxRend, {
                        type: 'bar',
                        data: {
                            labels: ['Cargando...'],
                            datasets: [{
                                label: 'Rendimiento (kg)',
                                data: [0],
                                backgroundColor: 'rgba(59, 130, 246, 0.6)',
                                borderColor: '#3b82f6',
                                borderWidth: 1
                            }]
                        },
                        options: getChartOptions()
                    });
                }

                // Gr√°fico de calidad
                const ctxCalidad = document.getElementById('graficoCalidad');
                if (ctxCalidad) {
                    graficoCalidad = new Chart(ctxCalidad, {
                        type: 'doughnut',
                        data: {
                            labels: ['AAA', 'AA', 'A', 'B', 'C'],
                            datasets: [{
                                data: [0, 0, 0, 0, 0],
                                backgroundColor: [
                                    '#22c55e',
                                    '#3b82f6', 
                                    '#f59e0b',
                                    '#ef4444',
                                    '#6b7280'
                                ]
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { color: '#374151' }
                                }
                            }
                        }
                    });
                }
                
                console.log('‚úÖ Gr√°ficos inicializados');
                
            } catch (error) {
                console.error('‚ùå Error inicializando gr√°ficos:', error);
            }
        }

        function getChartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { 
                        labels: { color: '#374151' } 
                    } 
                },
                scales: {
                    x: { 
                        ticks: { color: '#6b7280' }, 
                        grid: { color: 'rgba(107, 114, 128, 0.2)' } 
                    },
                    y: { 
                        ticks: { color: '#6b7280' }, 
                        grid: { color: 'rgba(107, 114, 128, 0.2)' } 
                    }
                }
            };
        }

        // CARGAR DATOS INICIALES
        async function loadInitialData() {
            try {
                // Cargar opciones de formularios
                await updateFormOptions();
                
                // Actualizar KPIs
                await updateKPIs();
                
                // Actualizar timeline
                await updateTimeline();
                
                // Generar predicciones
                await updatePredictions();
                
                // Actualizar gr√°ficos
                await updateCharts('semana');
                
                console.log('‚úÖ Datos iniciales cargados');
                
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                loadFallbackData();
            }
        }

        async function updateFormOptions() {
            try {
                if (window.productionManager) {
                    const opciones = await window.productionManager.getOpcionesFormulario();
                    
                    // Actualizar select de registro r√°pido
                    const selectRapido = document.getElementById('arbolRapido');
                    if (selectRapido && opciones.opciones) {
                        selectRapido.innerHTML = '<option value="">Seleccionar...</option>';
                        opciones.opciones.forEach(opcion => {
                            const opt = document.createElement('option');
                            opt.value = opcion.value;
                            opt.textContent = opcion.label;
                            selectRapido.appendChild(opt);
                        });
                    }
                    
                    // Actualizar select de control de calidad
                    const selectCalidad = document.getElementById('ubicacionCalidad');
                    if (selectCalidad && opciones.opciones) {
                        selectCalidad.innerHTML = '<option value="">Seleccionar ubicaci√≥n...</option>';
                        opciones.opciones.forEach(opcion => {
                            const opt = document.createElement('option');
                            opt.value = opcion.value;
                            opt.textContent = opcion.label;
                            selectCalidad.appendChild(opt);
                        });
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Error actualizando opciones:', error);
            }
        }

        async function updateKPIs() {
            try {
                if (window.productionManager) {
                    const kpis = window.productionManager.calcularKPIs();
                    
                    document.getElementById('produccionMes').textContent = `${kpis.produccionMes.toLocaleString()} kg`;
                    document.getElementById('rendimientoPromedio').textContent = `${kpis.rendimientoPromedio} kg/√°rbol`;
                    document.getElementById('calidadPromedio').textContent = `${kpis.calidadPromedio}%`;
                    document.getElementById('ingresosMes').textContent = `Q ${kpis.ingresosMes.toLocaleString()}`;
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Error actualizando KPIs:', error);
                loadFallbackKPIs();
            }
        }

        async function updateTimeline() {
            const container = document.getElementById('timelineProduccion');
            if (!container) return;
            
            try {
                if (window.productionManager) {
                    const actividades = window.productionManager.obtenerActividadesRecientes();
                    
                    if (actividades.length > 0) {
                        container.innerHTML = actividades.map(actividad => `
                            <div class="timeline-item">
                                <div class="timeline-fecha">${formatDate(actividad.fecha)}</div>
                                <div class="timeline-contenido">
                                    <strong>${actividad.descripcion}</strong>
                                    <div class="timeline-cantidad">${actividad.cantidad} kg</div>
                                    <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">
                                        ${actividad.detalles}
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        container.innerHTML = '<p style="text-align: center; color: #6b7280;">No hay actividades recientes</p>';
                    }
                } else {
                    loadFallbackTimeline();
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Error actualizando timeline:', error);
                loadFallbackTimeline();
            }
        }

        async function updatePredictions() {
            const container = document.getElementById('prediccionesIA');
            if (!container) return;
            
            try {
                if (window.productionManager) {
                    const predicciones = await window.productionManager.generarPrediccionesIA();
                    
                    container.innerHTML = predicciones.map(pred => `
                        <div class="prediccion-item">
                            <div class="prediccion-titulo">${pred.titulo}</div>
                            <div class="prediccion-valor" style="color: ${pred.color};">
                                ${pred.valor}
                            </div>
                            <div class="prediccion-confianza">
                                Confianza: ${pred.confianza}% | ${pred.descripcion}
                            </div>
                        </div>
                    `).join('');
                } else {
                    loadFallbackPredictions();
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Error actualizando predicciones:', error);
                loadFallbackPredictions();
            }
        }

        async function updateCharts(periodo) {
            try {
                if (window.productionManager) {
                    const datos = await window.productionManager.obtenerDatosGraficos(periodo);
                    
                    // Actualizar gr√°fico de producci√≥n
                    if (graficoProduccion && datos.labels) {
                        graficoProduccion.data.labels = datos.labels;
                        graficoProduccion.data.datasets[0].data = datos.produccion;
                        if (datos.prediccion) {
                            graficoProduccion.data.datasets[1].data = datos.prediccion;
                        }
                        graficoProduccion.update();
                    }
                    
                    // Actualizar gr√°fico de rendimiento
                    if (graficoRendimiento && datos.bloquesLabels) {
                        graficoRendimiento.data.labels = datos.bloquesLabels;
                        graficoRendimiento.data.datasets[0].data = datos.rendimiento;
                        graficoRendimiento.update();
                    }
                    
                    // Actualizar gr√°fico de calidad
                    if (graficoCalidad && datos.calidad) {
                        graficoCalidad.data.datasets[0].data = datos.calidad;
                        graficoCalidad.update();
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Error actualizando gr√°ficos:', error);
            }
        }

        // FUNCIONES DE CONVERSI√ìN DE UNIDADES
        function convertirUnidadesAKg() {
            const unidades = parseFloat(document.getElementById('unidadesRapida').value) || 0;
            const kg = unidades / 7; // 7 limones ‚âà 1 kg (peso real ~140g por lim√≥n)
            document.getElementById('cantidadRapida').value = kg > 0 ? kg.toFixed(2) : '';
        }

        function convertirKgAUnidades() {
            const kg = parseFloat(document.getElementById('cantidadRapida').value) || 0;
            const unidades = Math.round(kg * 7); // 1 kg ‚âà 7 limones (peso real ~140g por lim√≥n)
            document.getElementById('unidadesRapida').value = unidades > 0 ? unidades : '';
        }
        
        function convertirUnidadesCompletaAKg() {
            const unidades = parseFloat(document.getElementById('unidadesCompleta').value) || 0;
            const kg = unidades / 7; // 7 limones ‚âà 1 kg (peso real ~140g por lim√≥n)
            document.getElementById('cantidadCompleta').value = kg > 0 ? kg.toFixed(2) : '';
        }

        function convertirKgCompletaAUnidades() {
            const kg = parseFloat(document.getElementById('cantidadCompleta').value) || 0;
            const unidades = Math.round(kg * 7); // 1 kg ‚âà 7 limones (peso real ~140g por lim√≥n)
            document.getElementById('unidadesCompleta').value = unidades > 0 ? unidades : '';
        }

        // CAPTURAR GPS
        async function capturarUbicacionGPS() {
            const statusEl = document.getElementById('gpsStatus');
            const latEl = document.getElementById('latitudCompleta');
            const lngEl = document.getElementById('longitudCompleta');
            const btnEl = document.getElementById('btnCapturarGPS');
            
            if (!navigator.geolocation) {
                statusEl.textContent = 'GPS no disponible en este navegador';
                statusEl.style.color = '#ef4444';
                return;
            }
            
            statusEl.textContent = 'Obteniendo ubicaci√≥n GPS...';
            statusEl.style.color = '#3b82f6';
            btnEl.disabled = true;
            btnEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Obteniendo...';
            
            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        resolve,
                        reject,
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 60000
                        }
                    );
                });
                
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                const accuracy = position.coords.accuracy;
                
                latEl.value = lat.toFixed(6);
                lngEl.value = lng.toFixed(6);
                
                statusEl.textContent = `Ubicaci√≥n obtenida (¬±${Math.round(accuracy)}m de precisi√≥n)`;
                statusEl.style.color = '#16a34a';
                
                showNotification('Ubicaci√≥n GPS capturada correctamente', 'success');
                
            } catch (error) {
                console.error('Error obteniendo GPS:', error);
                statusEl.textContent = `Error: ${error.message}`;
                statusEl.style.color = '#ef4444';
                showNotification('Error obteniendo ubicaci√≥n GPS', 'error');
            } finally {
                btnEl.disabled = false;
                btnEl.innerHTML = '<i class="fas fa-location-arrow"></i> Capturar GPS';
            }
        }

        // FUNCI√ìN MEJORADA SIN DUPLICADOS Y CON NOMBRES LEGIBLES
        async function updateFormOptions() {
            console.log('üîÑ Actualizando opciones de formularios...');
            
            try {
                let opciones = [];
                const opcionesUnicas = new Set(); // Para evitar duplicados
                
                // M√©todo 1: Intentar directamente con treeManager
                if (window.treeManager) {
                    try {
                        const sectores = await window.treeManager.getAllSectors();
                        const arboles = await window.treeManager.getAllTrees();
                        
                        console.log('üì¶ Sectores encontrados:', sectores.length);
                        console.log('üå≥ √Årboles encontrados:', arboles.length);
                        
                        // Agregar sectores primero con nombres legibles
                        sectores.forEach(sector => {
                            const opcionId = `sector_${sector.id}`;
                            if (!opcionesUnicas.has(opcionId)) {
                                opcionesUnicas.add(opcionId);
                                opciones.push({
                                    value: sector.id,
                                    label: `üì¶ ${sector.name} (Sector completo)`,
                                    type: 'sector'
                                });
                            }
                        });
                        
                        // Agregar √°rboles sin duplicados
                        const arbolesUnicos = new Map();
                        arboles.forEach(arbol => {
                            if (arbol.active !== false && !arbolesUnicos.has(arbol.id)) {
                                arbolesUnicos.set(arbol.id, arbol);
                            }
                        });
                        
                        arbolesUnicos.forEach(arbol => {
                            // Obtener nombre del sector
                            const sector = sectores.find(s => s.id === arbol.blockId);
                            const nombreSector = sector ? sector.name : 'Sin sector';
                            
                            opciones.push({
                                value: arbol.id,
                                label: `üå≥ √Årbol ${arbol.correlative || arbol.id.substring(0, 8)} - ${nombreSector}`,
                                type: 'tree'
                            });
                        });
                        
                        console.log('‚úÖ Opciones cargadas desde treeManager:', opciones.length);
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Error con treeManager:', error);
                    }
                }
                
                // M√©todo 2: Intentar con productionManager como fallback
                if (opciones.length === 0 && window.productionManager && window.productionManager.getOpcionesFormulario) {
                    try {
                        const resultado = await window.productionManager.getOpcionesFormulario();
                        if (resultado && resultado.opciones) {
                            opciones = resultado.opciones.map(opcion => ({
                                ...opcion,
                                label: opcion.type === 'sector' ? `üì¶ ${opcion.label}` : `üå≥ ${opcion.label}`
                            }));
                            console.log('‚úÖ Opciones cargadas desde productionManager:', opciones.length);
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Error con productionManager:', error);
                    }
                }
                
                // M√©todo 3: Fallback con opciones de ejemplo
                if (opciones.length === 0) {
                    opciones = [
                        { value: 'SECTOR_NORTE', label: 'üì¶ Sector Norte (Sector completo)', type: 'sector' },
                        { value: 'SECTOR_SUR', label: 'üì¶ Sector Sur (Sector completo)', type: 'sector' },
                        { value: 'SECTOR_ESTE', label: 'üì¶ Sector Este (Sector completo)', type: 'sector' },
                        { value: 'ARBOL_001', label: 'üå≥ √Årbol 001 - Sector Norte', type: 'tree' },
                        { value: 'ARBOL_002', label: 'üå≥ √Årbol 002 - Sector Sur', type: 'tree' },
                        { value: 'ARBOL_003', label: 'üå≥ √Årbol 003 - Sector Este', type: 'tree' }
                    ];
                    console.log('‚ö†Ô∏è Usando opciones de fallback');
                }
                
                // Ordenar opciones: sectores primero, luego √°rboles
                opciones.sort((a, b) => {
                    if (a.type === 'sector' && b.type === 'tree') return -1;
                    if (a.type === 'tree' && b.type === 'sector') return 1;
                    return a.label.localeCompare(b.label);
                });
                
                // Actualizar todos los selects
                const selects = [
                    { id: 'arbolRapido', placeholder: 'Seleccionar ubicaci√≥n...' },
                    { id: 'arbolCompleto', placeholder: 'Seleccionar ubicaci√≥n...' },
                    { id: 'ubicacionCalidad', placeholder: 'Seleccionar ubicaci√≥n para an√°lisis...' }
                ];
                
                selects.forEach(selectConfig => {
                    const select = document.getElementById(selectConfig.id);
                    if (select) {
                        const valorActual = select.value;
                        select.innerHTML = `<option value="">${selectConfig.placeholder}</option>`;
                        
                        opciones.forEach(opcion => {
                            const option = document.createElement('option');
                            option.value = opcion.value;
                            option.textContent = opcion.label;
                            select.appendChild(option);
                        });
                        
                        // Restaurar valor si exist√≠a y sigue siendo v√°lido
                        if (valorActual && opciones.some(opt => opt.value === valorActual)) {
                            select.value = valorActual;
                        }
                        
                        console.log(`‚úÖ Select ${selectConfig.id} actualizado con ${opciones.length} opciones`);
                    }
                });
                
                if (opciones.length > 0) {
                    showNotification(`${opciones.length} ubicaciones cargadas correctamente`, 'success');
                }
                
            } catch (error) {
                console.error('‚ùå Error actualizando opciones:', error);
                showNotification('Error cargando opciones de ubicaciones', 'warning');
            }
        }

        // FUNCI√ìN CORREGIDA DE ACCI√ìN R√ÅPIDA 
        async function accionRapida(accion) {
            switch (accion) {
                case 'nuevo-corte':
                    document.getElementById('modalRegistroRapido').classList.add('show');
                    break;
                    
                case 'registro-completo':
                    // CORREGIDO: Abrir el modal del registro completo
                    document.getElementById('modalRegistroCompleto').classList.add('show');
                    
                    // Establecer fecha y hora actual
                    const ahora = new Date();
                    const fechaHora = ahora.toISOString().slice(0, 16);
                    const fechaCompletaInput = document.getElementById('fechaCompleta');
                    if (fechaCompletaInput) {
                        fechaCompletaInput.value = fechaHora;
                    }
                    
                    // Asegurar que las opciones est√©n cargadas
                    await updateFormOptions();
                    
                    showNotification('Formulario de registro completo abierto', 'info');
                    break;
                    
                case 'control-calidad':
                    document.getElementById('modalControlCalidad').classList.add('show');
                    await updateFormOptions(); // Asegurar opciones cargadas
                    break;
                    
                case 'planificar-cosecha':
                    document.getElementById('modalPlanificarCosecha').classList.add('show');
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    document.getElementById('fechaObjetivo').value = tomorrow.toISOString().split('T')[0];
                    break;
                    
                case 'reporte-diario':
                    await generarReporteDiario();
                    break;
                    
                case 'analizar-rendimiento':
                    await analizarRendimiento();
                    break;
                    
                case 'gestionar-tratamientos':
                    await gestionarTratamientos();
                    break;
                    
                default:
                    showNotification(`Funci√≥n ${accion} disponible`, 'info');
            }
        }

        // CONFIGURAR LISTENERS DE FORMULARIOS MEJORADO
        function setupEventListeners() {
            // Botones principales
            const btnNuevoCorte = document.getElementById('btnNuevoCorte');
            const btnNuevoRegistro = document.getElementById('btnNuevoRegistro');
            const btnExportarDatos = document.getElementById('btnExportarDatos');
            
            if (btnNuevoCorte) btnNuevoCorte.addEventListener('click', () => accionRapida('nuevo-corte'));
            if (btnNuevoRegistro) btnNuevoRegistro.addEventListener('click', () => accionRapida('registro-completo')); // CORREGIDO
            if (btnExportarDatos) btnExportarDatos.addEventListener('click', exportarDatos);
            
            // Formularios
            setupFormListeners();
            
            // Eventos del sistema
            window.addEventListener('productionManagerReady', handleProductionManagerReady);
            window.addEventListener('treeUpdate', handleTreeUpdate);
            window.addEventListener('qualityControlCompleted', handleQualityControlCompleted);
            window.addEventListener('harvestPlanReady', handleHarvestPlanReady);
            
            console.log('‚úÖ Event listeners configurados');
        }

        // AGREGAR PROCESAMIENTO DEL FORMULARIO COMPLETO
        function setupFormListeners() {
            // Formulario registro r√°pido
            const formRapido = document.getElementById('formRegistroRapido');
            if (formRapido) {
                formRapido.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await procesarRegistroRapido(e);
                });
            }
            
            // Formulario registro completo
            const formCompleto = document.getElementById('formRegistroCompleto');
            if (formCompleto) {
                formCompleto.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await procesarRegistroCompleto(e);
                });
            }
            
            // Formulario control de calidad
            const formCalidad = document.getElementById('formControlCalidad');
            if (formCalidad) {
                formCalidad.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await procesarControlCalidad(e);
                });
            }
            
            // Formulario planificaci√≥n
            const formPlanificacion = document.getElementById('formPlanificarCosecha');
            if (formPlanificacion) {
                formPlanificacion.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    await procesarPlanificacionCosecha(e);
                });
            }
        }

        // PROCESAMIENTO MEJORADO DEL REGISTRO COMPLETO
        async function procesarRegistroCompleto(event) {
            try {
                showNotification('Procesando registro completo...', 'info');
                
                // Recopilar todos los datos del formulario
                const datos = {
                    fecha: document.getElementById('fechaCompleta').value,
                    arbolId: document.getElementById('arbolCompleto').value,
                    responsable: document.getElementById('responsableCompleto').value,
                    tipo: document.getElementById('tipoCompleto').value,
                    unidades: parseInt(document.getElementById('unidadesCompleta').value) || 0,
                    cantidad: parseFloat(document.getElementById('cantidadCompleta').value) || 0,
                    calibres: {
                        grande: parseFloat(document.getElementById('calibreGrande').value) || 0,
                        mediano: parseFloat(document.getElementById('calibreMediano').value) || 0,
                        pequeno: parseFloat(document.getElementById('calibrePequeno').value) || 0
                    },
                    calidad: parseFloat(document.getElementById('calidadCompleta').value) || 85,
                    merma: parseFloat(document.getElementById('mermaCompleta').value) || 0,
                    ubicacion: {
                        lat: parseFloat(document.getElementById('latitudCompleta').value) || null,
                        lng: parseFloat(document.getElementById('longitudCompleta').value) || null
                    },
                    observaciones: document.getElementById('observacionesCompletas').value || ''
                };
                
                console.log('üìã Datos del formulario completo:', datos);
                
                // VALIDACIONES DETALLADAS
                const errores = [];
                
                if (!datos.fecha) {
                    errores.push('La fecha es obligatoria');
                }
                
                if (!datos.arbolId) {
                    errores.push('Debe seleccionar un √°rbol o sector');
                }
                
                if (!datos.responsable) {
                    errores.push('Debe seleccionar un responsable');
                }
                
                if (!datos.tipo) {
                    errores.push('Debe seleccionar el tipo de cosecha');
                }
                
                if (datos.cantidad <= 0) {
                    errores.push('La cantidad debe ser mayor a 0 kg');
                }
                
                if (datos.calidad < 0 || datos.calidad > 100) {
                    errores.push('La calidad debe estar entre 0% y 100%');
                }
                
                if (datos.merma < 0 || datos.merma > 100) {
                    errores.push('La merma debe estar entre 0% y 100%');
                }
                
                // Validar calibres si est√°n especificados
                const totalCalibre = datos.calibres.grande + datos.calibres.mediano + datos.calibres.pequeno;
                if (totalCalibre > 0 && Math.abs(totalCalibre - 100) > 0.1) {
                    errores.push('Los calibres deben sumar exactamente 100%');
                }
                
                // Mostrar errores si los hay
                if (errores.length > 0) {
                    showNotification(`Errores en el formulario:\n‚Ä¢ ${errores.join('\n‚Ä¢ ')}`, 'error');
                    return;
                }
                
                // PROCESAR EL REGISTRO
                showNotification('Guardando registro completo...', 'info');
                
                if (window.productionManager && window.productionManager.registrarProduccionCompleta) {
                    try {
                        const resultado = await window.productionManager.registrarProduccionCompleta(datos);
                        
                        showNotification('‚úÖ Registro completo guardado exitosamente', 'success');
                        console.log('‚úÖ Resultado del registro completo:', resultado);
                        
                        // Mostrar resumen del registro
                        const resumen = `
Registro guardado exitosamente:
‚Ä¢ Cantidad: ${datos.cantidad} kg (${datos.unidades} unidades)
‚Ä¢ Ubicaci√≥n: ${getSelectedLocationName()}
‚Ä¢ Responsable: ${getResponsableName(datos.responsable)}
‚Ä¢ Tipo: ${datos.tipo}
‚Ä¢ Calidad: ${datos.calidad}%
${datos.ubicacion.lat ? `‚Ä¢ GPS: ${datos.ubicacion.lat.toFixed(4)}, ${datos.ubicacion.lng.toFixed(4)}` : ''}
                        `;
                        
                        alert(resumen.trim());
                        
                    } catch (error) {
                        console.error('‚ùå Error en productionManager:', error);
                        showNotification('Error guardando en el sistema: ' + error.message, 'error');
                        return;
                    }
                } else {
                    // Modo demo - simular guardado exitoso
                    showNotification('‚úÖ Registro completo guardado (modo demo)', 'success');
                    console.log('üìù Registro completo (modo demo):', datos);
                }
                
                // ACTUALIZAR LA INTERFAZ
                try {
                    await Promise.all([
                        updateKPIs(),
                        updateTimeline(), 
                        updateCharts('semana'),
                        updatePredictions()
                    ]);
                    console.log('‚úÖ Interfaz actualizada despu√©s del registro');
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error actualizando interfaz:', error);
                }
                
                // CERRAR MODAL Y LIMPIAR FORMULARIO
                cerrarModal('modalRegistroCompleto');
                document.getElementById('formRegistroCompleto').reset();
                
                // Limpiar campos GPS
                document.getElementById('latitudCompleta').value = '';
                document.getElementById('longitudCompleta').value = '';
                document.getElementById('gpsStatus').textContent = 'Presiona \'Capturar GPS\' para obtener ubicaci√≥n actual';
                document.getElementById('gpsStatus').style.color = '#6b7280';
                
                console.log('‚úÖ Registro completo procesado exitosamente');
                
            } catch (error) {
                console.error('‚ùå Error procesando registro completo:', error);
                showNotification('Error procesando el registro: ' + error.message, 'error');
            }
        }
        
        // FUNCIONES AUXILIARES PARA EL REGISTRO COMPLETO
        function getSelectedLocationName() {
            const select = document.getElementById('arbolCompleto');
            return select.selectedOptions[0]?.textContent || 'Ubicaci√≥n no especificada';
        }
        
        function getResponsableName(responsableId) {
            const responsables = {
                'juan_perez': 'Juan P√©rez',
                'maria_gonzalez': 'Mar√≠a Gonz√°lez', 
                'carlos_lopez': 'Carlos L√≥pez'
            };
            return responsables[responsableId] || responsableId;
        }

        // CARGAR DATOS CON MEJOR MANEJO DE ERRORES  
        async function loadInitialData() {
            console.log('üîÑ Cargando datos iniciales...');
            
            try {
                // Cargar opciones de formularios primero
                await updateFormOptions();
                
                // Esperar un poco para que los managers est√©n listos
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Actualizar opciones nuevamente despu√©s del delay
                await updateFormOptions();
                
                // Actualizar KPIs
                await updateKPIs();
                
                // Actualizar timeline
                await updateTimeline();
                
                // Generar predicciones
                await updatePredictions();
                
                // Actualizar gr√°ficos
                await updateCharts('semana');
                
                console.log('‚úÖ Datos iniciales cargados correctamente');
                
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
                loadFallbackData();
                
                // Reintentar cargar opciones cada 2 segundos hasta 5 veces
                let reintentos = 0;
                const intervalo = setInterval(async () => {
                    reintentos++;
                    console.log(`üîÑ Reintento ${reintentos}/5 cargando opciones...`);
                    
                    try {
                        await updateFormOptions();
                        
                        // Si se cargaron opciones, detener reintentos
                        const select = document.getElementById('arbolRapido');
                        if (select && select.options.length > 1) {
                            clearInterval(intervalo);
                            console.log('‚úÖ Opciones cargadas en reintento');
                            showNotification('Opciones de ubicaciones cargadas', 'success');
                        }
                    } catch (error) {
                        console.warn(`‚ö†Ô∏è Error en reintento ${reintentos}:`, error);
                    }
                    
                    if (reintentos >= 5) {
                        clearInterval(intervalo);
                        console.warn('‚ö†Ô∏è M√°ximo de reintentos alcanzado');
                    }
                }, 2000);
            }
        }

        async function procesarControlCalidad(event) {
            try {
                const datos = {
                    location: document.getElementById('ubicacionCalidad').value,
                    inspector: document.getElementById('inspectorCalidad').value,
                    samples: [{
                        size: parseInt(document.getElementById('tamanoMuestra').value)
                    }]
                };
                
                if (!datos.location) {
                    showNotification('Selecciona una ubicaci√≥n', 'warning');
                    return;
                }
                
                showNotification('Iniciando an√°lisis de calidad...', 'info');
                
                if (window.productionManager && window.productionManager.controlCalidad) {
                    const resultado = await window.productionManager.controlCalidad(datos);
                    
                    showNotification(`Control de calidad completado - Grado: ${resultado.overall.grade}`, 'success');
                    
                    // Mostrar resultados detallados
                    mostrarResultadosCalidad(resultado);
                } else {
                    showNotification('An√°lisis de calidad completado (modo demo)', 'success');
                    mostrarResultadosCalidadDemo();
                }
                
                cerrarModal('modalControlCalidad');
                
            } catch (error) {
                console.error('‚ùå Error en control de calidad:', error);
                showNotification('Error en an√°lisis: ' + error.message, 'error');
            }
        }

        async function procesarPlanificacionCosecha(event) {
            try {
                const parametros = {
                    fechaObjetivo: document.getElementById('fechaObjetivo').value,
                    duracion: parseInt(document.getElementById('duracionCosecha').value),
                    prioridad: document.getElementById('prioridadCosecha').value,
                    personal: parseInt(document.getElementById('personalDisponible').value)
                };
                
                showNotification('Generando plan inteligente...', 'info');
                
                if (window.productionManager && window.productionManager.planificarCosecha) {
                    const plan = await window.productionManager.planificarCosecha(parametros);
                    
                    showNotification('Plan de cosecha generado exitosamente', 'success');
                    mostrarPlanCosecha(plan);
                } else {
                    showNotification('Plan de cosecha generado (modo demo)', 'success');
                    mostrarPlanCosechaDemo(parametros);
                }
                
                cerrarModal('modalPlanificarCosecha');
                
            } catch (error) {
                console.error('‚ùå Error generando plan:', error);
                showNotification('Error generando plan: ' + error.message, 'error');
            }
        }

        // ACCIONES R√ÅPIDAS
        async function accionRapida(accion) {
            switch (accion) {
                case 'nuevo-corte':
                    document.getElementById('modalRegistroRapido').classList.add('show');
                    break;
                    
                case 'control-calidad':
                    document.getElementById('modalControlCalidad').classList.add('show');
                    break;
                    
                case 'planificar-cosecha':
                    document.getElementById('modalPlanificarCosecha').classList.add('show');
                    // Establecer fecha por defecto
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    document.getElementById('fechaObjetivo').value = tomorrow.toISOString().split('T')[0];
                    break;
                    
                case 'reporte-diario':
                    await generarReporteDiario();
                    break;
                    
                case 'analizar-rendimiento':
                    await analizarRendimiento();
                    break;
                    
                case 'gestionar-tratamientos':
                    await gestionarTratamientos();
                    break;
                    
                case 'registro-completo':
                    showNotification('Funci√≥n de registro completo en desarrollo', 'info');
                    break;
                    
                default:
                    showNotification(`Funci√≥n ${accion} en desarrollo`, 'info');
            }
        }

        async function generarReporteDiario() {
            try {
                showNotification('Generando reporte diario...', 'info');
                
                if (window.productionManager && window.productionManager.generarReporteDiario) {
                    const reporte = window.productionManager.generarReporteDiario();
                    showNotification(`Reporte generado: ${reporte.totalProduccion}kg cosechados hoy`, 'success');
                } else {
                    showNotification('Reporte diario generado (modo demo)', 'info');
                }
            } catch (error) {
                showNotification('Error generando reporte: ' + error.message, 'error');
            }
        }

        async function analizarRendimiento() {
            try {
                showNotification('Analizando rendimiento avanzado...', 'info');
                
                if (window.productionManager && window.productionManager.analizarRendimiento) {
                    const analisis = await window.productionManager.analizarRendimiento({
                        period: 'last_month',
                        scope: 'farm'
                    });
                    
                    showNotification('An√°lisis de rendimiento completado', 'success');
                    mostrarAnalisisRendimiento(analisis);
                } else {
                    showNotification('An√°lisis de rendimiento completado (modo demo)', 'success');
                }
            } catch (error) {
                showNotification('Error en an√°lisis: ' + error.message, 'error');
            }
        }

        async function gestionarTratamientos() {
            try {
                showNotification('Abriendo gesti√≥n de tratamientos...', 'info');
                
                // Aqu√≠ se abrir√≠a un modal completo para gesti√≥n de tratamientos
                // Por ahora mostramos una notificaci√≥n
                if (window.productionManager && window.productionManager.gestionarTratamientos) {
                    showNotification('Sistema de tratamientos disponible', 'success');
                } else {
                    showNotification('Sistema de tratamientos (modo demo)', 'info');
                }
            } catch (error) {
                showNotification('Error accediendo a tratamientos: ' + error.message, 'error');
            }
        }

        // FUNCIONES DE INTERFAZ
        function cambiarPeriodoGrafico(periodo) {
            // Actualizar botones activos
            document.querySelectorAll('.periodo-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-periodo="${periodo}"]`).classList.add('active');
            
            // Actualizar gr√°ficos
            updateCharts(periodo);
        }

        function cerrarModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function setCurrentDate() {
            const hoy = new Date().toISOString().split('T')[0];
            const fechaRapida = document.getElementById('fechaRapida');
            if (fechaRapida) fechaRapida.value = hoy;
        }

        function updateIntegrationStatus(status, message) {
            const statusEl = document.getElementById('integrationStatus');
            if (statusEl) {
                statusEl.className = `integration-status ${status}`;
                statusEl.innerHTML = status === 'loading' ? 
                    `<i class="fas fa-sync fa-spin"></i> ${message}` : 
                    status === 'error' ?
                    `<i class="fas fa-exclamation-triangle"></i> ${message}` :
                    `<i class="fas fa-check"></i> ${message}`;
                
                if (status === 'connected') {
                    setTimeout(() => {
                        statusEl.style.opacity = '0';
                        setTimeout(() => statusEl.style.display = 'none', 300);
                    }, 3000);
                }
            }
        }

        function showNotification(mensaje, tipo = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${tipo}`;
            notification.textContent = mensaje;
            
            document.body.appendChild(notification);
            
            // Mostrar notificaci√≥n
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Ocultar despu√©s de 4 segundos
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        function formatDate(dateString) {
            try {
                return new Date(dateString).toLocaleDateString('es-GT', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (error) {
                return dateString;
            }
        }

        // FUNCIONES DE FALLBACK
        function loadFallbackData() {
            loadFallbackKPIs();
            loadFallbackTimeline();
            loadFallbackPredictions();
        }

        function loadFallbackKPIs() {
            document.getElementById('produccionMes').textContent = '3,250 kg';
            document.getElementById('rendimientoPromedio').textContent = '22.5 kg/√°rbol';
            document.getElementById('calidadPromedio').textContent = '87%';
            document.getElementById('ingresosMes').textContent = 'Q 32,500';
        }

        function loadFallbackTimeline() {
            const container = document.getElementById('timelineProduccion');
            if (container) {
                container.innerHTML = `
                    <div class="timeline-item">
                        <div class="timeline-fecha">Hoy, 14:30</div>
                        <div class="timeline-contenido">
                            <strong>Cosecha de demostraci√≥n</strong>
                            <div class="timeline-cantidad">45 kg</div>
                            <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">
                                Modo demo - Juan P√©rez - Calidad AA
                            </div>
                        </div>
                    </div>
                    <div class="timeline-item">
                        <div class="timeline-fecha">Ayer, 16:15</div>
                        <div class="timeline-contenido">
                            <strong>Control de calidad demo</strong>
                            <div class="timeline-cantidad">78 kg</div>
                            <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">
                                Modo demo - Mar√≠a Gonz√°lez - Calidad AAA
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function loadFallbackPredictions() {
            const container = document.getElementById('prediccionesIA');
            if (container) {
                container.innerHTML = `
                    <div class="prediccion-item">
                        <div class="prediccion-titulo">Producci√≥n Esperada</div>
                        <div class="prediccion-valor" style="color: #22c55e;">
                            +15% pr√≥ximos 7 d√≠as
                        </div>
                        <div class="prediccion-confianza">
                            Confianza: 80% | Estimaci√≥n basada en datos hist√≥ricos
                        </div>
                    </div>
                    <div class="prediccion-item">
                        <div class="prediccion-titulo">Calidad Proyectada</div>
                        <div class="prediccion-valor" style="color: #3b82f6;">
                            Grado AA promedio
                        </div>
                        <div class="prediccion-confianza">
                            Confianza: 78% | Basado en condiciones actuales
                        </div>
                    </div>
                `;
            }
        }

        // FUNCIONES DE MOSTRAR RESULTADOS
        function mostrarResultadosCalidad(resultado) {
            const mensaje = `
                An√°lisis completado:
                ‚Ä¢ Grado: ${resultado.overall.grade}
                ‚Ä¢ Puntuaci√≥n: ${resultado.overall.score}/100
                ‚Ä¢ Visual: ${resultado.results.visual.score}/100
                ‚Ä¢ Qu√≠mico: ${resultado.results.chemical.score}/100
                ‚Ä¢ F√≠sico: ${resultado.results.physical.score}/100
                ‚Ä¢ Microbiol√≥gico: ${resultado.results.microbiological.score}/100
            `;
            alert(mensaje);
        }

        function mostrarResultadosCalidadDemo() {
            alert(`Control de Calidad Demo:
‚Ä¢ Grado: AA
‚Ä¢ Puntuaci√≥n: 87/100
‚Ä¢ Recomendaciones: Mantener pr√°cticas actuales`);
        }

        function mostrarPlanCosecha(plan) {
            const mensaje = `
                Plan de Cosecha Generado:
                ‚Ä¢ Rendimiento estimado: ${plan.aiPredictions.yield_forecast} kg
                ‚Ä¢ √Årboles prioritarios: ${plan.recommendations.tree_priorities.length}
                ‚Ä¢ Ventanas clim√°ticas: ${plan.recommendations.weather_windows.length}
                ‚Ä¢ Riesgo general: ${plan.aiPredictions.risk_assessment.level || 'Bajo'}
            `;
            alert(mensaje);
        }

        function mostrarPlanCosechaDemo(parametros) {
            alert(`Plan de Cosecha Demo:
‚Ä¢ Fecha objetivo: ${parametros.fechaObjetivo}
‚Ä¢ Duraci√≥n: ${parametros.duracion} d√≠as
‚Ä¢ Prioridad: ${parametros.prioridad}
‚Ä¢ Personal: ${parametros.personal} trabajadores
‚Ä¢ Estimaci√≥n: 450 kg proyectados`);
        }

        function mostrarAnalisisRendimiento(analisis) {
            alert(`An√°lisis de Rendimiento:
‚Ä¢ Producci√≥n total: ${analisis.metrics.production.total || 'N/A'} kg
‚Ä¢ Eficiencia promedio: ${analisis.metrics.efficiency.average || 85}%
‚Ä¢ Rentabilidad: ${analisis.metrics.profitability.roi || 'N/A'}%`);
        }

        // EVENTOS DEL SISTEMA
        function handleProductionManagerReady(event) {
            console.log('‚úÖ ProductionManager listo:', event.detail);
            loadInitialData();
        }

        function handleTreeUpdate(event) {
            console.log('üå≥ √Årbol actualizado:', event.detail);
            updateFormOptions();
        }

        function handleQualityControlCompleted(event) {
            console.log('üî¨ Control de calidad completado:', event.detail);
            updateKPIs();
            updateTimeline();
        }

        function handleHarvestPlanReady(event) {
            console.log('üìÖ Plan de cosecha listo:', event.detail);
            showNotification('Plan de cosecha generado exitosamente', 'success');
        }

        // FUNCI√ìN DE EXPORTAR
        async function exportarDatos() {
            try {
                showNotification('Exportando datos...', 'info');
                
                if (window.productionManager && window.productionManager.exportarDatos) {
                    window.productionManager.exportarDatos();
                    showNotification('Datos exportados correctamente', 'success');
                } else {
                    showNotification('Datos exportados (modo demo)', 'info');
                }
            } catch (error) {
                showNotification('Error exportando datos: ' + error.message, 'error');
            }
        }

        // HACER FUNCIONES GLOBALES
        window.accionRapida = accionRapida;
        window.cambiarPeriodoGrafico = cambiarPeriodoGrafico;
        window.cerrarModal = cerrarModal;
        window.exportarDatos = exportarDatos;
        
        console.log('üåæ Sistema de producci√≥n completo cargado');
    </script>
</body>
</html>



