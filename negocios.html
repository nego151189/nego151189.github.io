<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Negocios - Finca La Herradura</title>
    
    <!-- Meta tags -->
    <meta name="description" content="Gesti√≥n de negocios, contratos, clientes y oportunidades comerciales">
    <meta name="keywords" content="negocios, contratos, clientes, ventas, oportunidades, comercial">
    
    <!-- Favicon y PWA -->
    <link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
    <link rel="manifest" href="/manifest.json">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/style.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        .negocios-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .title-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .resumen-negocios {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .resumen-negocios::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }

        .resumen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            position: relative;
            z-index: 1;
        }

        .resumen-titulo {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
        }

        .resumen-periodo {
            font-size: 1rem;
            opacity: 0.9;
        }

        .metricas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .metrica-item {
            text-align: center;
            padding: 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .metrica-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
        }

        .metrica-valor {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .metrica-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .metrica-cambio {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            opacity: 0.8;
        }

        .tabs-negocios {
            display: flex;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 0.25rem;
            margin-bottom: 2rem;
            overflow-x: auto;
        }

        .tab-btn {
            flex: 1;
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 120px;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .filtros-negocios {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .filtros-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .contenido-negocios {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 2rem;
        }

        .negocios-principales {
            display: grid;
            gap: 1.5rem;
        }

        .negocio-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            position: relative;
            border-left: 4px solid transparent;
            transition: transform 0.3s ease;
        }

        .negocio-card:hover {
            transform: translateY(-2px);
        }

        .negocio-card.prospecto {
            border-left-color: #3b82f6;
        }

        .negocio-card.negociacion {
            border-left-color: #f59e0b;
        }

        .negocio-card.cerrado {
            border-left-color: #22c55e;
        }

        .negocio-card.perdido {
            border-left-color: #ef4444;
        }

        .negocio-card.propuesta {
            border-left-color: #8b5cf6;
        }

        .negocio-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .negocio-titulo {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 0.5rem 0;
        }

        .negocio-cliente {
            color: var(--text-secondary);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .negocio-estado {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .estado-prospecto {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .estado-negociacion {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .estado-cerrado {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .estado-perdido {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .estado-propuesta {
            background: rgba(139, 92, 246, 0.2);
            color: #8b5cf6;
        }

        .negocio-valor {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .negocio-detalles {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .detalle-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .negocio-progreso {
            margin-bottom: 1rem;
        }

        .progreso-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .progreso-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
        }

        .progreso-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s ease;
        }

        .negocio-acciones {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .sidebar-negocios {
            display: grid;
            gap: 1.5rem;
        }

        .pipeline-visual {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
        }

        .pipeline-etapa {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            margin-bottom: 1rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            border-left: 4px solid transparent;
        }

        .pipeline-etapa.prospectos {
            border-left-color: #3b82f6;
        }

        .pipeline-etapa.calificados {
            border-left-color: #8b5cf6;
        }

        .pipeline-etapa.propuestas {
            border-left-color: #f59e0b;
        }

        .pipeline-etapa.negociacion {
            border-left-color: #ef4444;
        }

        .pipeline-etapa.cerrados {
            border-left-color: #22c55e;
        }

        .etapa-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .etapa-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
        }

        .etapa-datos {
            text-align: right;
        }

        .etapa-cantidad {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .etapa-valor {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .clientes-recientes {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
        }

        .cliente-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .cliente-item:hover {
            background: var(--bg-hover);
        }

        .cliente-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .cliente-info {
            flex: 1;
        }

        .cliente-nombre {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .cliente-empresa {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .cliente-valor {
            text-align: right;
            font-weight: 600;
            color: var(--primary);
        }

        .actividades-recientes {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
        }

        .actividad-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background: var(--bg-secondary);
            border-radius: 12px;
        }

        .actividad-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.875rem;
            flex-shrink: 0;
        }

        .actividad-llamada {
            background: #3b82f6;
        }

        .actividad-email {
            background: #8b5cf6;
        }

        .actividad-reunion {
            background: #f59e0b;
        }

        .actividad-propuesta {
            background: #22c55e;
        }

        .actividad-info {
            flex: 1;
        }

        .actividad-descripcion {
            font-size: 0.875rem;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .actividad-tiempo {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .modal-negocio {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            padding: 2rem;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 16px;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .form-negocio {
            display: grid;
            gap: 1rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .probabilidad-selector {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .prob-btn {
            flex: 1;
            padding: 0.5rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-secondary);
            cursor: pointer;
            text-align: center;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .prob-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .contactos-cliente {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem;
        }

        .contacto-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .contacto-item:last-child {
            border-bottom: none;
        }

        .graficos-negocios {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .grafico-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
        }

        .grafico-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .grafico-titulo {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .initialization-loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            font-size: 1.2rem;
        }

        .initialization-loader.hidden {
            display: none;
        }

        @media (max-width: 1024px) {
            .contenido-negocios {
                grid-template-columns: 1fr;
            }
            
            .sidebar-negocios {
                order: -1;
            }
            
            .graficos-negocios {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .negocios-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .metricas-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tabs-negocios {
                flex-direction: column;
            }
            
            .tab-btn {
                flex: none;
            }
            
            .filtros-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .negocio-detalles {
                grid-template-columns: 1fr;
            }
        }

        /* Ajustes para contenido con sidebar */
        .main-content-wrapper {
            margin-left: 280px;
            padding: 2rem;
            transition: margin-left 0.3s ease;
        }

        @media (max-width: 768px) {
            .main-content-wrapper {
                margin-left: 0;
                padding: 1rem;
                padding-top: 5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loader de inicializaci√≥n -->
    <div class="initialization-loader" id="initLoader">
        <div style="text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">
                <i class="fas fa-handshake fa-spin"></i>
            </div>
            <div>Inicializando sistema de negocios...</div>
            <div style="font-size: 0.9rem; opacity: 0.7; margin-top: 0.5rem;">
                Cargando datos y conectando servicios
            </div>
        </div>
    </div>

    <!-- La navegaci√≥n se cargar√° autom√°ticamente desde nav.js -->

    <!-- Contenido principal -->
    <main class="main-content-wrapper">
        <!-- Header de la p√°gina -->
        <header class="negocios-header">
            <div class="page-title">
                <div class="title-icon">
                    <i class="fas fa-handshake"></i>
                </div>
                <div>
                    <h1>Gesti√≥n de Negocios</h1>
                    <p>Clientes, contratos y oportunidades comerciales</p>
                </div>
            </div>
            
            <div class="header-actions">
                <button class="btn btn-success" id="btnNuevoNegocio">
                    <i class="fas fa-plus"></i> Nuevo Negocio
                </button>
                
                <button class="btn btn-primary" id="btnNuevoCliente">
                    <i class="fas fa-user-plus"></i> Nuevo Cliente
                </button>
                
                <button class="btn btn-secondary" id="btnReporteVentas">
                    <i class="fas fa-chart-bar"></i> Reportes
                </button>
                
                <button class="btn btn-outline" id="btnExportarDatos">
                    <i class="fas fa-download"></i> Exportar
                </button>
            </div>
        </header>

        <!-- Resumen de negocios -->
        <section class="resumen-negocios">
            <div class="resumen-header">
                <div>
                    <h2 class="resumen-titulo">Panel de Negocios</h2>
                    <div class="resumen-periodo" id="periodoActual">Enero 2025</div>
                </div>
            </div>
            
            <div class="metricas-grid">
                <div class="metrica-item">
                    <div class="metrica-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="metrica-valor" id="ventasTotales">Q 125,500</div>
                    <div class="metrica-label">Ventas Totales</div>
                    <div class="metrica-cambio" id="cambioVentas">+15% vs mes anterior</div>
                </div>
                
                <div class="metrica-item">
                    <div class="metrica-icon">
                        <i class="fas fa-bullseye"></i>
                    </div>
                    <div class="metrica-valor" id="negociosActivos">12</div>
                    <div class="metrica-label">Negocios Activos</div>
                    <div class="metrica-cambio" id="cambioNegocios">+3 nuevos</div>
                </div>
                
                <div class="metrica-item">
                    <div class="metrica-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="metrica-valor" id="clientesActivos">8</div>
                    <div class="metrica-label">Clientes Activos</div>
                    <div class="metrica-cambio" id="cambioClientes">+2 nuevos</div>
                </div>
                
                <div class="metrica-item">
                    <div class="metrica-icon">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="metrica-valor" id="tasaConversion">68%</div>
                    <div class="metrica-label">Tasa de Conversi√≥n</div>
                    <div class="metrica-cambio" id="cambioConversion">+5% mejora</div>
                </div>
                
                <div class="metrica-item">
                    <div class="metrica-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="metrica-valor" id="cicloPromedio">21</div>
                    <div class="metrica-label">D√≠as Promedio</div>
                    <div class="metrica-cambio" id="cambioCiclo">-3 d√≠as vs anterior</div>
                </div>
            </div>
        </section>

        <!-- Pesta√±as de navegaci√≥n -->
        <div class="tabs-negocios">
            <button class="tab-btn active" data-tab="pipeline">
                <i class="fas fa-funnel-dollar"></i> Pipeline
            </button>
            <button class="tab-btn" data-tab="clientes">
                <i class="fas fa-users"></i> Clientes
            </button>
            <button class="tab-btn" data-tab="contratos">
                <i class="fas fa-file-contract"></i> Contratos
            </button>
            <button class="tab-btn" data-tab="oportunidades">
                <i class="fas fa-lightbulb"></i> Oportunidades
            </button>
            <button class="tab-btn" data-tab="reportes">
                <i class="fas fa-chart-line"></i> An√°lisis
            </button>
        </div>

        <!-- Contenido de Pipeline -->
        <div class="tab-content active" id="tab-pipeline">
            <!-- Filtros -->
            <section class="filtros-negocios">
                <h3 style="margin-bottom: 1rem;">
                    <i class="fas fa-filter"></i> Filtros
                </h3>
                
                <div class="filtros-grid">
                    <div class="form-group">
                        <label class="form-label">Estado</label>
                        <select class="form-input" id="filtroEstado">
                            <option value="">Todos</option>
                            <option value="prospecto">Prospecto</option>
                            <option value="calificado">Calificado</option>
                            <option value="propuesta">Propuesta</option>
                            <option value="negociacion">Negociaci√≥n</option>
                            <option value="cerrado">Cerrado</option>
                            <option value="perdido">Perdido</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Cliente</label>
                        <select class="form-input" id="filtroCliente">
                            <option value="">Todos</option>
                            <!-- Se cargar√°n din√°micamente -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Valor M√≠nimo</label>
                        <input type="number" class="form-input" id="filtroValorMin" placeholder="Q 0">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Per√≠odo</label>
                        <select class="form-input" id="filtroPeriodo">
                            <option value="mes">Este Mes</option>
                            <option value="trimestre">Trimestre</option>
                            <option value="ano">Este A√±o</option>
                            <option value="todos">Todos</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <button class="btn btn-primary" id="aplicarFiltrosPipeline">
                            <i class="fas fa-search"></i> Filtrar
                        </button>
                        <button class="btn btn-secondary" id="limpiarFiltrosPipeline">
                            <i class="fas fa-times"></i> Limpiar
                        </button>
                    </div>
                </div>
            </section>

            <!-- Contenido principal del pipeline -->
            <div class="contenido-negocios">
                <!-- Lista de negocios -->
                <div class="negocios-principales">
                    <div id="listaNegociosPipeline">
                        <!-- Los negocios se cargar√°n din√°micamente -->
                    </div>
                </div>

                <!-- Sidebar del pipeline -->
                <div class="sidebar-negocios">
                    <!-- Pipeline visual -->
                    <div class="pipeline-visual">
                        <h4 style="margin-bottom: 1rem;">Pipeline de Ventas</h4>
                        <div id="pipelineVisual">
                            <!-- Se cargar√° din√°micamente -->
                        </div>
                    </div>

                    <!-- Clientes recientes -->
                    <div class="clientes-recientes">
                        <h4 style="margin-bottom: 1rem;">Clientes Activos</h4>
                        <div id="clientesRecientes">
                            <!-- Se cargar√°n din√°micamente -->
                        </div>
                    </div>

                    <!-- Actividades recientes -->
                    <div class="actividades-recientes">
                        <h4 style="margin-bottom: 1rem;">Actividades Recientes</h4>
                        <div id="actividadesRecientes">
                            <!-- Se cargar√°n din√°micamente -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contenido de Clientes -->
        <div class="tab-content" id="tab-clientes">
            <div class="contenido-tab">
                <h3>Gesti√≥n de Clientes</h3>
                <p>M√≥dulo de clientes en desarrollo...</p>
            </div>
        </div>

        <!-- Contenido de Contratos -->
        <div class="tab-content" id="tab-contratos">
            <div class="contenido-tab">
                <h3>Gesti√≥n de Contratos</h3>
                <p>M√≥dulo de contratos en desarrollo...</p>
            </div>
        </div>

        <!-- Contenido de Oportunidades -->
        <div class="tab-content" id="tab-oportunidades">
            <div class="contenido-tab">
                <h3>Oportunidades de Negocio</h3>
                <p>M√≥dulo de oportunidades en desarrollo...</p>
            </div>
        </div>

        <!-- Contenido de Reportes -->
        <div class="tab-content" id="tab-reportes">
            <!-- Gr√°ficos de an√°lisis -->
            <div class="graficos-negocios">
                <div class="grafico-card">
                    <div class="grafico-header">
                        <h3 class="grafico-titulo">Ventas por Mes</h3>
                    </div>
                    <canvas id="graficoVentasMes" height="250"></canvas>
                </div>
                
                <div class="grafico-card">
                    <div class="grafico-header">
                        <h3 class="grafico-titulo">Distribuci√≥n por Estado</h3>
                    </div>
                    <canvas id="graficoEstados" height="250"></canvas>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal para nuevo/editar negocio -->
    <div class="modal-negocio" id="modalNegocio">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitulo">Nuevo Negocio</h3>
                <button class="modal-close" id="cerrarModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form class="form-negocio" id="formNegocio">
                <div class="form-group">
                    <label class="form-label">Nombre del Negocio</label>
                    <input type="text" class="form-input" id="nombreNegocio" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Cliente</label>
                        <select class="form-input" id="clienteNegocio" required>
                            <option value="">Seleccionar cliente...</option>
                            <!-- Se cargar√°n din√°micamente -->
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Valor Estimado (Q)</label>
                        <input type="number" class="form-input" id="valorNegocio" step="0.01" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Estado</label>
                        <select class="form-input" id="estadoNegocio" required>
                            <option value="prospecto">Prospecto</option>
                            <option value="calificado">Calificado</option>
                            <option value="propuesta">Propuesta</option>
                            <option value="negociacion">Negociaci√≥n</option>
                            <option value="cerrado">Cerrado</option>
                            <option value="perdido">Perdido</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Fecha de Cierre Estimada</label>
                        <input type="date" class="form-input" id="fechaCierreNegocio">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Descripci√≥n</label>
                    <textarea class="form-input" id="descripcionNegocio" rows="3"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Probabilidad de Cierre (%)</label>
                    <div class="probabilidad-selector">
                        <div class="prob-btn" data-prob="25">25%</div>
                        <div class="prob-btn" data-prob="50">50%</div>
                        <div class="prob-btn active" data-prob="75">75%</div>
                        <div class="prob-btn" data-prob="90">90%</div>
                        <div class="prob-btn" data-prob="100">100%</div>
                    </div>
                    <input type="hidden" id="probabilidadNegocio" value="75">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Productos/Servicios</label>
                    <textarea class="form-input" id="productosNegocio" rows="3" placeholder="Detalle de productos o servicios incluidos"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Contactos del Cliente</label>
                    <div class="contactos-cliente" id="contactosCliente">
                        <!-- Se cargar√°n din√°micamente -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Notas</label>
                    <textarea class="form-input" id="notasNegocio" rows="2"></textarea>
                </div>
                
                <div class="form-group" style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-secondary" id="cancelarNegocio">
                        Cancelar
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts Firebase (deben cargarse primero) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <!-- Scripts de aplicaci√≥n -->
    <script type="module" src="/js/firebase-config.js"></script>
    <script type="module" src="/js/auth.js"></script>
    <script type="module" src="/js/nav.js"></script>
    <script type="module" src="/js/offline.js"></script>
    <script type="module" src="/js/negocios.js"></script>
    
    <script>
        // Variables globales
        let graficoVentasMes, graficoEstados;
        let sistemaInicializado = false;
        let negocioSeleccionado = null;

        // ==========================================
        // FUNCIONES DE ESPERA Y INICIALIZACI√ìN
        // ==========================================

        function esperarFirebase() {
            return new Promise((resolve) => {
                const maxWait = 10000;
                const checkInterval = 100;
                let elapsed = 0;

                const check = () => {
                    if (window.firebase && window.auth && window.db) {
                        console.log('‚úÖ Firebase disponible para negocios.html');
                        resolve(true);
                    } else if (elapsed < maxWait) {
                        elapsed += checkInterval;
                        setTimeout(check, checkInterval);
                    } else {
                        console.warn('‚ö†Ô∏è Timeout esperando Firebase en negocios.html');
                        resolve(false);
                    }
                };

                window.addEventListener('firebaseReady', () => {
                    console.log('üî• Evento firebaseReady recibido');
                    resolve(true);
                }, { once: true });

                check();
            });
        }

        function esperarAuthManager() {
            return new Promise((resolve) => {
                const maxWait = 10000;
                const checkInterval = 100;
                let elapsed = 0;

                const check = () => {
                    if (window.authManager && window.authManager.isInitialized) {
                        console.log('‚úÖ AuthManager disponible para negocios.html');
                        resolve(true);
                    } else if (elapsed < maxWait) {
                        elapsed += checkInterval;
                        setTimeout(check, checkInterval);
                    } else {
                        console.warn('‚ö†Ô∏è Timeout esperando AuthManager en negocios.html');
                        resolve(false);
                    }
                };

                check();
            });
        }

        function esperarNegociosManager() {
            return new Promise((resolve) => {
                const maxWait = 15000;
                const checkInterval = 200;
                let elapsed = 0;

                const check = () => {
                    if (window.negociosManager) {
                        console.log('‚úÖ NegociosManager disponible para negocios.html');
                        resolve(true);
                    } else if (elapsed < maxWait) {
                        elapsed += checkInterval;
                        setTimeout(check, checkInterval);
                    } else {
                        console.warn('‚ö†Ô∏è Timeout esperando NegociosManager en negocios.html');
                        resolve(false);
                    }
                };

                check();
            });
        }

        async function verificarAutenticacion() {
            try {
                // Esperar a que Firebase est√© disponible
                await esperarFirebase();
                await esperarAuthManager();

                return new Promise((resolve) => {
                    if (window.authManager && window.authManager.currentUser) {
                        resolve(true);
                    } else if (window.firebase && window.firebase.auth) {
                        window.firebase.auth().onAuthStateChanged((user) => {
                            resolve(!!user);
                        });
                    } else {
                        console.error('‚ùå Firebase Auth no disponible');
                        resolve(false);
                    }
                });
            } catch (error) {
                console.error('‚ùå Error en verificaci√≥n de autenticaci√≥n:', error);
                return false;
            }
        }

        // ==========================================
        // INICIALIZACI√ìN PRINCIPAL
        // ==========================================

        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('üíº Iniciando aplicaci√≥n de negocios...');
                
                document.getElementById('initLoader').classList.remove('hidden');

                const autenticado = await verificarAutenticacion();
                if (!autenticado) {
                    console.log('‚ùå Usuario no autenticado, redirigiendo...');
                    window.location.href = '/login.html';
                    return;
                }
                console.log('‚úÖ Usuario autenticado');

                await esperarNegociosManager();
                await inicializarPagina();

                sistemaInicializado = true;
                console.log('üéâ Sistema de negocios completamente inicializado');

            } catch (error) {
                console.error('‚ùå Error fatal en inicializaci√≥n:', error);
                mostrarError('Error cr√≠tico iniciando la aplicaci√≥n');
            } finally {
                document.getElementById('initLoader').classList.add('hidden');
            }
        });

        async function inicializarPagina() {
            try {
                console.log('‚öôÔ∏è Inicializando componentes de la p√°gina...');
                
                configurarEventListeners();
                await cargarDatosIniciales();
                inicializarGraficos();
                configurarPeriodoActual();
                
                console.log('‚úÖ P√°gina de negocios inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                mostrarError('Error cargando la p√°gina de negocios');
            }
        }

        function configurarEventListeners() {
            // Botones principales
            document.getElementById('btnNuevoNegocio')?.addEventListener('click', mostrarModalNegocio);
            document.getElementById('btnNuevoCliente')?.addEventListener('click', mostrarModalCliente);
            document.getElementById('btnReporteVentas')?.addEventListener('click', generarReporteVentas);
            document.getElementById('btnExportarDatos')?.addEventListener('click', exportarDatos);
            
            // Pesta√±as
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => cambiarTab(e.target.dataset.tab));
            });
            
            // Modal
            document.getElementById('cerrarModal')?.addEventListener('click', cerrarModal);
            document.getElementById('cancelarNegocio')?.addEventListener('click', cerrarModal);
            document.getElementById('formNegocio')?.addEventListener('submit', guardarNegocio);
            
            // Filtros
            document.getElementById('aplicarFiltrosPipeline')?.addEventListener('click', aplicarFiltrosPipeline);
            document.getElementById('limpiarFiltrosPipeline')?.addEventListener('click', limpiarFiltrosPipeline);
            
            // Selector de probabilidad
            document.querySelectorAll('.prob-btn').forEach(btn => {
                btn.addEventListener('click', (e) => seleccionarProbabilidad(e.target.dataset.prob));
            });
            
            // Cliente selector
            document.getElementById('clienteNegocio')?.addEventListener('change', cargarContactosCliente);
            
            // Cerrar modal al hacer click fuera
            document.getElementById('modalNegocio')?.addEventListener('click', (e) => {
                if (e.target.id === 'modalNegocio') {
                    cerrarModal();
                }
            });

            window.addEventListener('online', () => {
                if (sistemaInicializado) {
                    cargarDatosIniciales();
                }
            });

            console.log('‚úÖ Event listeners configurados');
        }

        async function cargarDatosIniciales() {
            try {
                if (window.negociosManager) {
                    actualizarMetricas();
                    cargarPipeline();
                    cargarClientesRecientes();
                    cargarActividadesRecientes();
                    cargarOpcionesClientes();
                } else {
                    console.warn('‚ö†Ô∏è NegociosManager no disponible, usando datos por defecto');
                }
            } catch (error) {
                console.error('‚ùå Error cargando datos:', error);
            }
        }

        function configurarPeriodoActual() {
            const fecha = new Date();
            const opciones = { year: 'numeric', month: 'long' };
            document.getElementById('periodoActual').textContent = 
                fecha.toLocaleDateString('es-GT', opciones);
        }

        function actualizarMetricas() {
            if (!window.negociosManager) return;
            
            const metricas = window.negociosManager.obtenerMetricas();
            
            document.getElementById('ventasTotales').textContent = `Q ${metricas.ventasTotales.toLocaleString()}`;
            document.getElementById('negociosActivos').textContent = metricas.negociosActivos;
            document.getElementById('clientesActivos').textContent = metricas.clientesActivos;
            document.getElementById('tasaConversion').textContent = `${metricas.tasaConversion}%`;
            document.getElementById('cicloPromedio').textContent = metricas.cicloPromedio;
            
            // Cambios vs per√≠odo anterior
            document.getElementById('cambioVentas').textContent = `${metricas.cambioVentas >= 0 ? '+' : ''}${metricas.cambioVentas}% vs mes anterior`;
            document.getElementById('cambioNegocios').textContent = `${metricas.cambioNegocios >= 0 ? '+' : ''}${metricas.cambioNegocios} nuevos`;
            document.getElementById('cambioClientes').textContent = `${metricas.cambioClientes >= 0 ? '+' : ''}${metricas.cambioClientes} nuevos`;
            document.getElementById('cambioConversion').textContent = `${metricas.cambioConversion >= 0 ? '+' : ''}${metricas.cambioConversion}% mejora`;
            document.getElementById('cambioCiclo').textContent = `${metricas.cambioCiclo >= 0 ? '+' : ''}${metricas.cambioCiclo} d√≠as vs anterior`;
        }

        function cargarPipeline() {
            const container = document.getElementById('listaNegociosPipeline');
            const pipelineContainer = document.getElementById('pipelineVisual');
            
            if (window.negociosManager) {
                const negocios = window.negociosManager.obtenerNegociosFiltrados();
                const pipeline = window.negociosManager.obtenerPipelineVisual();
                
                // Cargar lista de negocios
                container.innerHTML = negocios.map(negocio => `
                    <div class="negocio-card ${negocio.estado}" onclick="verDetalleNegocio('${negocio.id}')">
                        <div class="negocio-header">
                            <div>
                                <h3 class="negocio-titulo">${negocio.nombre}</h3>
                                <div class="negocio-cliente">
                                    <i class="fas fa-building"></i>
                                    <span>${negocio.cliente}</span>
                                </div>
                            </div>
                            <div class="negocio-estado estado-${negocio.estado}">
                                ${negocio.estado}
                            </div>
                        </div>
                        
                        <div class="negocio-valor">Q ${negocio.valor.toLocaleString()}</div>
                        
                        <div class="negocio-detalles">
                            <div class="detalle-item">
                                <i class="fas fa-calendar"></i>
                                <span>${formatearFecha(negocio.fechaCierre)}</span>
                            </div>
                            <div class="detalle-item">
                                <i class="fas fa-percentage"></i>
                                <span>${negocio.probabilidad}% probabilidad</span>
                            </div>
                            <div class="detalle-item">
                                <i class="fas fa-clock"></i>
                                <span>${negocio.diasDesdeCreacion} d√≠as</span>
                            </div>
                            <div class="detalle-item">
                                <i class="fas fa-user"></i>
                                <span>${negocio.contacto}</span>
                            </div>
                        </div>
                        
                        <div class="negocio-progreso">
                            <div class="progreso-label">
                                <span>Progreso</span>
                                <span>${negocio.progreso}%</span>
                            </div>
                            <div class="progreso-bar">
                                <div class="progreso-fill" style="width: ${negocio.progreso}%"></div>
                            </div>
                        </div>
                        
                        <div class="negocio-acciones">
                            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); editarNegocio('${negocio.id}')">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                            <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); avanzarEtapa('${negocio.id}')">
                                <i class="fas fa-arrow-right"></i> Avanzar
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); agregarActividad('${negocio.id}')">
                                <i class="fas fa-plus"></i> Actividad
                            </button>
                        </div>
                    </div>
                `).join('');
                
                // Cargar pipeline visual
                pipelineContainer.innerHTML = pipeline.map(etapa => `
                    <div class="pipeline-etapa ${etapa.clase}">
                        <div class="etapa-info">
                            <div class="etapa-icon" style="background: ${etapa.color};">
                                <i class="fas ${etapa.icono}"></i>
                            </div>
                            <div>
                                <div style="font-weight: 600; color: var(--text-primary);">${etapa.nombre}</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">${etapa.descripcion}</div>
                            </div>
                        </div>
                        <div class="etapa-datos">
                            <div class="etapa-cantidad">${etapa.cantidad}</div>
                            <div class="etapa-valor">Q ${etapa.valor.toLocaleString()}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function cargarClientesRecientes() {
            const container = document.getElementById('clientesRecientes');
            
            if (window.negociosManager) {
                const clientes = window.negociosManager.obtenerClientesRecientes();
                
                container.innerHTML = clientes.map(cliente => `
                    <div class="cliente-item" onclick="verDetalleCliente('${cliente.id}')">
                        <div class="cliente-avatar">
                            ${cliente.nombre.charAt(0).toUpperCase()}
                        </div>
                        <div class="cliente-info">
                            <div class="cliente-nombre">${cliente.nombre}</div>
                            <div class="cliente-empresa">${cliente.empresa}</div>
                        </div>
                        <div class="cliente-valor">Q ${cliente.valorTotal.toLocaleString()}</div>
                    </div>
                `).join('');
            }
        }

        function cargarActividadesRecientes() {
            const container = document.getElementById('actividadesRecientes');
            
            if (window.negociosManager) {
                const actividades = window.negociosManager.obtenerActividadesRecientes();
                
                container.innerHTML = actividades.map(actividad => `
                    <div class="actividad-item">
                        <div class="actividad-icon actividad-${actividad.tipo}">
                            <i class="fas ${obtenerIconoActividad(actividad.tipo)}"></i>
                        </div>
                        <div class="actividad-info">
                            <div class="actividad-descripcion">${actividad.descripcion}</div>
                            <div class="actividad-tiempo">${actividad.tiempoRelativo}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function cargarOpcionesClientes() {
            const selects = [
                document.getElementById('filtroCliente'),
                document.getElementById('clienteNegocio')
            ];
            
            if (window.negociosManager) {
                const clientes = window.negociosManager.obtenerListaClientes();
                
                selects.forEach(select => {
                    if (select) {
                        const opciones = clientes.map(cliente => 
                            `<option value="${cliente.id}">${cliente.nombre} - ${cliente.empresa}</option>`
                        ).join('');
                        
                        select.innerHTML = select.id === 'filtroCliente' ? 
                            '<option value="">Todos</option>' + opciones :
                            '<option value="">Seleccionar cliente...</option>' + opciones;
                    }
                });
            }
        }

        function cambiarTab(tabId) {
            // Cambiar botones activos
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            
            // Cambiar contenido activo
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            // Cargar datos espec√≠ficos del tab si es necesario
            if (tabId === 'reportes') {
                cargarDatosGraficos();
            }
        }

        function inicializarGraficos() {
            // Gr√°fico de ventas por mes
            const ctxVentas = document.getElementById('graficoVentasMes');
            if (ctxVentas) {
                graficoVentasMes = new Chart(ctxVentas, {
                    type: 'line',
                    data: {
                        labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Ventas (Q)',
                            data: [85000, 92000, 78000, 105000, 98000, 125500],
                            borderColor: '#0ea5e9',
                            backgroundColor: 'rgba(14, 165, 233, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { 
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') || '#333'
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: { 
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') || '#666'
                                },
                                grid: { 
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            y: {
                                ticks: { 
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-secondary') || '#666'
                                },
                                grid: { 
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        }
                    }
                });
            }

            // Gr√°fico de distribuci√≥n por estados
            const ctxEstados = document.getElementById('graficoEstados');
            if (ctxEstados) {
                graficoEstados = new Chart(ctxEstados, {
                    type: 'doughnut',
                    data: {
                        labels: ['Prospecto', 'Propuesta', 'Negociaci√≥n', 'Cerrado'],
                        datasets: [{
                            data: [1, 1, 1, 1],
                            backgroundColor: [
                                '#3b82f6',
                                '#8b5cf6',
                                '#f59e0b',
                                '#22c55e'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { 
                                    color: getComputedStyle(document.documentElement).getPropertyValue('--text-primary') || '#333'
                                }
                            }
                        }
                    }
                });
            }

            console.log('‚úÖ Gr√°ficos inicializados');
        }

        function cargarDatosGraficos() {
            if (window.negociosManager) {
                const datosVentas = window.negociosManager.obtenerDatosVentasMes();
                const datosEstados = window.negociosManager.obtenerDistribucionEstados();
                
                if (graficoVentasMes && datosVentas) {
                    graficoVentasMes.data.labels = datosVentas.labels;
                    graficoVentasMes.data.datasets[0].data = datosVentas.data;
                    graficoVentasMes.update();
                }
                
                if (graficoEstados && datosEstados) {
                    graficoEstados.data.labels = datosEstados.labels;
                    graficoEstados.data.datasets[0].data = datosEstados.data;
                    graficoEstados.update();
                }
            }
        }

        // ==========================================
        // FUNCIONES DE MODAL Y FORMULARIO
        // ==========================================

        function mostrarModalNegocio(negocioId = null) {
            const modal = document.getElementById('modalNegocio');
            const form = document.getElementById('formNegocio');
            const titulo = document.getElementById('modalTitulo');
            
            // Limpiar formulario
            form.reset();
            negocioSeleccionado = negocioId;
            
            if (negocioId) {
                titulo.textContent = 'Editar Negocio';
                // Cargar datos del negocio
                if (window.negociosManager) {
                    const negocio = window.negociosManager.obtenerNegocio(negocioId);
                    if (negocio) {
                        cargarDatosFormulario(negocio);
                    }
                }
            } else {
                titulo.textContent = 'Nuevo Negocio';
                // Configurar valores por defecto
                seleccionarProbabilidad('75');
            }
            
            // Cargar contactos del cliente seleccionado
            cargarContactosCliente();
            
            modal.style.display = 'block';
        }

        function cerrarModal() {
            document.getElementById('modalNegocio').style.display = 'none';
            negocioSeleccionado = null;
        }

        async function guardarNegocio(e) {
            e.preventDefault();
            
            const datos = obtenerDatosFormulario();
            
            try {
                if (window.negociosManager) {
                    if (negocioSeleccionado) {
                        datos.id = negocioSeleccionado;
                    }
                    
                    await window.negociosManager.guardarNegocio(datos);
                    mostrarNotificacion('Negocio guardado correctamente', 'success');
                    cerrarModal();
                    await cargarDatosIniciales();
                } else {
                    mostrarNotificacion('Sistema no disponible', 'error');
                }
            } catch (error) {
                console.error('Error guardando negocio:', error);
                mostrarNotificacion('Error al guardar el negocio', 'error');
            }
        }

        function obtenerDatosFormulario() {
            return {
                nombre: document.getElementById('nombreNegocio').value,
                cliente: document.getElementById('clienteNegocio').options[document.getElementById('clienteNegocio').selectedIndex].text,
                clienteId: document.getElementById('clienteNegocio').value,
                valor: parseFloat(document.getElementById('valorNegocio').value),
                estado: document.getElementById('estadoNegocio').value,
                fechaCierre: document.getElementById('fechaCierreNegocio').value,
                descripcion: document.getElementById('descripcionNegocio').value,
                probabilidad: parseInt(document.getElementById('probabilidadNegocio').value),
                productos: document.getElementById('productosNegocio').value,
                notas: document.getElementById('notasNegocio').value
            };
        }

        function cargarDatosFormulario(negocio) {
            document.getElementById('nombreNegocio').value = negocio.nombre;
            document.getElementById('clienteNegocio').value = negocio.clienteId;
            document.getElementById('valorNegocio').value = negocio.valor;
            document.getElementById('estadoNegocio').value = negocio.estado;
            document.getElementById('fechaCierreNegocio').value = negocio.fechaCierre;
            document.getElementById('descripcionNegocio').value = negocio.descripcion || '';
            document.getElementById('productosNegocio').value = negocio.productos || '';
            document.getElementById('notasNegocio').value = negocio.notas || '';
            
            seleccionarProbabilidad(negocio.probabilidad.toString());
        }

        function seleccionarProbabilidad(probabilidad) {
            document.querySelectorAll('.prob-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-prob="${probabilidad}"]`).classList.add('active');
            document.getElementById('probabilidadNegocio').value = probabilidad;
        }

        function cargarContactosCliente() {
            const clienteId = document.getElementById('clienteNegocio').value;
            const container = document.getElementById('contactosCliente');
            
            if (clienteId && window.negociosManager) {
                const contactos = window.negociosManager.obtenerContactosCliente(clienteId);
                
                container.innerHTML = contactos.map(contacto => `
                    <div class="contacto-item">
                        <div>
                            <div style="font-weight: 600;">${contacto.nombre}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">${contacto.cargo}</div>
                        </div>
                        <div style="text-align: right; font-size: 0.875rem;">
                            <div>${contacto.email}</div>
                            <div>${contacto.telefono}</div>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 1rem;">Selecciona un cliente para ver contactos</div>';
            }
        }

        // ==========================================
        // FUNCIONES DE FILTROS
        // ==========================================

        function aplicarFiltrosPipeline() {
            if (window.negociosManager) {
                const filtros = {
                    estado: document.getElementById('filtroEstado').value,
                    cliente: document.getElementById('filtroCliente').value,
                    valorMin: parseFloat(document.getElementById('filtroValorMin').value) || 0,
                    periodo: document.getElementById('filtroPeriodo').value
                };
                
                window.negociosManager.aplicarFiltros(filtros);
                cargarPipeline();
                mostrarNotificacion('Filtros aplicados', 'info');
            }
        }

        function limpiarFiltrosPipeline() {
            document.getElementById('filtroEstado').value = '';
            document.getElementById('filtroCliente').value = '';
            document.getElementById('filtroValorMin').value = '';
            document.getElementById('filtroPeriodo').value = 'mes';
            aplicarFiltrosPipeline();
        }

        // ==========================================
        // FUNCIONES DE ACCIONES
        // ==========================================

        function editarNegocio(id) {
            mostrarModalNegocio(id);
        }

        async function avanzarEtapa(id) {
            try {
                if (window.negociosManager) {
                    await window.negociosManager.avanzarEtapa(id);
                    mostrarNotificacion('Etapa avanzada correctamente', 'success');
                    await cargarDatosIniciales();
                } else {
                    mostrarNotificacion('Sistema no disponible', 'error');
                }
            } catch (error) {
                console.error('Error avanzando etapa:', error);
                mostrarNotificacion('Error al avanzar etapa', 'error');
            }
        }

        function agregarActividad(id) {
            if (window.negociosManager) {
                window.negociosManager.mostrarModalActividad(id);
            }
        }

        function verDetalleNegocio(id) {
            if (window.negociosManager) {
                window.negociosManager.mostrarDetalle(id);
            }
        }

        function verDetalleCliente(id) {
            if (window.negociosManager) {
                window.negociosManager.mostrarDetalleCliente(id);
            }
        }

        function mostrarModalCliente() {
            if (window.negociosManager) {
                window.negociosManager.mostrarModalCliente();
            } else {
                mostrarNotificacion('Funci√≥n de nuevo cliente en desarrollo', 'info');
            }
        }

        function generarReporteVentas() {
            if (window.negociosManager) {
                window.negociosManager.generarReporte();
            } else {
                mostrarNotificacion('Generando reporte de ventas...', 'info');
            }
        }

        function exportarDatos() {
            if (window.negociosManager) {
                window.negociosManager.exportarDatos();
            } else {
                mostrarNotificacion('Exportando datos de negocios...', 'info');
            }
        }

        // ==========================================
        // UTILIDADES
        // ==========================================

        function obtenerIconoActividad(tipo) {
            const iconos = {
                llamada: 'fa-phone',
                email: 'fa-envelope',
                reunion: 'fa-handshake',
                propuesta: 'fa-file-alt'
            };
            return iconos[tipo] || 'fa-comment';
        }

        function formatearFecha(fecha) {
            return new Date(fecha).toLocaleDateString('es-GT', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function mostrarNotificacion(mensaje, tipo = 'info') {
            console.log(`${tipo.toUpperCase()}: ${mensaje}`);
            
            if (window.notificationManager) {
                switch(tipo) {
                    case 'success':
                        window.notificationManager.success(mensaje);
                        break;
                    case 'error':
                        window.notificationManager.error(mensaje);
                        break;
                    case 'warning':
                        window.notificationManager.warning(mensaje);
                        break;
                    default:
                        window.notificationManager.info(mensaje);
                }
            }
        }

        function mostrarError(mensaje) {
            mostrarNotificacion(mensaje, 'error');
        }

        // Hacer funciones globales
        window.editarNegocio = editarNegocio;
        window.avanzarEtapa = avanzarEtapa;
        window.agregarActividad = agregarActividad;
        window.verDetalleNegocio = verDetalleNegocio;
        window.verDetalleCliente = verDetalleCliente;

        // Manejo de errores globales
        window.addEventListener('error', (event) => {
            console.error('‚ùå Error global:', event.error);
            // No mostrar errores menores al usuario para evitar spam
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('‚ùå Promesa rechazada no manejada:', event.reason);
            // Solo mostrar errores cr√≠ticos
            if (event.reason && event.reason.message && 
                (event.reason.message.includes('Firebase') || 
                 event.reason.message.includes('Network'))) {
                mostrarError('Error de conexi√≥n o servicio');
            }
        });
    </script>
</body>
</html>