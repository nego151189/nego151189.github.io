<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finca La Herradura - Dashboard Inteligente</title>
    
    <!-- Favicons -->
    <link rel="icon" type="image/png" href="icons/favicon.png">
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/style.css">
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- TensorFlow.js para ML -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
    
    <!-- Firebase SDK v8 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <style>
        /* Estilos cr√≠ticos inline para carga inicial r√°pida */
        .loader-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfccb 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }
        
        .loader svg {
            width: 80px;
            height: 80px;
            animation: rotate 2s ease-in-out infinite;
        }
        
        .lemon-path {
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        @keyframes rotate {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(180deg); }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(0.9); opacity: 0.8; }
        }
        
        .loader-container.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        /* Layout responsive mejorado */
        .main-content-wrapper {
            margin-left: 280px;
            min-height: 100vh;
            padding: 2rem;
            background: #f8fafc;
            transition: margin-left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @media (max-width: 768px) {
            .main-content-wrapper {
                margin-left: 0;
                padding: 1rem;
            }
        }

        @media (max-width: 480px) {
            .main-content-wrapper {
                padding: 0.5rem;
            }
        }

        .dashboard-section {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Dashboard Header Responsive */
        .dashboard-header {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 2rem;
            margin-bottom: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
        }

        @media (max-width: 1024px) {
            .dashboard-header {
                grid-template-columns: 1fr;
                gap: 1.5rem;
                padding: 1.5rem;
            }
        }

        @media (max-width: 768px) {
            .dashboard-header {
                padding: 1rem;
                border-radius: 12px;
            }
        }

        @media (max-width: 480px) {
            .dashboard-header {
                padding: 0.75rem;
                border-radius: 8px;
            }
        }

        .welcome-section h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        @media (max-width: 768px) {
            .welcome-section h2 {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            .welcome-section h2 {
                font-size: 1.25rem;
            }
        }

        .welcome-section p {
            color: #64748b;
            font-size: 1rem;
        }

        @media (max-width: 480px) {
            .welcome-section p {
                font-size: 0.875rem;
            }
        }

        /* AI Assistant Card Responsive */
        .ai-assistant-card {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, rgba(167, 139, 250, 0.05) 100%);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 16px;
            padding: 1.5rem;
            max-width: 400px;
        }

        @media (max-width: 1024px) {
            .ai-assistant-card {
                max-width: 100%;
            }
        }

        @media (max-width: 768px) {
            .ai-assistant-card {
                padding: 1rem;
                border-radius: 12px;
            }
        }

        @media (max-width: 480px) {
            .ai-assistant-card {
                padding: 0.75rem;
                border-radius: 8px;
            }
        }

        .ai-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .ai-icon {
            font-size: 1.5rem;
        }

        @media (max-width: 480px) {
            .ai-icon {
                font-size: 1.25rem;
            }
        }

        .ai-header h3 {
            font-size: 1rem;
            font-weight: 600;
            color: #8b5cf6;
            margin: 0;
        }

        @media (max-width: 480px) {
            .ai-header h3 {
                font-size: 0.875rem;
            }
        }

        .recommendation {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
        }

        @media (max-width: 480px) {
            .recommendation {
                gap: 0.5rem;
                padding: 0.5rem;
                border-radius: 6px;
            }
        }

        .rec-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        @media (max-width: 480px) {
            .rec-icon {
                font-size: 1rem;
            }
        }

        .recommendation p {
            font-size: 0.875rem;
            color: #475569;
            margin: 0;
            line-height: 1.4;
        }

        @media (max-width: 480px) {
            .recommendation p {
                font-size: 0.75rem;
            }
        }

        /* KPIs Grid Responsive */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .kpi-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 1rem;
            }
        }

        @media (max-width: 640px) {
            .kpi-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .kpi-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
        }

        .kpi-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            position: relative;
        }

        @media (max-width: 768px) {
            .kpi-card {
                padding: 1rem;
                border-radius: 12px;
            }
        }

        @media (max-width: 480px) {
            .kpi-card {
                padding: 0.75rem;
                border-radius: 8px;
            }
        }

        .kpi-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            .kpi-card:hover {
                transform: none;
            }
        }

        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .kpi-icon {
            font-size: 1.5rem;
            padding: 0.75rem;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 768px) {
            .kpi-icon {
                font-size: 1.25rem;
                padding: 0.5rem;
                border-radius: 8px;
            }
        }

        @media (max-width: 480px) {
            .kpi-icon {
                font-size: 1rem;
                padding: 0.4rem;
            }
        }

        .kpi-trend {
            font-size: 0.875rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            white-space: nowrap;
        }

        @media (max-width: 480px) {
            .kpi-trend {
                font-size: 0.75rem;
                padding: 0.2rem 0.5rem;
            }
        }

        .kpi-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        @media (max-width: 768px) {
            .kpi-value {
                font-size: 1.75rem;
            }
        }

        @media (max-width: 480px) {
            .kpi-value {
                font-size: 1.5rem;
            }
        }

        .kpi-label {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 1rem;
        }

        @media (max-width: 480px) {
            .kpi-label {
                font-size: 0.75rem;
                margin-bottom: 0.5rem;
            }
        }

        .kpi-sparkline,
        .kpi-progress {
            height: 8px;
            background: #f1f5f9;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #22c55e, #16a34a);
            transition: width 0.6s ease;
        }

        /* Additional Widgets Responsive */
        .additional-widgets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .additional-widgets {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 1rem;
            }
        }

        @media (max-width: 640px) {
            .additional-widgets {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .additional-widgets {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
        }

        .widget-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        @media (max-width: 768px) {
            .widget-card {
                padding: 1rem;
                border-radius: 12px;
            }
        }

        @media (max-width: 480px) {
            .widget-card {
                padding: 0.75rem;
                border-radius: 8px;
            }
        }

        .widget-card h3 {
            margin: 0 0 1rem 0;
            color: #1e293b;
            font-size: 1.1rem;
            font-weight: 600;
        }

        @media (max-width: 480px) {
            .widget-card h3 {
                font-size: 1rem;
                margin-bottom: 0.75rem;
            }
        }

        /* Tank Widget Responsive */
        .tank-visual {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        @media (max-width: 480px) {
            .tank-visual {
                gap: 0.75rem;
            }
        }

        .tank-container {
            position: relative;
            width: 60px;
            height: 120px;
            background: #f3f4f6;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
        }

        @media (max-width: 480px) {
            .tank-container {
                width: 50px;
                height: 100px;
            }
        }

        .tank-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(180deg, #3b82f6, #1d4ed8);
            transition: height 0.3s ease;
        }

        .tank-alert {
            position: absolute;
            top: 5px;
            right: 5px;
            color: #ef4444;
            font-size: 16px;
        }

        @media (max-width: 480px) {
            .tank-alert {
                font-size: 14px;
                top: 3px;
                right: 3px;
            }
        }

        .tank-info div {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.5rem;
        }

        @media (max-width: 480px) {
            .tank-info div {
                font-size: 1rem;
            }
        }

        /* Finance Widget Responsive */
        .finance-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .finance-row:last-of-type {
            border-bottom: none;
            font-weight: 600;
        }

        @media (max-width: 480px) {
            .finance-row {
                font-size: 0.875rem;
                padding: 0.4rem 0;
            }
        }

        /* Workers Widget Responsive */
        .workers-count {
            font-size: 2rem;
            font-weight: 700;
            color: #059669;
            text-align: center;
            margin: 1rem 0;
        }

        @media (max-width: 480px) {
            .workers-count {
                font-size: 1.5rem;
                margin: 0.75rem 0;
            }
        }

        .last-activity {
            font-size: 0.9rem;
            color: #6b7280;
            text-align: center;
            margin-bottom: 1rem;
        }

        @media (max-width: 480px) {
            .last-activity {
                font-size: 0.8rem;
                margin-bottom: 0.75rem;
            }
        }

        .sync-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            justify-content: center;
            font-weight: 500;
            transition: background-color 0.2s;
            font-size: 0.875rem;
        }

        @media (max-width: 480px) {
            .sync-button {
                padding: 0.625rem 0.75rem;
                font-size: 0.8rem;
                gap: 0.25rem;
            }
        }

        .sync-button:hover {
            background: #2563eb;
        }

        .sync-button .badge {
            background: #ef4444;
            color: white;
            border-radius: 50%;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            min-width: 20px;
            text-align: center;
        }

        @media (max-width: 480px) {
            .sync-button .badge {
                padding: 0.2rem 0.4rem;
                font-size: 0.65rem;
                min-width: 18px;
            }
        }

        /* Charts Grid Responsive */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        @media (max-width: 480px) {
            .charts-grid {
                gap: 0.75rem;
            }
        }

        .chart-card {
            background: #ffffff;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
        }

        @media (max-width: 768px) {
            .chart-card {
                padding: 1rem;
                border-radius: 12px;
            }
        }

        @media (max-width: 480px) {
            .chart-card {
                padding: 0.75rem;
                border-radius: 8px;
            }
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .chart-header h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
        }

        @media (max-width: 480px) {
            .chart-header h3 {
                font-size: 1rem;
            }
        }

        /* Weather Card Responsive */
        .weather-current {
            margin-bottom: 1rem;
        }

        .weather-main {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 480px) {
            .weather-main {
                gap: 0.75rem;
            }
        }

        #weather-icon {
            font-size: 2.5rem;
        }

        @media (max-width: 480px) {
            #weather-icon {
                font-size: 2rem;
            }
        }

        #current-temp {
            font-size: 2rem;
            font-weight: 700;
            color: #1e293b;
        }

        @media (max-width: 480px) {
            #current-temp {
                font-size: 1.5rem;
            }
        }

        .weather-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 480px) {
            .weather-details {
                gap: 0.5rem;
            }
        }

        .weather-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: #64748b;
        }

        @media (max-width: 480px) {
            .weather-item {
                font-size: 0.75rem;
                gap: 0.25rem;
            }
        }

        #weather-desc {
            text-align: center;
            color: #64748b;
            font-size: 0.9rem;
        }

        @media (max-width: 480px) {
            #weather-desc {
                font-size: 0.8rem;
            }
        }

        /* Map placeholder responsive */
        .map-placeholder {
            height: 300px;
            background: #f8fafc;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
        }

        @media (max-width: 768px) {
            .map-placeholder {
                height: 250px;
            }
        }

        @media (max-width: 480px) {
            .map-placeholder {
                height: 200px;
                border-radius: 6px;
            }
        }

        /* Canvas responsive */
        canvas {
            max-width: 100%;
            height: auto;
        }

        /* Utilities responsive */
        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: #ef4444;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        @media (max-width: 480px) {
            .live-indicator {
                font-size: 0.65rem;
                padding: 0.2rem 0.4rem;
            }
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        @media (max-width: 480px) {
            .btn-secondary {
                padding: 0.4rem 0.75rem;
                font-size: 0.75rem;
            }
        }

        .select-period {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            font-size: 0.875rem;
        }

        @media (max-width: 480px) {
            .select-period {
                padding: 0.4rem;
                font-size: 0.75rem;
            }
        }

        .profit-summary {
            display: flex;
            justify-content: space-around;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
        }

        @media (max-width: 480px) {
            .profit-summary {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        .profit-item {
            text-align: center;
        }

        .text-success {
            color: #22c55e;
        }

        /* Toast container responsive */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
        }

        @media (max-width: 768px) {
            .toast-container {
                top: 0.5rem;
                right: 0.5rem;
                left: 0.5rem;
            }
        }

        @media (max-width: 480px) {
            .toast-container {
                top: 0.25rem;
                right: 0.25rem;
                left: 0.25rem;
            }
        }
    </style>
</head>
<body>
    <!-- Loader -->
    <div id="loader" class="loader-container">
        <div class="loader">
            <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="30" fill="#84cc16" opacity="0.3"/>
                <path d="M50 20 Q30 40 35 60 T50 80 T65 60 T50 20" fill="#65a30d" class="lemon-path"/>
            </svg>
        </div>
        <p>Cargando Dashboard Inteligente...</p>
    </div>

    <!-- El sidebar ser√° creado autom√°ticamente por nav.js -->
    
    <!-- Contenido Principal -->
    <main class="main-content-wrapper">
        <section id="dashboard" class="dashboard-section">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <div class="welcome-section">
                    <h2 id="welcomeMessage">Buenos d√≠as, Administrador</h2>
                    <p id="dateDisplay">Mi√©rcoles, 3 de Septiembre 2025</p>
                </div>
                
                <!-- AI Assistant Card -->
                <div class="ai-assistant-card">
                    <div class="ai-header">
                        <span class="ai-icon">ü§ñ</span>
                        <h3>Asistente IA - Recomendaciones del D√≠a</h3>
                    </div>
                    <div class="ai-recommendations" id="aiRecommendations">
                        <div class="recommendation">
                            <span class="rec-icon">üíß</span>
                            <p>Basado en el clima, se recomienda aumentar el riego en el Bloque 3 en un 15% esta semana.</p>
                        </div>
                        <div class="recommendation">
                            <span class="rec-icon">üå°Ô∏è</span>
                            <p>Temperatura √≥ptima detectada para cosecha en los pr√≥ximos 3 d√≠as.</p>
                        </div>
                        <div class="recommendation">
                            <span class="rec-icon">üìà</span>
                            <p>ML predice incremento del 20% en producci√≥n para el pr√≥ximo mes basado en patrones hist√≥ricos.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- KPIs Principales -->
            <div class="kpi-grid">
                <div class="kpi-card" data-trend="up">
                    <div class="kpi-header">
                        <span class="kpi-icon">üçã</span>
                        <span class="kpi-trend" id="produccion-trend">+0%</span>
                    </div>
                    <div class="kpi-value" id="produccion-hoy">0</div>
                    <div class="kpi-label">Producci√≥n Hoy (unidades)</div>
                    <div class="kpi-sparkline">
                        <canvas id="productionSparkline" width="200" height="50"></canvas>
                    </div>
                </div>

                <div class="kpi-card" data-trend="up">
                    <div class="kpi-header">
                        <span class="kpi-icon">üí∞</span>
                        <span class="kpi-trend">+8%</span>
                    </div>
                    <div class="kpi-value" id="ingresos-hoy">Q 0.00</div>
                    <div class="kpi-label">Ingresos del Mes</div>
                    <div class="kpi-sparkline">
                        <canvas id="revenueSparkline" width="200" height="50"></canvas>
                    </div>
                </div>

                <div class="kpi-card" data-trend="neutral">
                    <div class="kpi-header">
                        <span class="kpi-icon">üå≥</span>
                        <span class="kpi-trend">100%</span>
                    </div>
                    <div class="kpi-value" id="arboles-sanos">800 de 800</div>
                    <div class="kpi-label">√Årboles Saludables</div>
                    <div class="kpi-progress">
                        <div class="progress-bar" id="health-progress" style="width: 98%"></div>
                    </div>
                </div>

                <div class="kpi-card" data-trend="down">
                    <div class="kpi-header">
                        <span class="kpi-icon">üí∏</span>
                        <span class="kpi-trend">-5%</span>
                    </div>
                    <div class="kpi-value" id="gastos-hoy">Q 0.00</div>
                    <div class="kpi-label">Gastos del Mes</div>
                    <div class="kpi-sparkline">
                        <canvas id="expensesSparkline" width="200" height="50"></canvas>
                    </div>
                </div>
            </div>

            <!-- Widgets Adicionales -->
            <div class="additional-widgets">
                <!-- Widget del tanque -->
                <div class="widget-card tank-widget">
                    <h3>Nivel del Tanque</h3>
                    <div class="tank-visual">
                        <div class="tank-container">
                            <div class="tank-fill" id="tank-fill" style="height: 100%"></div>
                            <span class="tank-alert" id="tank-alert" style="display:none;">‚ö†Ô∏è</span>
                        </div>
                        <div class="tank-info">
                            <div id="tanque-nivel">25,000L</div>
                            <div id="tank-percentage">100%</div>
                        </div>
                    </div>
                </div>

                <!-- Widget financiero -->
                <div class="widget-card finance-widget">
                    <h3>Resumen Financiero</h3>
                    <div class="finance-row">
                        <span>Balance Hoy:</span>
                        <span id="balance-hoy">Q0.00</span>
                    </div>
                    <div class="finance-row">
                        <span>Balance Mes:</span>
                        <span id="balance-mes">Q0.00</span>
                    </div>
                    <div class="finance-row">
                        <span>Precio MAGA:</span>
                        <span id="precio-actual">Q0.40</span>
                    </div>
                    <small id="precio-update">Act: --:--</small>
                </div>

                <!-- Widget de trabajadores -->
                <div class="widget-card workers-widget">
                    <h3>Trabajadores Activos</h3>
                    <div class="workers-count" id="trabajadores-activos">0</div>
                    <div class="last-activity" id="last-activity">√öltima actividad: --:--</div>
                    
                    <!-- Bot√≥n de sincronizaci√≥n -->
                    <button id="sync-now" class="sync-button">
                        <span class="material-icons-round">sync</span>
                        Sincronizar
                        <span id="pending-count" class="badge">0</span>
                    </button>
                </div>
            </div>

            <!-- Gr√°ficos y An√°lisis -->
            <div class="charts-grid">
                <!-- Estado del Clima -->
                <div class="chart-card weather-card">
                    <div class="chart-header">
                        <h3>Clima Actual y Pron√≥stico</h3>
                        <span class="live-indicator">‚óè EN VIVO</span>
                    </div>
                    <div class="weather-current">
                        <div class="weather-main">
                            <span id="weather-icon">üå§Ô∏è</span>
                            <div id="current-temp">--¬∞C</div>
                        </div>
                        <div class="weather-details">
                            <div class="weather-item">
                                <span class="material-icons-round">water_drop</span>
                                <span id="humidity">--%</span>
                            </div>
                            <div class="weather-item">
                                <span class="material-icons-round">air</span>
                                <span id="wind-speed">-- km/h</span>
                            </div>
                            <div class="weather-item">
                                <span class="material-icons-round">water</span>
                                <span id="rain-chance">--%</span>
                            </div>
                        </div>
                        <div id="weather-desc">Cargando clima...</div>
                    </div>
                    <canvas id="weatherForecast" width="400" height="200"></canvas>
                </div>

                <!-- Gr√°fico de Producci√≥n Mensual -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Producci√≥n Mensual</h3>
                        <select class="select-period" id="production-period">
                            <option value="6">√öltimos 6 meses</option>
                            <option value="12">√öltimo a√±o</option>
                        </select>
                    </div>
                    <canvas id="monthlyProductionChart" width="400" height="300"></canvas>
                </div>

                <!-- Gr√°fico de Ventas vs Gastos -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Ventas vs Gastos</h3>
                        <button class="btn-secondary">
                            <span class="material-icons-round">info</span>
                            Detalles
                        </button>
                    </div>
                    <canvas id="salesExpensesChart" width="400" height="300"></canvas>
                </div>

                <!-- An√°lisis de Rentabilidad -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>An√°lisis de Rentabilidad</h3>
                        <button class="btn-secondary">Detalles</button>
                    </div>
                    <canvas id="profitabilityChart" width="400" height="200"></canvas>
                    <div class="profit-summary">
                        <div class="profit-item">
                            <span>Margen Neto:</span>
                            <strong class="text-success" id="profit-margin">--</strong>
                        </div>
                        <div class="profit-item">
                            <span>ROI:</span>
                            <strong class="text-success" id="roi-percentage">--</strong>
                        </div>
                    </div>
                </div>

                <!-- Estado de Salud de √Årboles -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Estado de Salud de √Årboles</h3>
                        <span id="trees-last-update">√öltima actualizaci√≥n: --</span>
                    </div>
                    <canvas id="treesHealthChart" width="400" height="300"></canvas>
                </div>

                <!-- Predicci√≥n ML -->
                <div class="chart-card">
                    <div class="chart-header">
                        <h3>Predicci√≥n ML - Pr√≥ximos 30 d√≠as</h3>
                        <select class="select-period" id="ml-prediction-type">
                            <option value="production">Producci√≥n</option>
                            <option value="sales">Ventas</option>
                            <option value="weather">Clima</option>
                        </select>
                    </div>
                    <canvas id="mlPredictionChart" width="400" height="300"></canvas>
                </div>
            </div>
        </section>
    </main>

    <!-- Toast Notifications -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Scripts -->
    <script src="js/firebase-config.js"></script>
    <script src="js/offline.js"></script>
    <script src="js/clima.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/nav.js"></script>
    <script>
        // C√≥digo JavaScript mejorado con gr√°ficos reales y datos de Firebase
        (function(){
            // Helpers de elementos
            const $ = (id) => document.getElementById(id);

            // Variables para Firebase
            let db = null;
            let auth = null;
            let charts = {};

            // Funci√≥n mejorada para esperar Firebase
            function waitForFirebase() {
                return new Promise((resolve, reject) => {
                    let attempts = 0;
                    const maxAttempts = 50;
                    
                    const checkFirebase = () => {
                        attempts++;
                        console.log(`üîç Intento ${attempts}: Verificando Firebase...`);
                        
                        if (window.firebase && window.firebase.firestore && window.firebase.auth) {
                            try {
                                db = window.firebase.firestore();
                                auth = window.firebase.auth();
                                console.log('‚úÖ Firebase conectado directamente');
                                resolve();
                                return;
                            } catch (error) {
                                console.warn('‚ö†Ô∏è Error al conectar Firebase directamente:', error);
                            }
                        }
                        
                        if (window.db && window.auth) {
                            db = window.db;
                            auth = window.auth;
                            console.log('‚úÖ Firebase conectado via variables globales');
                            resolve();
                            return;
                        }
                        
                        if (attempts < maxAttempts) {
                            setTimeout(checkFirebase, 100);
                        } else {
                            console.error('‚ùå Firebase no disponible despu√©s de 5 segundos');
                            reject(new Error('Firebase no disponible'));
                        }
                    };
                    
                    checkFirebase();
                });
            }

            // Inicializar gr√°ficos
            function initializeCharts() {
                // Gr√°fico de Producci√≥n Mensual
                const monthlyCtx = $('monthlyProductionChart');
                if (monthlyCtx) {
                    charts.monthlyProduction = new Chart(monthlyCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Producci√≥n (unidades)',
                                data: [],
                                borderColor: '#22c55e',
                                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: '#f1f5f9'
                                    }
                                },
                                x: {
                                    grid: {
                                        color: '#f1f5f9'
                                    }
                                }
                            }
                        }
                    });
                }

                // Gr√°fico de Ventas vs Gastos
                const salesCtx = $('salesExpensesChart');
                if (salesCtx) {
                    charts.salesExpenses = new Chart(salesCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Ventas',
                                data: [],
                                backgroundColor: '#22c55e',
                                borderRadius: 4
                            }, {
                                label: 'Gastos',
                                data: [],
                                backgroundColor: '#ef4444',
                                borderRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'top'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: {
                                        color: '#f1f5f9'
                                    }
                                },
                                x: {
                                    grid: {
                                        color: '#f1f5f9'
                                    }
                                }
                            }
                        }
                    });
                }

                // Gr√°fico de Salud de √Årboles
                const treesCtx = $('treesHealthChart');
                if (treesCtx) {
                    charts.treesHealth = new Chart(treesCtx.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Sanos', 'Enfermos', 'En tratamiento'],
                            datasets: [{
                                data: [800, 0, 0],
                                backgroundColor: ['#22c55e', '#ef4444', '#f59e0b'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }

                // Sparklines para KPIs
                initializeSparklines();
            }

            function initializeSparklines() {
                // Sparkline de producci√≥n
                const prodCtx = $('productionSparkline');
                if (prodCtx) {
                    charts.productionSparkline = new Chart(prodCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: ['', '', '', '', '', '', ''],
                            datasets: [{
                                data: [0, 0, 0, 0, 0, 0, 0],
                                borderColor: '#22c55e',
                                borderWidth: 1,
                                pointRadius: 0,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { display: false },
                                y: { display: false }
                            },
                            elements: { point: { radius: 0 } }
                        }
                    });
                }

                // Sparkline de ingresos
                const revCtx = $('revenueSparkline');
                if (revCtx) {
                    charts.revenueSparkline = new Chart(revCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: ['', '', '', '', '', '', ''],
                            datasets: [{
                                data: [0, 0, 0, 0, 0, 0, 0],
                                borderColor: '#3b82f6',
                                borderWidth: 1,
                                pointRadius: 0,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                x: { display: false },
                                y: { display: false }
                            },
                            elements: { point: { radius: 0 } }
                        }
                    });
                }
            }

            // Cargar datos reales desde Firebase
            async function loadRealData() {
                if (!db) {
                    console.warn('Base de datos no disponible');
                    return;
                }

                try {
                    // Cargar producci√≥n mensual
                    await loadMonthlyProduction();
                    
                    // Cargar ventas vs gastos
                    await loadSalesExpensesData();
                    
                    // Cargar salud de √°rboles
                    await loadTreesHealthData();
                    
                    // Actualizar sparklines
                    await updateSparklines();

                } catch (error) {
                    console.error('Error cargando datos reales:', error);
                }
            }

            async function loadMonthlyProduction() {
                try {
                    const last6Months = [];
                    const productionData = [];
                    
                    // Generar √∫ltimos 6 meses
                    for (let i = 5; i >= 0; i--) {
                        const date = new Date();
                        date.setMonth(date.getMonth() - i);
                        const monthYear = date.toLocaleDateString('es-GT', { month: 'short', year: 'numeric' });
                        last6Months.push(monthYear);
                        
                        // Consultar producci√≥n del mes
                        const startOfMonth = new Date(date.getFullYear(), date.getMonth(), 1).toISOString().slice(0, 10);
                        const endOfMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).toISOString().slice(0, 10);
                        
                        const snapshot = await db.collection('cosechas_diarias')
                            .where('fecha', '>=', startOfMonth)
                            .where('fecha', '<=', endOfMonth)
                            .get();
                        
                        let monthTotal = 0;
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            monthTotal += (data.primera || 0) + (data.segunda || 0) + (data.descarte || 0);
                        });
                        
                        productionData.push(monthTotal);
                    }
                    
                    if (charts.monthlyProduction) {
                        charts.monthlyProduction.data.labels = last6Months;
                        charts.monthlyProduction.data.datasets[0].data = productionData;
                        charts.monthlyProduction.update();
                    }
                    
                } catch (error) {
                    console.error('Error cargando producci√≥n mensual:', error);
                }
            }

            async function loadSalesExpensesData() {
                try {
                    const last6Months = [];
                    const salesData = [];
                    const expensesData = [];
                    
                    for (let i = 5; i >= 0; i--) {
                        const date = new Date();
                        date.setMonth(date.getMonth() - i);
                        const monthYear = date.toLocaleDateString('es-GT', { month: 'short' });
                        last6Months.push(monthYear);
                        
                        const startOfMonth = new Date(date.getFullYear(), date.getMonth(), 1).toISOString().slice(0, 10);
                        const endOfMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).toISOString().slice(0, 10);
                        
                        // Consultar ventas
                        const salesSnapshot = await db.collection('ventas_directas')
                            .where('fecha', '>=', startOfMonth)
                            .where('fecha', '<=', endOfMonth)
                            .get();
                        
                        let monthSales = 0;
                        salesSnapshot.forEach(doc => {
                            monthSales += doc.data().total_venta || 0;
                        });
                        
                        // Consultar gastos
                        const expensesSnapshot = await db.collection('gastos')
                            .where('fecha', '>=', startOfMonth)
                            .where('fecha', '<=', endOfMonth)
                            .get();
                        
                        let monthExpenses = 0;
                        expensesSnapshot.forEach(doc => {
                            monthExpenses += doc.data().monto || 0;
                        });
                        
                        salesData.push(monthSales);
                        expensesData.push(monthExpenses);
                    }
                    
                    if (charts.salesExpenses) {
                        charts.salesExpenses.data.labels = last6Months;
                        charts.salesExpenses.data.datasets[0].data = salesData;
                        charts.salesExpenses.data.datasets[1].data = expensesData;
                        charts.salesExpenses.update();
                    }
                    
                } catch (error) {
                    console.error('Error cargando ventas vs gastos:', error);
                }
            }

            async function loadTreesHealthData() {
                try {
                    const treesSnapshot = await db.collection('arboles').get();
                    
                    let sanos = 0, enfermos = 0, tratamiento = 0;
                    
                    treesSnapshot.forEach(doc => {
                        const estado = doc.data().estado_salud || 'sano';
                        switch (estado) {
                            case 'sano':
                                sanos++;
                                break;
                            case 'enfermo':
                                enfermos++;
                                break;
                            case 'en_tratamiento':
                                tratamiento++;
                                break;
                            default:
                                sanos++;
                        }
                    });
                    
                    if (charts.treesHealth) {
                        charts.treesHealth.data.datasets[0].data = [sanos, enfermos, tratamiento];
                        charts.treesHealth.update();
                    }
                    
                    // Actualizar fecha de √∫ltima actualizaci√≥n
                    const updateEl = $('trees-last-update');
                    if (updateEl) {
                        updateEl.textContent = `√öltima actualizaci√≥n: ${new Date().toLocaleTimeString('es-GT')}`;
                    }
                    
                } catch (error) {
                    console.error('Error cargando salud de √°rboles:', error);
                }
            }

            async function updateSparklines() {
                try {
                    // √öltimos 7 d√≠as de producci√≥n
                    const last7Days = [];
                    const productionData = [];
                    
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        const dateStr = date.toISOString().slice(0, 10);
                        
                        const snapshot = await db.collection('cosechas_diarias')
                            .where('fecha', '==', dateStr)
                            .get();
                        
                        let dayTotal = 0;
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            dayTotal += (data.primera || 0) + (data.segunda || 0) + (data.descarte || 0);
                        });
                        
                        productionData.push(dayTotal);
                    }
                    
                    if (charts.productionSparkline) {
                        charts.productionSparkline.data.datasets[0].data = productionData;
                        charts.productionSparkline.update();
                    }
                    
                } catch (error) {
                    console.error('Error actualizando sparklines:', error);
                }
            }

            // Inicializaci√≥n principal
            document.addEventListener('DOMContentLoaded', async () => {
                try {
                    console.log('üöÄ Inicializando dashboard responsive...');
                    
                    // Esperar Firebase
                    try {
                        await waitForFirebase();
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Continuando sin Firebase:', error.message);
                    }
                    
                    // Inicializar gr√°ficos
                    initializeCharts();
                    
                    // Cargar datos reales
                    await loadRealData();
                    
                    // Configurar actualizaciones
                    setInterval(loadRealData, 300000); // Cada 5 minutos
                    
                    console.log('‚úÖ Dashboard responsive inicializado');
                    
                } catch (error) {
                    console.error('‚ùå Error inicializando dashboard:', error);
                }
            });

            // Funci√≥n para actualizar fecha y saludo
            function updateWelcomeMessage() {
                const now = new Date();
                const hour = now.getHours();
                let greeting;
                
                if (hour < 12) greeting = 'Buenos d√≠as';
                else if (hour < 18) greeting = 'Buenas tardes';
                else greeting = 'Buenas noches';
                
                const welcomeEl = $('welcomeMessage');
                if (welcomeEl) {
                    welcomeEl.textContent = `${greeting}, Administrador`;
                }
                
                const dateEl = $('dateDisplay');
                if (dateEl) {
                    dateEl.textContent = now.toLocaleDateString('es-GT', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                }
            }

            // Actualizar mensaje de bienvenida cada minuto
            setInterval(updateWelcomeMessage, 60000);
            updateWelcomeMessage();

        })();
    </script>
    <script src="js/index.js"></script>
</body>
</html>
