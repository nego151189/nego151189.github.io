<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Gesti√≥n Clim√°tica - Finca La Herradura</title>
    
    <!-- Meta tags -->
    <meta name="description" content="Monitoreo clim√°tico inteligente con IA y predicciones para optimizar la producci√≥n agr√≠cola">
    <meta name="keywords" content="clima, meteorolog√≠a, agricultura, predicci√≥n, IA, sensores">
    
    <!-- Favicon y PWA -->
    <link rel="icon" type="image/x-icon" href="/icons/favicon.ico">
    <link rel="manifest" href="/manifest.json">
    
    <!-- CSS -->
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/style.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <style>
        /* Estilos adicionales responsive mejorados */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .chart-container {
                height: 250px;
            }
        }
        
        @media (max-width: 480px) {
            .chart-container {
                height: 200px;
            }
        }

        .clima-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .page-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .title-icon {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .estado-conexion {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .estado-conexion.online {
            background: rgba(34, 197, 94, 0.2);
            color: #16a34a;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .estado-conexion.offline {
            background: rgba(239, 68, 68, 0.2);
            color: #dc2626;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .clima-actual {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 24px;
            padding: 2rem;
            color: white;
            margin-bottom: 2rem;
            position: relative;
            overflow: hidden;
        }

        .clima-actual::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: float 8s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(180deg); }
        }

        .clima-principal {
            display: grid;
            grid-template-columns: auto 1fr auto;
            align-items: center;
            gap: 2rem;
            margin-bottom: 2rem;
            position: relative;
            z-index: 1;
        }

        .temperatura-principal {
            font-size: 4rem;
            font-weight: 300;
            margin: 0;
            display: flex;
            align-items: flex-start;
        }

        .grado-symbol {
            font-size: 2rem;
            margin-top: 0.5rem;
        }

        .clima-info {
            text-align: center;
        }

        .clima-descripcion {
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .sensacion-termica {
            opacity: 0.9;
            font-size: 0.875rem;
        }

        .clima-icono-principal {
            font-size: 4rem;
            opacity: 0.9;
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .clima-detalles {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .clima-detalle {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .detalle-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            opacity: 0.9;
        }

        .detalle-valor {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .detalle-label {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        .alertas-climaticas {
            margin-bottom: 2rem;
        }

        .alerta-clima {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .alerta-clima.warning {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.05);
        }

        .alerta-clima.danger {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.05);
        }

        .alerta-clima.info {
            border-left-color: #3b82f6;
            background: rgba(59, 130, 246, 0.05);
        }

        .alerta-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            color: white;
        }

        .alerta-clima.warning .alerta-icon {
            background: #f59e0b;
        }

        .alerta-clima.danger .alerta-icon {
            background: #ef4444;
        }

        .alerta-clima.info .alerta-icon {
            background: #3b82f6;
        }

        .contenido-principal {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .graficos-container {
            display: grid;
            gap: 2rem;
        }

        .grafico-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
        }

        .grafico-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .grafico-titulo {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .periodo-selector {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 0.25rem;
        }

        .periodo-btn {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }

        .periodo-btn.active {
            background: var(--primary);
            color: white;
        }

        .prediccion-container {
            display: grid;
            gap: 1.5rem;
        }

        .prediccion-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
        }

        .prediccion-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .prediccion-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #8b5cf6, #a855f7);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .pronostico-dias {
            display: grid;
            gap: 1rem;
        }

        .dia-pronostico {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .dia-pronostico:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        .dia-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .dia-fecha {
            font-weight: 600;
            color: var(--text-primary);
        }

        .dia-descripcion {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .dia-clima {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .dia-icon {
            font-size: 1.5rem;
            color: #3b82f6;
        }

        .temperatura-rango {
            text-align: right;
        }

        .temp-max {
            font-weight: 600;
            color: var(--text-primary);
        }

        .temp-min {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .recomendaciones-ia {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(167, 139, 250, 0.1));
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .recomendacion-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
        }

        .recomendacion-icon {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .sensores-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .sensor-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
        }

        .sensor-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .sensor-valor {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .sensor-estado {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            display: inline-block;
        }

        .sensor-estado.online {
            background: rgba(34, 197, 94, 0.2);
            color: #16a34a;
        }

        .sensor-estado.offline {
            background: rgba(239, 68, 68, 0.2);
            color: #dc2626;
        }

        .historico-controles {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .export-btn {
            margin-left: auto;
        }

        @media (max-width: 1024px) {
            .contenido-principal {
                grid-template-columns: 1fr;
            }
            
            .clima-principal {
                grid-template-columns: 1fr;
                text-align: center;
                gap: 1rem;
            }
            
            .temperatura-principal {
                font-size: 3rem;
                justify-content: center;
            }
        }

        @media (max-width: 768px) {
            .clima-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .clima-detalles {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .sensores-status {
                grid-template-columns: 1fr;
            }
            
            .historico-controles {
                flex-direction: column;
                align-items: stretch;
            }
            
            .export-btn {
                margin-left: 0;
            }
        }

        @media (max-width: 480px) {
            .clima-actual {
                padding: 1rem;
            }
            
            .temperatura-principal {
                font-size: 3rem !important;
            }
            
            .clima-detalles {
                gap: 0.5rem;
            }
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            font-size: 2rem;
            color: var(--text-secondary);
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #fecaca;
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
            margin: 1rem 0;
        }

        .initialization-loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            color: white;
            font-size: 1.2rem;
        }

        .initialization-loader.hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Loader de inicializaci√≥n -->
    <div class="initialization-loader" id="initLoader">
        <div style="text-align: center;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">
                <i class="fas fa-cloud-sun fa-spin"></i>
            </div>
            <div>Inicializando sistema clim√°tico...</div>
            <div style="font-size: 0.9rem; opacity: 0.7; margin-top: 0.5rem;">
                Conectando con servicios de Finca La Herradura
            </div>
        </div>
    </div>

    <!-- Navegaci√≥n -->
    <nav id="navbar"></nav>

    <!-- Contenido principal -->
    <main class="main-content-wrapper">
        <!-- Header de la p√°gina -->
        <header class="clima-header">
            <div class="page-title">
                <div class="title-icon">
                    <i class="fas fa-cloud-sun"></i>
                </div>
                <div>
                    <h1>Gesti√≥n Clim√°tica</h1>
                    <p>Monitoreo inteligente y predicciones con IA</p>
                </div>
            </div>
            
            <div class="header-actions">
                <div class="estado-conexion online" id="estadoConexion">
                    <i class="fas fa-wifi"></i>
                    <span>Conectado</span>
                </div>
                
                <button class="btn btn-primary" id="btnActualizar">
                    <i class="fas fa-sync-alt"></i> Actualizar
                </button>
                
                <button class="btn btn-secondary" id="btnConfiguracion">
                    <i class="fas fa-cog"></i> Configurar
                </button>
            </div>
        </header>

        <!-- Clima actual -->
        <section class="clima-actual">
            <div class="clima-principal">
                <div class="temperatura-principal">
                    <span id="temperaturaActual">--</span>
                    <span class="grado-symbol">¬∞C</span>
                </div>
                
                <div class="clima-info">
                    <div class="clima-descripcion" id="climaDescripcion">Cargando...</div>
                    <div class="sensacion-termica">
                        Sensaci√≥n t√©rmica: <span id="sensacionTermica">--¬∞C</span>
                    </div>
                    <div class="ubicacion">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>Finca La Herradura, Guatemala</span>
                    </div>
                </div>
                
                <div class="clima-icono-principal">
                    <i id="iconoClimaPrincipal" class="fas fa-sun"></i>
                </div>
            </div>
            
            <div class="clima-detalles">
                <div class="clima-detalle">
                    <div class="detalle-icon">
                        <i class="fas fa-tint"></i>
                    </div>
                    <div class="detalle-valor" id="humedad">--%</div>
                    <div class="detalle-label">Humedad</div>
                </div>
                
                <div class="clima-detalle">
                    <div class="detalle-icon">
                        <i class="fas fa-wind"></i>
                    </div>
                    <div class="detalle-valor" id="viento">-- km/h</div>
                    <div class="detalle-label">Viento</div>
                </div>
                
                <div class="clima-detalle">
                    <div class="detalle-icon">
                        <i class="fas fa-eye"></i>
                    </div>
                    <div class="detalle-valor" id="visibilidad">-- km</div>
                    <div class="detalle-label">Visibilidad</div>
                </div>
                
                <div class="clima-detalle">
                    <div class="detalle-icon">
                        <i class="fas fa-thermometer-half"></i>
                    </div>
                    <div class="detalle-valor" id="presion">-- hPa</div>
                    <div class="detalle-label">Presi√≥n</div>
                </div>
                
                <div class="clima-detalle">
                    <div class="detalle-icon">
                        <i class="fas fa-sun"></i>
                    </div>
                    <div class="detalle-valor" id="uvIndex">--</div>
                    <div class="detalle-label">√çndice UV</div>
                </div>
                
                <div class="clima-detalle">
                    <div class="detalle-icon">
                        <i class="fas fa-cloud-rain"></i>
                    </div>
                    <div class="detalle-valor" id="precipitacion">-- mm</div>
                    <div class="detalle-label">Lluvia (24h)</div>
                </div>
            </div>
        </section>

        <!-- Alertas clim√°ticas -->
        <section class="alertas-climaticas" id="alertasClimaticas">
            <!-- Las alertas se cargar√°n din√°micamente -->
        </section>

        <!-- Estado de sensores -->
        <section class="sensores-status">
            <div class="sensor-card">
                <div class="sensor-icon" style="color: #22c55e;">
                    <i class="fas fa-thermometer-three-quarters"></i>
                </div>
                <div class="sensor-valor" id="sensorTemperatura">25.3¬∞C</div>
                <div class="sensor-label">Sensor Temperatura</div>
                <div class="sensor-estado online">Online</div>
            </div>
            
            <div class="sensor-card">
                <div class="sensor-icon" style="color: #3b82f6;">
                    <i class="fas fa-tint"></i>
                </div>
                <div class="sensor-valor" id="sensorHumedad">68%</div>
                <div class="sensor-label">Sensor Humedad</div>
                <div class="sensor-estado online">Online</div>
            </div>
            
            <div class="sensor-card">
                <div class="sensor-icon" style="color: #f59e0b;">
                    <i class="fas fa-seedling"></i>
                </div>
                <div class="sensor-valor" id="sensorSuelo">42%</div>
                <div class="sensor-label">Humedad del Suelo</div>
                <div class="sensor-estado offline">Offline</div>
            </div>
            
            <div class="sensor-card">
                <div class="sensor-icon" style="color: #8b5cf6;">
                    <i class="fas fa-wind"></i>
                </div>
                <div class="sensor-valor" id="sensorViento">12 km/h</div>
                <div class="sensor-label">Anem√≥metro</div>
                <div class="sensor-estado online">Online</div>
            </div>
        </section>

        <!-- Contenido principal -->
        <div class="contenido-principal">
            <!-- Gr√°ficos -->
            <div class="graficos-container">
                <!-- Gr√°fico de temperatura -->
                <div class="grafico-card">
                    <div class="grafico-header">
                        <h3 class="grafico-titulo">
                            <i class="fas fa-thermometer-half"></i>
                            Temperatura y Humedad
                        </h3>
                        <div class="periodo-selector">
                            <button class="periodo-btn active" data-periodo="24h">24h</button>
                            <button class="periodo-btn" data-periodo="7d">7d</button>
                            <button class="periodo-btn" data-periodo="30d">30d</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="graficoTemperatura"></canvas>
                    </div>
                </div>
                
                <!-- Gr√°fico de precipitaci√≥n -->
                <div class="grafico-card">
                    <div class="grafico-header">
                        <h3 class="grafico-titulo">
                            <i class="fas fa-cloud-rain"></i>
                            Precipitaci√≥n
                        </h3>
                        <div class="historico-controles">
                            <button class="btn btn-sm btn-secondary" id="btnHistoricoLluvia">
                                <i class="fas fa-history"></i> Hist√≥rico
                            </button>
                            <button class="btn btn-sm btn-primary export-btn" id="btnExportarDatos">
                                <i class="fas fa-download"></i> Exportar
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="graficoPrecipitacion"></canvas>
                    </div>
                </div>
            </div>

            <!-- Predicciones y recomendaciones -->
            <div class="prediccion-container">
                <!-- Pron√≥stico -->
                <div class="prediccion-card">
                    <div class="prediccion-header">
                        <div class="prediccion-icon">
                            <i class="fas fa-calendar-alt"></i>
                        </div>
                        <h3>Pron√≥stico 7 d√≠as</h3>
                    </div>
                    
                    <div class="pronostico-dias" id="pronosticoDias">
                        <!-- Los d√≠as se cargar√°n din√°micamente -->
                    </div>
                </div>

                <!-- Recomendaciones IA -->
                <div class="recomendaciones-ia">
                    <div class="prediccion-header">
                        <div class="prediccion-icon">
                            <i class="fas fa-robot"></i>
                        </div>
                        <h3>Recomendaciones IA</h3>
                    </div>
                    
                    <div id="recomendacionesIA">
                        <!-- Las recomendaciones se cargar√°n din√°micamente -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal de configuraci√≥n -->
    <div class="modal-overlay" id="modalConfiguracion">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Configuraci√≥n Clim√°tica</h2>
                <button class="modal-close" id="cerrarModalConfig">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Frecuencia de actualizaci√≥n</label>
                    <select class="form-input" id="frecuenciaActualizacion">
                        <option value="5">Cada 5 minutos</option>
                        <option value="15" selected>Cada 15 minutos</option>
                        <option value="30">Cada 30 minutos</option>
                        <option value="60">Cada hora</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Alertas de temperatura</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label class="form-label">Temperatura m√≠nima (¬∞C)</label>
                            <input type="number" class="form-input" id="tempMinima" value="5">
                        </div>
                        <div>
                            <label class="form-label">Temperatura m√°xima (¬∞C)</label>
                            <input type="number" class="form-input" id="tempMaxima" value="35">
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Alertas de humedad</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label class="form-label">Humedad m√≠nima (%)</label>
                            <input type="number" class="form-input" id="humedadMinima" value="30">
                        </div>
                        <div>
                            <label class="form-label">Humedad m√°xima (%)</label>
                            <input type="number" class="form-input" id="humedadMaxima" value="85">
                        </div>
                    </div>
                </div>
                
                <div class="form-checkbox">
                    <input type="checkbox" id="notificacionesPush" checked>
                    <label for="notificacionesPush">Recibir notificaciones push</label>
                </div>
                
                <div class="form-checkbox">
                    <input type="checkbox" id="alertasEmail" checked>
                    <label for="alertasEmail">Enviar alertas por email</label>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button class="btn btn-primary" id="guardarConfiguracion">
                        <i class="fas fa-save"></i> Guardar
                    </button>
                    <button class="btn btn-secondary" id="resetearConfiguracion">
                        <i class="fas fa-undo"></i> Restablecer
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts Firebase (deben cargarse primero) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <!-- Scripts de aplicaci√≥n -->
    <script type="module" src="/js/firebase-config.js"></script>
    <script type="module" src="/js/auth.js"></script>
    <script type="module" src="/js/finca-navigation.js"></script>
    <script type="module" src="/js/offline.js"></script>
    <script type="module" src="/js/clima.js"></script>
     
    <script>
        // Variables globales
        let graficoTemperatura, graficoPrecipitacion;
        let intervaloActualizacion;
        let sistemaInicializado = false;

        // ==========================================
        // FUNCIONES DE ESPERA Y INICIALIZACI√ìN CORREGIDAS
        // ==========================================

        /**
         * Espera a que AuthManager est√© completamente inicializado
         */
        async function esperarAuthManager() {
            return new Promise((resolve) => {
                const maxWait = 10000; // 10 segundos m√°ximo
                const checkInterval = 100;
                let elapsed = 0;

                const check = () => {
                    if (window.authManager && window.authManager.isInitialized) {
                        console.log('‚úÖ AuthManager listo y inicializado');
                        resolve(true);
                    } else if (elapsed < maxWait) {
                        elapsed += checkInterval;
                        setTimeout(check, checkInterval);
                    } else {
                        console.warn('‚ö†Ô∏è Timeout esperando AuthManager');
                        resolve(false);
                    }
                };

                check();
            });
        }

        /**
         * SOLUCI√ìN PRINCIPAL: Verificaci√≥n mejorada de autenticaci√≥n
         */
async function verificarAutenticacion() {
    try {
        console.log('üîê Verificando autenticaci√≥n...');
        
        // Esperar a que AuthManager est√© completamente inicializado
        const authManagerListo = await esperarAuthManager();
        
        if (!authManagerListo) {
            console.log('‚ö†Ô∏è AuthManager no disponible, continuando en modo offline');
            return true; // Permitir acceso en modo offline
        }

        // Verificar el estado de autenticaci√≥n
        const authState = window.authManager.getAuthState();
        
        console.log('üìä Estado de autenticaci√≥n:', {
            isAuthenticated: authState.isAuthenticated,
            user: authState.user?.email || 'Sin usuario',
            role: authState.role
        });

        // Permitir acceso si est√° autenticado o en modo offline
        if (authState.isAuthenticated || authState.isOffline) {
            console.log('‚úÖ Acceso permitido (autenticado o modo offline)');
            return true;
        }

        console.log('‚ùå Usuario no autenticado');
        return false;

    } catch (error) {
        console.error('‚ùå Error verificando autenticaci√≥n:', error);
        // En caso de error, permitir acceso para no bloquear la aplicaci√≥n
        return true;
    }
}

        /**
         * Espera a que Firebase est√© listo
         */
        async function esperarFirebase() {
            return new Promise((resolve) => {
                const maxWait = 10000;
                const checkInterval = 100;
                let elapsed = 0;

                const check = () => {
                    if (window.firebase && window.auth && window.db) {
                        console.log('‚úÖ Firebase disponible');
                        resolve(true);
                    } else if (elapsed < maxWait) {
                        elapsed += checkInterval;
                        setTimeout(check, checkInterval);
                    } else {
                        console.warn('‚ö†Ô∏è Timeout esperando Firebase');
                        resolve(false);
                    }
                };

                // Tambi√©n escuchar el evento firebaseReady
                window.addEventListener('firebaseReady', () => {
                    console.log('üî• Evento firebaseReady recibido');
                    resolve(true);
                }, { once: true });

                check();
            });
        }

        /**
         * Espera a que ClimateManager est√© listo
         */
        async function esperarClimateManager() {
            return new Promise((resolve) => {
                const maxWait = 15000;
                const checkInterval = 200;
                let elapsed = 0;

                const check = () => {
                    if (window.climateManager || window.climaManager) {
                        console.log('‚úÖ ClimateManager disponible');
                        resolve(true);
                    } else if (elapsed < maxWait) {
                        elapsed += checkInterval;
                        setTimeout(check, checkInterval);
                    } else {
                        console.warn('‚ö†Ô∏è Timeout esperando ClimateManager');
                        resolve(false);
                    }
                };

                check();
            });
        }

        // ==========================================
        // INICIALIZACI√ìN PRINCIPAL CORREGIDA
        // ==========================================

       document.addEventListener('DOMContentLoaded', async () => {
    try {
        console.log('üå¶Ô∏è Iniciando aplicaci√≥n clim√°tica...');
        console.log('üìç Ubicaci√≥n de la finca: 14.77073, -90.25398');
        
        // Mostrar loader
        document.getElementById('initLoader').classList.remove('hidden');

        // Paso 1: Esperar Firebase
        const firebaseReady = await esperarFirebase();
        if (!firebaseReady) {
            console.warn('‚ö†Ô∏è Firebase no disponible, continuando...');
        }

        // Paso 2: Verificar autenticaci√≥n (PERMITIR ACCESO A CLIMA.HTML SIEMPRE)
        console.log('üîê Verificando autenticaci√≥n para clima.html...');
        
        // Esperar a que AuthManager est√© completamente inicializado
        await esperarAuthManager();
        
        // Obtener estado de autenticaci√≥n pero NO redirigir
        const authState = window.authManager ? window.authManager.getAuthState() : { 
            isAuthenticated: false, 
            isOffline: true 
        };
        
        console.log('üìä Estado de autenticaci√≥n:', {
            isAuthenticated: authState.isAuthenticated,
            isOffline: authState.isOffline,
            user: authState.user ? authState.user.email : 'Sin usuario'
        });

        // Paso 3: Esperar ClimateManager
        await esperarClimateManager();

        // Paso 4: Inicializar aplicaci√≥n
        await inicializarPagina();

        sistemaInicializado = true;
        console.log('üéâ Sistema clim√°tico completamente inicializado');

    } catch (error) {
        console.error('‚ùå Error en inicializaci√≥n:', error);
        mostrarError('Error iniciando la aplicaci√≥n clim√°tica');
        
        // Intentar inicializar en modo offline
        try {
            await inicializarPagina();
            sistemaInicializado = true;
        } catch (fallbackError) {
            console.error('‚ùå Error tambi√©n en modo offline:', fallbackError);
        }
    } finally {
        // Ocultar loader
        setTimeout(() => {
            document.getElementById('initLoader').classList.add('hidden');
        }, 500);
    }
});
        async function inicializarPagina() {
            try {
                console.log('‚öôÔ∏è Inicializando componentes de la p√°gina...');
                
                // Configurar event listeners
                configurarEventListeners();
                
                // Cargar datos clim√°ticos iniciales
                await cargarDatosClimaticos();
                
                // Inicializar gr√°ficos
                inicializarGraficos();
                
                // Configurar actualizaci√≥n autom√°tica
                configurarActualizacionAutomatica();
                
                // Cargar pron√≥stico
                await cargarPronostico();
                
                // Generar recomendaciones IA
                await generarRecomendacionesIA();
                
                console.log('‚úÖ P√°gina clim√°tica inicializada correctamente');
                
            } catch (error) {
                console.error('‚ùå Error inicializando p√°gina:', error);
                mostrarError('Error cargando los datos clim√°ticos');
            }
        }

        // ==========================================
        // CONFIGURACI√ìN DE EVENTOS
        // ==========================================

        function configurarEventListeners() {
            // Botones principales
            document.getElementById('btnActualizar')?.addEventListener('click', actualizarDatos);
            document.getElementById('btnConfiguracion')?.addEventListener('click', abrirConfiguracion);
            document.getElementById('btnExportarDatos')?.addEventListener('click', exportarDatos);
            document.getElementById('btnHistoricoLluvia')?.addEventListener('click', mostrarHistoricoLluvia);
            
            // Modal de configuraci√≥n
            document.getElementById('cerrarModalConfig')?.addEventListener('click', cerrarConfiguracion);
            document.getElementById('guardarConfiguracion')?.addEventListener('click', guardarConfiguracion);
            document.getElementById('resetearConfiguracion')?.addEventListener('click', resetearConfiguracion);
            
            // Selectores de per√≠odo
            document.querySelectorAll('.periodo-btn').forEach(btn => {
                btn.addEventListener('click', (e) => cambiarPeriodo(e.target.dataset.periodo));
            });

            // Monitorear conectividad
            window.addEventListener('online', () => {
                actualizarEstadoConexion(true);
                if (sistemaInicializado) {
                    actualizarDatos();
                }
            });

            window.addEventListener('offline', () => {
                actualizarEstadoConexion(false);
            });

            console.log('‚úÖ Event listeners configurados');
        }

        function actualizarEstadoConexion(isOnline) {
            const elemento = document.getElementById('estadoConexion');
            if (elemento) {
                elemento.className = `estado-conexion ${isOnline ? 'online' : 'offline'}`;
                elemento.innerHTML = `<i class="fas fa-wifi${isOnline ? '' : '-slash'}"></i><span>${isOnline ? 'Conectado' : 'Sin conexi√≥n'}</span>`;
            }
        }

        // ==========================================
        // FUNCIONES DE DATOS CLIM√ÅTICOS
        // ==========================================

        async function cargarDatosClimaticos() {
            try {
                mostrarCargando(true);
                
                // Usar el gestor clim√°tico disponible
                const gestor = window.climateManager || window.climaManager;
                if (gestor && gestor.getCurrentWeather) {
                    // Obtener datos reales
                    await gestor.getCurrentWeather();
                    const datosActuales = gestor.currentWeather;
                    
                    if (datosActuales) {
                        actualizarInterfazClima(datosActuales);
                        
                        // Verificar alertas
                        const alertas = await verificarAlertas({ current: datosActuales });
                        if (alertas.length > 0) {
                            mostrarAlertas(alertas);
                        }
                    }
                    
                    // Actualizar estado de sensores
                    actualizarEstadoSensores();
                } else {
                    console.warn('‚ö†Ô∏è Gestor clim√°tico no disponible');
                    // Usar datos simulados como fallback
                    const datosSimulados = await obtenerDatosSimulados();
                    actualizarInterfazClima(datosSimulados);
                }
                
            } catch (error) {
                console.error('‚ùå Error cargando datos clim√°ticos:', error);
                const datosBackup = await obtenerDatosSimulados();
                actualizarInterfazClima(datosBackup);
            } finally {
                mostrarCargando(false);
            }
        }

        // Funci√≥n de respaldo para datos simulados (solo para desarrollo)
        async function obtenerDatosSimulados() {
            // Simular datos para la ubicaci√≥n de la finca
            return {
                temperature_2m: 22 + Math.random() * 8,  // Guatemala t√≠pico 22-30¬∞C
                relative_humidity_2m: 65 + Math.random() * 20,  // Humedad t√≠pica Guatemala
                apparent_temperature: 24 + Math.random() * 8,
                precipitation: Math.random() * 10,
                wind_speed_10m: 5 + Math.random() * 15,
                pressure_msl: 1013 + Math.random() * 10,
                uv_index: 8 + Math.floor(Math.random() * 4),  // UV alto t√≠pico de Guatemala
                weather_code: 'partly-cloudy'
            };
        }

        function actualizarInterfazClima(datos) {
            try {
                // Actualizar temperatura principal
                document.getElementById('temperaturaActual').textContent = Math.round(datos.temperature_2m || datos.temperatura || 0);
                document.getElementById('climaDescripcion').textContent = datos.descripcion || obtenerDescripcionClima(datos.weather_code);
                document.getElementById('sensacionTermica').textContent = `${Math.round(datos.apparent_temperature || datos.sensacionTermica || datos.temperature_2m || 0)}¬∞C`;
                
                // Actualizar icono principal
                const iconoElement = document.getElementById('iconoClimaPrincipal');
                iconoElement.className = `fas ${obtenerIconoClima(datos.weather_code || datos.codigo)}`;
                
                // Actualizar detalles
                document.getElementById('humedad').textContent = `${Math.round(datos.relative_humidity_2m || datos.humedad || 0)}%`;
                document.getElementById('viento').textContent = `${Math.round(datos.wind_speed_10m || datos.velocidadViento || 0)} km/h`;
                document.getElementById('visibilidad').textContent = `${datos.visibilidad || '10'} km`;
                document.getElementById('presion').textContent = `${Math.round(datos.pressure_msl || datos.presion || 1013)} hPa`;
                document.getElementById('uvIndex').textContent = datos.uv_index || datos.indiceUV || '--';
                document.getElementById('precipitacion').textContent = `${(datos.precipitation || datos.precipitacion24h || 0).toFixed(1)} mm`;

                console.log('‚úÖ Interfaz clim√°tica actualizada con datos reales');
            } catch (error) {
                console.error('‚ùå Error actualizando interfaz:', error);
            }
        }

        function obtenerDescripcionClima(codigo) {
            const descripciones = {
                'clear': 'Despejado',
                'partly-cloudy': 'Parcialmente nublado',
                'cloudy': 'Nublado',
                'rain': 'Lluvia',
                'snow': 'Nieve',
                'storm': 'Tormenta',
                'fog': 'Niebla'
            };
            return descripciones[codigo] || 'Condiciones variables';
        }

        function obtenerIconoClima(codigo) {
            const iconos = {
                'clear': 'fa-sun',
                'partly-cloudy': 'fa-cloud-sun',
                'cloudy': 'fa-cloud',
                'rain': 'fa-cloud-rain',
                'snow': 'fa-snowflake',
                'storm': 'fa-bolt',
                'fog': 'fa-smog'
            };
            return iconos[codigo] || 'fa-sun';
        }

        async function verificarAlertas(datos) {
            const alertas = [];
            
            if (!datos || !datos.current) return alertas;
            
            const current = datos.current;
            
            // Alertas de temperatura para Guatemala
            if (current.temperature_2m > 32) {
                alertas.push({
                    tipo: 'danger',
                    icono: 'fa-thermometer-full',
                    titulo: 'Temperatura Alta',
                    mensaje: 'Temperatura muy elevada para los limones. Incrementar riego.',
                    accion: 'Ver recomendaciones'
                });
            }
            
            if (current.temperature_2m < 10) {
                alertas.push({
                    tipo: 'warning',
                    icono: 'fa-snowflake',
                    titulo: 'Temperatura Baja',
                    mensaje: 'Temperatura baja para la regi√≥n. Proteger plantas j√≥venes.',
                    accion: 'Medidas de protecci√≥n'
                });
            }
            
            // Alertas de viento
            if (current.wind_speed_10m > 40) {
                alertas.push({
                    tipo: 'danger',
                    icono: 'fa-wind',
                    titulo: 'Vientos Fuertes',
                    mensaje: 'Vientos peligrosos. Revisar estructuras y asegurar plantas.',
                    accion: 'Plan de emergencia'
                });
            }
            
            // Alertas de humedad
            if (current.relative_humidity_2m > 85) {
                alertas.push({
                    tipo: 'info',
                    icono: 'fa-tint',
                    titulo: 'Humedad Alta',
                    mensaje: 'Condiciones favorables para hongos. Aplicar fungicidas preventivos.',
                    accion: 'Ver tratamientos'
                });
            }
            
            return alertas;
        }

        function mostrarAlertas(alertas) {
            const container = document.getElementById('alertasClimaticas');
            
            if (alertas.length === 0) {
                container.innerHTML = '';
                return;
            }
            
            container.innerHTML = alertas.map(alerta => `
                <div class="alerta-clima ${alerta.tipo}">
                    <div class="alerta-icon">
                        <i class="fas ${alerta.icono}"></i>
                    </div>
                    <div class="alerta-contenido">
                        <h4>${alerta.titulo}</h4>
                        <p>${alerta.mensaje}</p>
                        ${alerta.accion ? `<button class="btn btn-sm btn-primary">${alerta.accion}</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // ==========================================
        // FUNCIONES DE GR√ÅFICOS
        // ==========================================

        function inicializarGraficos() {
            try {
                // Gr√°fico de temperatura y humedad
                const ctxTemp = document.getElementById('graficoTemperatura');
                if (ctxTemp) {
                    graficoTemperatura = new Chart(ctxTemp, {
                        type: 'line',
                        data: {
                            labels: [],
                            datasets: [
                                {
                                    label: 'Temperatura (¬∞C)',
                                    data: [],
                                    borderColor: '#ef4444',
                                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                    tension: 0.4,
                                    yAxisID: 'y'
                                },
                                {
                                    label: 'Humedad (%)',
                                    data: [],
                                    borderColor: '#3b82f6',
                                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                    tension: 0.4,
                                    yAxisID: 'y1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    labels: { 
                                        color: '#333'
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    ticks: { 
                                        color: '#666'
                                    },
                                    grid: { 
                                        color: 'rgba(0, 0, 0, 0.1)'
                                    }
                                },
                                y: {
                                    type: 'linear',
                                    display: true,
                                    position: 'left',
                                    ticks: { 
                                        color: '#666'
                                    },
                                    grid: { 
                                        color: 'rgba(0, 0, 0, 0.1)'
                                    }
                                },
                                y1: {
                                    type: 'linear',
                                    display: true,
                                    position: 'right',
                                    ticks: { 
                                        color: '#666'
                                    },
                                    grid: { drawOnChartArea: false }
                                }
                            }
                        }
                    });
                }

                // Gr√°fico de precipitaci√≥n
                const ctxPrec = document.getElementById('graficoPrecipitacion');
                if (ctxPrec) {
                    graficoPrecipitacion = new Chart(ctxPrec, {
                        type: 'bar',
                        data: {
                            labels: [],
                            datasets: [{
                                label: 'Precipitaci√≥n (mm)',
                                data: [],
                                backgroundColor: 'rgba(59, 130, 246, 0.6)',
                                borderColor: '#3b82f6',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    labels: { 
                                        color: '#333'
                                    }
                                }
                            },
                            scales: {
                                x: {
                                    ticks: { 
                                        color: '#666'
                                    },
                                    grid: { 
                                        color: 'rgba(0, 0, 0, 0.1)'
                                    }
                                },
                                y: {
                                    ticks: { 
                                        color: '#666'
                                    },
                                    grid: { 
                                        color: 'rgba(0, 0, 0, 0.1)'
                                    }
                                }
                            }
                        }
                    });
                }

                // Cargar datos iniciales para los gr√°ficos
                cargarDatosGraficos('24h');
                
                console.log('‚úÖ Gr√°ficos inicializados');
            } catch (error) {
                console.error('‚ùå Error inicializando gr√°ficos:', error);
            }
        }

        async function cargarDatosGraficos(periodo) {
            try {
                const gestor = window.climateManager || window.climaManager;
                
                if (gestor && gestor.forecastData) {
                    // Usar datos reales del pron√≥stico
                    const forecast = gestor.forecastData;
                    
                    if (forecast && forecast.hourly && periodo === '24h') {
                        // Datos horarios para las pr√≥ximas 24 horas
                        const labels = [];
                        const temperaturas = [];
                        const humedades = [];
                        const precipitacion = [];
                        
                        for (let i = 0; i < 24 && i < forecast.hourly.time.length; i++) {
                            const fecha = new Date(forecast.hourly.time[i]);
                            labels.push(fecha.toLocaleTimeString('es-GT', { hour: '2-digit' }));
                            temperaturas.push(forecast.hourly.temperature_2m[i]);
                            humedades.push(forecast.hourly.relative_humidity_2m[i]);
                            precipitacion.push(forecast.hourly.precipitation[i] || 0);
                        }
                        
                        actualizarGraficos(labels, temperaturas, humedades, precipitacion);
                    } else if (forecast && forecast.daily) {
                        // Datos diarios para 7 o 30 d√≠as
                        const dias = periodo === '7d' ? 7 : 30;
                        const labels = [];
                        const temperaturas = [];
                        const humedades = [];
                        const precipitacion = [];
                        
                        for (let i = 0; i < dias && i < forecast.daily.time.length; i++) {
                            const fecha = new Date(forecast.daily.time[i]);
                            labels.push(fecha.toLocaleDateString('es-GT', { month: 'short', day: 'numeric' }));
                            
                            // Promedio de temperatura
                            const tempMax = forecast.daily.temperature_2m_max[i];
                            const tempMin = forecast.daily.temperature_2m_min[i];
                            temperaturas.push((tempMax + tempMin) / 2);
                            
                            // Humedad (usar un valor estimado si no est√° disponible)
                            humedades.push(70); // Valor t√≠pico para Guatemala
                            
                            // Precipitaci√≥n
                            precipitacion.push(forecast.daily.precipitation_sum[i] || 0);
                        }
                        
                        actualizarGraficos(labels, temperaturas, humedades, precipitacion);
                    }
                } else {
                    // Datos simulados como fallback
                    cargarDatosSimulados(periodo);
                }
            } catch (error) {
                console.error('‚ùå Error cargando datos hist√≥ricos:', error);
                cargarDatosSimulados(periodo);
            }
        }

        function cargarDatosSimulados(periodo) {
            const labels = [];
            const temperaturas = [];
            const humedades = [];
            const precipitacion = [];
            
            const now = new Date();
            const puntos = periodo === '24h' ? 24 : periodo === '7d' ? 7 : 30;
            
            for (let i = puntos - 1; i >= 0; i--) {
                const fecha = new Date(now.getTime() - (i * (periodo === '24h' ? 3600000 : 86400000)));
                labels.push(fecha.toLocaleDateString('es-GT', { 
                    month: 'short', 
                    day: 'numeric',
                    ...(periodo === '24h' && { hour: '2-digit' })
                }));
                
                // Datos simulados t√≠picos de Guatemala
                temperaturas.push(20 + Math.random() * 12);
                humedades.push(60 + Math.random() * 25);
                precipitacion.push(Math.random() * 15);
            }
            
            actualizarGraficos(labels, temperaturas, humedades, precipitacion);
        }

        function actualizarGraficos(labels, temperaturas, humedades, precipitacion) {
            if (graficoTemperatura) {
                graficoTemperatura.data.labels = labels;
                graficoTemperatura.data.datasets[0].data = temperaturas;
                graficoTemperatura.data.datasets[1].data = humedades;
                graficoTemperatura.update();
            }
            
            if (graficoPrecipitacion) {
                graficoPrecipitacion.data.labels = labels;
                graficoPrecipitacion.data.datasets[0].data = precipitacion;
                graficoPrecipitacion.update();
            }
        }

        // ==========================================
        // FUNCIONES DE PRON√ìSTICO Y RECOMENDACIONES
        // ==========================================

        async function cargarPronostico() {
            try {
                const container = document.getElementById('pronosticoDias');
                container.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>';
                
                const gestor = window.climateManager || window.climaManager;
                
                if (gestor && gestor.forecastData && gestor.forecastData.daily) {
                    // Usar datos reales del pron√≥stico
                    const forecast = gestor.forecastData.daily;
                    const pronostico = [];
                    
                    for (let i = 0; i < 7 && i < forecast.time.length; i++) {
                        const fecha = new Date(forecast.time[i]);
                        pronostico.push({
                            fecha: fecha.toISOString(),
                            tempMax: Math.round(forecast.temperature_2m_max[i]),
                            tempMin: Math.round(forecast.temperature_2m_min[i]),
                            descripcion: i === 0 ? 'Hoy' : fecha.toLocaleDateString('es-GT', { weekday: 'short' }),
                            codigo: interpretarCodigoClima(forecast.weather_code[i]),
                            precipitacion: forecast.precipitation_sum[i] || 0
                        });
                    }
                    
                    mostrarPronostico(pronostico);
                } else {
                    // Generar pron√≥stico simulado
                    cargarPronosticoSimulado();
                }
                
                console.log('‚úÖ Pron√≥stico cargado');
            } catch (error) {
                console.error('‚ùå Error cargando pron√≥stico:', error);
                document.getElementById('pronosticoDias').innerHTML = '<div class="error-message">Error cargando pron√≥stico</div>';
            }
        }

        function cargarPronosticoSimulado() {
            const pronostico = [];
            const today = new Date();
            
            for (let i = 0; i < 7; i++) {
                const fecha = new Date(today.getTime() + (i * 86400000));
                const tempMax = Math.round(24 + Math.random() * 8);
                const tempMin = Math.round(tempMax - 5 - Math.random() * 3);
                
                pronostico.push({
                    fecha: fecha.toISOString(),
                    tempMax,
                    tempMin,
                    descripcion: i === 0 ? 'Hoy' : fecha.toLocaleDateString('es-GT', { weekday: 'short' }),
                    codigo: ['clear', 'partly-cloudy', 'cloudy', 'rain'][Math.floor(Math.random() * 4)],
                    precipitacion: Math.random() * 20
                });
            }
            
            mostrarPronostico(pronostico);
        }

        function mostrarPronostico(pronostico) {
            const container = document.getElementById('pronosticoDias');
            container.innerHTML = pronostico.map(dia => `
                <div class="dia-pronostico">
                    <div class="dia-info">
                        <div class="dia-fecha">${formatearFecha(dia.fecha)}</div>
                        <div class="dia-descripcion">${obtenerDescripcionClima(dia.codigo)}</div>
                        ${dia.precipitacion > 0 ? `<small>üíß ${dia.precipitacion.toFixed(1)}mm</small>` : ''}
                    </div>
                    <div class="dia-clima">
                        <div class="dia-icon">
                            <i class="fas ${obtenerIconoClima(dia.codigo)}"></i>
                        </div>
                        <div class="temperatura-rango">
                            <div class="temp-max">${dia.tempMax}¬∞</div>
                            <div class="temp-min">${dia.tempMin}¬∞</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function interpretarCodigoClima(codigo) {
            // Interpretar c√≥digos de OpenMeteo
            if (codigo === 0) return 'clear';
            if (codigo >= 1 && codigo <= 3) return 'partly-cloudy';
            if (codigo >= 45 && codigo <= 48) return 'fog';
            if (codigo >= 51 && codigo <= 67) return 'rain';
            if (codigo >= 71 && codigo <= 77) return 'snow';
            if (codigo >= 80 && codigo <= 82) return 'rain';
            if (codigo >= 95 && codigo <= 99) return 'storm';
            return 'cloudy';
        }

        async function generarRecomendacionesIA() {
            try {
                const container = document.getElementById('recomendacionesIA');
                container.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i></div>';
                
                const gestor = window.climateManager || window.climaManager;
                let recomendaciones = [];
                
                if (gestor && gestor.recommendations && gestor.recommendations.length > 0) {
                    // Usar recomendaciones del sistema
                    recomendaciones = gestor.recommendations;
                } else {
                    // Generar recomendaciones basadas en condiciones actuales
                    const temp = parseInt(document.getElementById('temperaturaActual').textContent) || 25;
                    const humedad = parseInt(document.getElementById('humedad').textContent) || 70;
                    
                    recomendaciones = generarRecomendacionesBasadas(temp, humedad);
                }
                
                container.innerHTML = recomendaciones.map(rec => `
                    <div class="recomendacion-item">
                        <div class="recomendacion-icon">
                            <i class="fas ${rec.icono}"></i>
                        </div>
                        <div>
                            <h4>${rec.titulo}</h4>
                            <p>${rec.descripcion}</p>
                            ${rec.prioridad === 'alta' ? '<span style="color: #ef4444; font-weight: 600;">Alta prioridad</span>' : ''}
                        </div>
                    </div>
                `).join('');
                
                console.log('‚úÖ Recomendaciones IA generadas');
            } catch (error) {
                console.error('‚ùå Error generando recomendaciones:', error);
                document.getElementById('recomendacionesIA').innerHTML = '<div class="error-message">Error generando recomendaciones</div>';
            }
        }

        function generarRecomendacionesBasadas(temp, humedad) {
            const recomendaciones = [];
            
            // Recomendaciones basadas en temperatura
            if (temp > 30) {
                recomendaciones.push({
                    icono: 'fa-tint',
                    titulo: 'Incrementar Riego',
                    descripcion: 'Temperatura alta detectada. Aumentar frecuencia de riego en horas tempranas.',
                    prioridad: 'alta'
                });
            } else if (temp < 15) {
                recomendaciones.push({
                    icono: 'fa-shield-alt',
                    titulo: 'Protecci√≥n contra Fr√≠o',
                    descripcion: 'Temperaturas bajas. Considerar medidas de protecci√≥n para plantas j√≥venes.',
                    prioridad: 'alta'
                });
            }
            
            // Recomendaciones basadas en humedad
            if (humedad > 80) {
                recomendaciones.push({
                    icono: 'fa-leaf',
                    titulo: 'Aplicar Fungicida Preventivo',
                    descripcion: 'Alta humedad detectada. Condiciones favorables para hongos.',
                    prioridad: 'media'
                });
            }
            
            // Recomendaciones generales para limones
            recomendaciones.push({
                icono: 'fa-scissors',
                titulo: 'Poda de Mantenimiento',
                descripcion: 'Condiciones estables. Buen momento para poda de formaci√≥n.',
                prioridad: 'baja'
            });
            
            if (temp >= 20 && temp <= 28 && humedad >= 60 && humedad <= 75) {
                recomendaciones.push({
                    icono: 'fa-apple-alt',
                    titulo: 'Condiciones √ìptimas',
                    descripcion: 'Excelentes condiciones para desarrollo del cultivo.',
                    prioridad: 'baja'
                });
            }
            
            return recomendaciones;
        }

        // ==========================================
        // FUNCIONES DE CONTROL
        // ==========================================

        function cambiarPeriodo(periodo) {
            // Actualizar botones activos
            document.querySelectorAll('.periodo-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-periodo="${periodo}"]`)?.classList.add('active');
            
            // Cargar nuevos datos
            cargarDatosGraficos(periodo);
        }

        function configurarActualizacionAutomatica() {
            const frecuencia = localStorage.getItem('frecuenciaActualizacion') || 15;
            
            if (intervaloActualizacion) {
                clearInterval(intervaloActualizacion);
            }
            
            intervaloActualizacion = setInterval(() => {
                if (navigator.onLine && sistemaInicializado) {
                    actualizarDatos();
                }
            }, frecuencia * 60 * 1000);
            
            console.log(`‚è∞ Actualizaci√≥n autom√°tica configurada cada ${frecuencia} minutos`);
        }

        async function actualizarDatos() {
            try {
                const btnActualizar = document.getElementById('btnActualizar');
                if (btnActualizar) {
                    btnActualizar.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Actualizando';
                }
                
                await Promise.all([
                    cargarDatosClimaticos(),
                    cargarPronostico(),
                    generarRecomendacionesIA()
                ]);
                
                mostrarNotificacion('Datos actualizados correctamente', 'success');
                
            } catch (error) {
                console.error('‚ùå Error actualizando datos:', error);
                mostrarNotificacion('Error actualizando datos', 'error');
            } finally {
                const btnActualizar = document.getElementById('btnActualizar');
                if (btnActualizar) {
                    btnActualizar.innerHTML = '<i class="fas fa-sync-alt"></i> Actualizar';
                }
            }
        }

        // ==========================================
        // FUNCIONES DE MODAL Y CONFIGURACI√ìN
        // ==========================================

        function abrirConfiguracion() {
            document.getElementById('modalConfiguracion')?.classList.add('show');
        }

        function cerrarConfiguracion() {
            document.getElementById('modalConfiguracion')?.classList.remove('show');
        }

        function guardarConfiguracion() {
            const config = {
                frecuenciaActualizacion: document.getElementById('frecuenciaActualizacion')?.value || '15',
                tempMinima: document.getElementById('tempMinima')?.value || '10',
                tempMaxima: document.getElementById('tempMaxima')?.value || '32',
                humedadMinima: document.getElementById('humedadMinima')?.value || '45',
                humedadMaxima: document.getElementById('humedadMaxima')?.value || '85',
                notificacionesPush: document.getElementById('notificacionesPush')?.checked || false,
                alertasEmail: document.getElementById('alertasEmail')?.checked || false
            };
            
            // Guardar configuraci√≥n
            Object.entries(config).forEach(([key, value]) => {
                localStorage.setItem(key, value);
            });
            
            // Reconfigurar actualizaci√≥n autom√°tica
            configurarActualizacionAutomatica();
            
            // Actualizar umbrales en el gestor clim√°tico si existe
            const gestor = window.climateManager || window.climaManager;
            if (gestor) {
                gestor.thresholds.temperature.critical.min = parseFloat(config.tempMinima);
                gestor.thresholds.temperature.critical.max = parseFloat(config.tempMaxima);
                gestor.thresholds.humidity.critical.min = parseFloat(config.humedadMinima);
                gestor.thresholds.humidity.critical.max = parseFloat(config.humedadMaxima);
            }
            
            mostrarNotificacion('Configuraci√≥n guardada', 'success');
            cerrarConfiguracion();
        }

        function resetearConfiguracion() {
            document.getElementById('frecuenciaActualizacion').value = '15';
            document.getElementById('tempMinima').value = '10';
            document.getElementById('tempMaxima').value = '32';
            document.getElementById('humedadMinima').value = '45';
            document.getElementById('humedadMaxima').value = '85';
            document.getElementById('notificacionesPush').checked = true;
            document.getElementById('alertasEmail').checked = true;
        }

        // ==========================================
        // FUNCIONES AUXILIARES
        // ==========================================

        function exportarDatos() {
            const gestor = window.climateManager || window.climaManager;
            if (gestor && gestor.exportarDatos) {
                gestor.exportarDatos();
            } else {
                // Exportar datos manualmente
                const datos = {
                    fecha: new Date().toISOString(),
                    ubicacion: 'Finca La Herradura, Guatemala',
                    coordenadas: { lat: 14.77073, lng: -90.25398 },
                    temperaturaActual: document.getElementById('temperaturaActual').textContent,
                    humedad: document.getElementById('humedad').textContent,
                    viento: document.getElementById('viento').textContent,
                    presion: document.getElementById('presion').textContent,
                    precipitacion: document.getElementById('precipitacion').textContent
                };
                
                const blob = new Blob([JSON.stringify(datos, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `clima-finca-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                mostrarNotificacion('Datos exportados correctamente', 'success');
            }
        }

        function mostrarHistoricoLluvia() {
            const gestor = window.climateManager || window.climaManager;
            if (gestor && gestor.mostrarHistoricoDetallado) {
                gestor.mostrarHistoricoDetallado('precipitacion');
            } else {
                mostrarNotificacion('Hist√≥rico detallado en desarrollo', 'info');
            }
        }

        function actualizarEstadoSensores() {
            // Actualizar con datos reales si est√°n disponibles
            const gestor = window.climateManager || window.climaManager;
            
            if (gestor && gestor.currentWeather) {
                const datos = gestor.currentWeather;
                
                // Actualizar valores de sensores con datos reales
                document.getElementById('sensorTemperatura').textContent = `${Math.round(datos.temperature_2m || 25)}¬∞C`;
                document.getElementById('sensorHumedad').textContent = `${Math.round(datos.relative_humidity_2m || 68)}%`;
                document.getElementById('sensorViento').textContent = `${Math.round(datos.wind_speed_10m || 12)} km/h`;
                
                // Todos online si hay datos
                document.querySelectorAll('.sensor-estado').forEach(el => {
                    el.className = 'sensor-estado online';
                    el.textContent = 'Online';
                });
            } else {
                // Simular estado de sensores
                const sensores = [
                    { id: 'sensorTemperatura', valor: `${(22 + Math.random() * 8).toFixed(1)}¬∞C`, estado: 'online' },
                    { id: 'sensorHumedad', valor: `${Math.round(65 + Math.random() * 20)}%`, estado: 'online' },
                    { id: 'sensorSuelo', valor: `${Math.round(30 + Math.random() * 40)}%`, estado: Math.random() > 0.3 ? 'online' : 'offline' },
                    { id: 'sensorViento', valor: `${Math.round(5 + Math.random() * 15)} km/h`, estado: 'online' }
                ];
                
                sensores.forEach(sensor => {
                    const elemento = document.getElementById(sensor.id);
                    if (elemento) {
                        elemento.textContent = sensor.valor;
                    }
                    
                    const estadoElement = elemento?.parentElement.querySelector('.sensor-estado');
                    if (estadoElement) {
                        estadoElement.className = `sensor-estado ${sensor.estado}`;
                        estadoElement.textContent = sensor.estado === 'online' ? 'Online' : 'Offline';
                    }
                });
            }
        }

        function formatearFecha(fecha) {
            return new Date(fecha).toLocaleDateString('es-GT', {
                weekday: 'short',
                day: 'numeric',
                month: 'short'
            });
        }

        function mostrarCargando(mostrar) {
            // Implementar indicador de carga si es necesario
            console.log(mostrar ? '‚è≥ Cargando...' : '‚úÖ Carga completada');
        }

        function mostrarError(mensaje) {
            mostrarNotificacion(mensaje, 'error');
        }

        function mostrarNotificacion(mensaje, tipo = 'info') {
            console.log(`${tipo.toUpperCase()}: ${mensaje}`);
            
            // Si hay un sistema de notificaciones disponible, usarlo
            if (window.notificationManager) {
                switch(tipo) {
                    case 'success':
                        window.notificationManager.success(mensaje);
                        break;
                    case 'error':
                        window.notificationManager.error(mensaje);
                        break;
                    case 'warning':
                        window.notificationManager.warning(mensaje);
                        break;
                    default:
                        window.notificationManager.info(mensaje);
                }
            }
        }

        // ==========================================
        // MANEJO DE ERRORES GLOBALES
        // ==========================================

        window.addEventListener('error', (event) => {
            console.error('‚ùå Error global:', event.error);
            // No mostrar error al usuario para evitar spam
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('‚ùå Promesa rechazada no manejada:', event.reason);
            // No mostrar error al usuario para evitar spam
        });
    </script>
</body>
</html>


